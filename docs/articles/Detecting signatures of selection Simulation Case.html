<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detecting signatures of selection with known environmnetal factors: a case of EnvGenomeScan • DeepGenomeScan</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Detecting signatures of selection with known environmnetal factors: a case of EnvGenomeScan">
<meta property="og:description" content="DeepGenomeScan">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-158177382-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-158177382-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">DeepGenomeScan</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/home.html">Home</a>
</li>
<li>
  <a href="../articles/index.html">Tutorials</a>
</li>
<li>
  <a href="../reference/index.html">Manual</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/xinghuq/DeepGenomeScan/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Detecting signatures of selection with known environmnetal factors: a case of EnvGenomeScan</h1>
                        <h4 class="author">Xinghu Qin</h4>
            
            <h4 class="date">7/11/2020</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/xinghuq/DeepGenomeScan/blob/master/vignettes/Detecting%20signatures%20of%20selection%20Simulation%20Case.Rmd"><code>vignettes/Detecting signatures of selection Simulation Case.Rmd</code></a></small>
      <div class="hidden name"><code>Detecting signatures of selection Simulation Case.Rmd</code></div>

    </div>

    
    
<div id="deepgenomescan-for-detection-of-natural-selection-with-known-environmental-factors" class="section level2">
<h2 class="hasAnchor">
<a href="#deepgenomescan-for-detection-of-natural-selection-with-known-environmental-factors" class="anchor"></a>DeepGenomeScan for detection of natural selection with known environmental factors</h2>
<p>In this vignette, we use the simulated data to show how to detect loci under the selection of known environmental factors using DeepGenomeScan. In this case, we use “EnvGenomeScan” mode in DeeGenomeScan, which does deep learning based genome scan to identify the loci explaining the environmental factors.</p>
<p>In what follows, we provide the step-by-step implementation of EnvGenomeScan.</p>
<p>Some examples run very long time, so we will not show all the results, users can implement these methods on your own machine.</p>
</div>
<div id="load-the-required-packages-and-dependencies" class="section level2">
<h2 class="hasAnchor">
<a href="#load-the-required-packages-and-dependencies" class="anchor"></a>Load the required packages and dependencies</h2>
<div class="sourceCode"><pre class="downlit">
<span class="co">## Note: Install caret(plus) from xinghuq/CaretPlus/pkg/care</span>
<span class="co">#remotes::install_github("xinghuq/CaretPlus/pkg/caret")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/topepo/caret/">"caret"</a></span><span class="op">)</span>
<span class="co"># Loading required package: lattice</span>
<span class="co"># Loading required package: ggplot2</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/zachmayer/caretEnsemble">"caretEnsemble"</a></span><span class="op">)</span>
<span class="co"># </span>
<span class="co"># Attaching package: 'caretEnsemble'</span>
<span class="co"># The following object is masked from 'package:ggplot2':</span>
<span class="co"># </span>
<span class="co">#     autoplot</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st">"NeuralNetTools"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/bips-hb/neuralnet">"neuralnet"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/xinghuq/DeepGenomeScan">"DeepGenomeScan"</a></span><span class="op">)</span>
<span class="co"># </span>
<span class="co"># Attaching package: 'DeepGenomeScan'</span>
<span class="co"># The following object is masked from 'package:caret':</span>
<span class="co"># </span>
<span class="co">#     varImp</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://ggplot2.tidyverse.org">"ggplot2"</a></span><span class="op">)</span></pre></div>
<p>Get the example data.</p>
<div class="sourceCode"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>warn<span class="op">=</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>
<span class="va">normalize</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">'extdata'</span>,package<span class="op">=</span><span class="st">'DeepGenomeScan'</span><span class="op">)</span>
<span class="va">infile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">f</span>, <span class="st">"sim1.csv"</span><span class="op">)</span>
<span class="va">sim_example</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="va">infile</span><span class="op">)</span>
<span class="va">genotype</span><span class="op">=</span><span class="va">sim_example</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">14</span><span class="op">)</span><span class="op">]</span>
<span class="va">env</span><span class="op">=</span><span class="va">sim_example</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">11</span><span class="op">]</span>
<span class="va">para</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span></pre></div>
</div>
<div id="define-the-function-to-calculate-the-p-value-and-q-value" class="section level2">
<h2 class="hasAnchor">
<a href="#define-the-function-to-calculate-the-p-value-and-q-value" class="anchor"></a>Define the function to calculate the p-value and q-value</h2>
<div class="sourceCode"><pre class="downlit">
<span class="va">DLqvalues</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">DL_data</span>,<span class="va">K</span>,<span class="va">estimation</span><span class="op">=</span><span class="st">"auto"</span><span class="op">)</span>
<span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">robust</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="http://github.com/jdstorey/qvalue">qvalue</a></span><span class="op">)</span>
  <span class="va">loadings</span><span class="op">&lt;-</span><span class="va">DL_data</span><span class="co"># [,1:as.numeric(K)]</span>
  <span class="va">resscale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">loadings</span>, <span class="fl">2</span>, <span class="va">scale</span><span class="op">)</span>
  <span class="va">resmaha</span> <span class="op">&lt;-</span> <span class="fu">robust</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/robust/man/covRob.html">covRob</a></span><span class="op">(</span><span class="va">resscale</span>, distance <span class="op">=</span> <span class="cn">TRUE</span>, na.action<span class="op">=</span> <span class="va">na.omit</span>, estim<span class="op">=</span><span class="va">estimation</span><span class="op">)</span><span class="op">$</span><span class="va">dist</span>
  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">resmaha</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">qchisq</a></span><span class="op">(</span><span class="fl">0.5</span>,df<span class="op">=</span><span class="va">K</span><span class="op">)</span>
  <span class="va">reschi2test</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">pchisq</a></span><span class="op">(</span><span class="va">resmaha</span><span class="op">/</span><span class="va">lambda</span>,<span class="va">K</span>,lower.tail<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
  <span class="va">qval</span> <span class="op">&lt;-</span> <span class="fu">qvalue</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/qvalue/man/qvalue.html">qvalue</a></span><span class="op">(</span><span class="va">reschi2test</span><span class="op">)</span>
  <span class="va">q.values_DL</span><span class="op">&lt;-</span><span class="va">qval</span><span class="op">$</span><span class="va">qvalues</span>
  <span class="va">padj</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">reschi2test</span>,method<span class="op">=</span><span class="st">"bonferroni"</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>p.values<span class="op">=</span><span class="va">reschi2test</span>, q.values<span class="op">=</span><span class="va">q.values_DL</span>,padj<span class="op">=</span><span class="va">padj</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<div id="using-ready-to-use-model-in-genome-scan" class="section level3">
<h3 class="hasAnchor">
<a href="#using-ready-to-use-model-in-genome-scan" class="anchor"></a>Using ready-to-use model in genome scan</h3>
<p>We will try different models to do genome scan. We will only show the step-by-step illustration, in which the tutorial will only search 10 hyperparameters here. Please do not take it for granted that these represent the overall model performance. Please do a trial to explore the architecture of neural network that suits the data. Please increase the hyperparameter search space.</p>
<div id="mlpgds-example-" class="section level4">
<h4 class="hasAnchor">
<a href="#mlpgds-example-" class="anchor"></a>mlpgds example.</h4>
<div class="sourceCode"><pre class="downlit">
<span class="co">########## neuralnet mlp random search############################################</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">econtrol</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span><span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"adaptive_cv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,
 adaptive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.05</span>,method <span class="op">=</span> <span class="st">"gls"</span>, complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  search <span class="op">=</span> <span class="st">"random"</span>
 <span class="op">)</span>
<span class="co">###using FCNN4R</span>
<span class="co">#"sym_sigmoid" (and "tanh"), </span>
<span class="co">#library(FCNN4R) #### should install from source</span>
<span class="co">##mlpFCNN4Rsgd</span>
<span class="va">mlpFCNN4Rsgd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Multilayer Perceptron Network by Stochastic Gradient Descent"</span>,
                     library <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"FCNN4R"</span>, <span class="st">"plyr"</span><span class="op">)</span>,
                     loop <span class="op">=</span> <span class="cn">NULL</span>,
                     type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Regression'</span>, <span class="st">"Classification"</span><span class="op">)</span>,
                     parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'units1'</span>,<span class="st">'units2'</span>, <span class="st">'l2reg'</span>, <span class="st">'lambda'</span>, <span class="st">"learn_rate"</span>, 
                                                           <span class="st">"momentum"</span>, <span class="st">"gamma"</span>, <span class="st">"minibatchsz"</span>, <span class="st">"repeats"</span>,<span class="st">"activation1"</span>,<span class="st">"activation2"</span><span class="op">)</span>,
                                             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">'numeric'</span>, <span class="fl">9</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"character"</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
                                             label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Number of hidden Units1'</span>,<span class="st">'Number of hidden Units2'</span>, <span class="st">'L2 Regularization'</span>, 
                                                       <span class="st">'RMSE Gradient Scaling'</span>, <span class="st">"Learning Rate"</span>, 
                                                       <span class="st">"Momentum"</span>, <span class="st">"Learning Rate Decay"</span>, <span class="st">"Batch Size"</span>,
                                                       <span class="st">"#Models"</span>,<span class="st">'Activation function at hidden layer'</span>,<span class="st">'Activation function at output layer'</span><span class="op">)</span><span class="op">)</span>,
                     grid <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">len</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">search</span> <span class="op">=</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                       <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
                       <span class="va">afuncs</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"linear"</span>, <span class="st">"sigmoid"</span>, <span class="st">"tanh"</span><span class="op">)</span>
                       <span class="kw">if</span><span class="op">(</span><span class="va">search</span> <span class="op">==</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                         <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>units1 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, 
                                            units2 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, 
                                            l2reg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span> <span class="op">^</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">4</span>, length <span class="op">=</span> <span class="va">len</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, 
                                            lambda <span class="op">=</span> <span class="fl">0</span>,
                                            learn_rate <span class="op">=</span> <span class="fl">2e-6</span>, 
                                            momentum <span class="op">=</span> <span class="fl">0.9</span>, 
                                            gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.9</span>, length <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                            minibatchsz <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>,
                                            repeats <span class="op">=</span> <span class="fl">1</span>,
                                            activation1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"linear"</span>, <span class="st">"sigmoid"</span>, <span class="st">"tanh"</span><span class="op">)</span>,
                                            activation2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"linear"</span>, <span class="st">"sigmoid"</span>, <span class="st">"tanh"</span><span class="op">)</span><span class="op">)</span>
                       <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                         <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>units1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">20</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                           units2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">20</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                           l2reg <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">)</span>,
                                           lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, max <span class="op">=</span> <span class="fl">.4</span><span class="op">)</span>,
                                           learn_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span>,
                                           momentum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, min <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>,
                                           gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span>,
                                           minibatchsz <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, min <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span><span class="op">)</span>,
                                           repeats <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                           activation1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                                           activation2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
                       <span class="op">}</span>
                       <span class="va">out</span>
                     <span class="op">}</span>,
                     fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">wts</span>, <span class="va">param</span>, <span class="va">lev</span>, <span class="va">last</span>, <span class="va">classProbs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                       <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">is.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
                       <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/is.factor.html">is.factor</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                         <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/dummyVars.html">class2ind</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
                         <span class="va">net</span> <span class="op">&lt;-</span> <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_net.html">mlp_net</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="va">param</span><span class="op">$</span><span class="va">units1</span>, <span class="va">param</span><span class="op">$</span><span class="va">units2</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
                         <span class="va">net</span> <span class="op">&lt;-</span> <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_set_activation.html">mlp_set_activation</a></span><span class="op">(</span><span class="va">net</span>, layer <span class="op">=</span> <span class="st">"h"</span>, activation <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">activation1</span><span class="op">)</span>
                         <span class="va">net</span> <span class="op">&lt;-</span> <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_set_activation.html">mlp_set_activation</a></span><span class="op">(</span><span class="va">net</span>, layer <span class="op">=</span> <span class="st">"o"</span>, activation <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">activation2</span><span class="op">)</span>
                         
                       <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                         <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
                         <span class="va">net</span> <span class="op">&lt;-</span> <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_net.html">mlp_net</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="va">param</span><span class="op">$</span><span class="va">units1</span>,<span class="va">param</span><span class="op">$</span><span class="va">units2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
                         <span class="va">net</span> <span class="op">&lt;-</span> <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_set_activation.html">mlp_set_activation</a></span><span class="op">(</span><span class="va">net</span>, layer <span class="op">=</span> <span class="st">"h"</span>, activation <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">activation1</span><span class="op">)</span>
                         <span class="va">net</span> <span class="op">&lt;-</span> <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_set_activation.html">mlp_set_activation</a></span><span class="op">(</span><span class="va">net</span>, layer <span class="op">=</span> <span class="st">"o"</span>, activation <span class="op">=</span><span class="va">param</span><span class="op">$</span><span class="va">activation2</span><span class="op">)</span>
                       <span class="op">}</span>
                       <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
                       <span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>net <span class="op">=</span> <span class="va">net</span>, 
                                    input <span class="op">=</span> <span class="va">x</span>, output <span class="op">=</span> <span class="va">y</span>, 
                                    learn_rate <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">learn_rate</span>,
                                    minibatchsz <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">minibatchsz</span>,
                                    l2reg <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">l2reg</span>,
                                    lambda <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">lambda</span>,
                                    gamma <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">gamma</span>,
                                    momentum <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">momentum</span><span class="op">)</span>
                       <span class="va">the_dots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> 
                       <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">the_dots</span><span class="op">)</span> <span class="op">==</span> <span class="st">"tol_level"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                         <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> 
                           <span class="va">args</span><span class="op">$</span><span class="va">tol_level</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.sd.html">sd</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="kw">else</span>
                             <span class="va">args</span><span class="op">$</span><span class="va">tol_level</span> <span class="op">&lt;-</span> <span class="fl">.001</span>
                       <span class="op">}</span> 
                       
                       <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">the_dots</span><span class="op">)</span> <span class="op">==</span> <span class="st">"max_epochs"</span><span class="op">)</span><span class="op">)</span> 
                         <span class="va">args</span><span class="op">$</span><span class="va">max_epochs</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
                       <span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">args</span>, <span class="va">the_dots</span><span class="op">)</span>
                       <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">repeats</span><span class="op">)</span><span class="op">)</span>
                       <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">param</span><span class="op">$</span><span class="va">repeats</span><span class="op">)</span> <span class="op">{</span>
                         <span class="va">args</span><span class="op">$</span><span class="va">net</span> <span class="op">&lt;-</span> <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_rnd_weights.html">mlp_rnd_weights</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">net</span><span class="op">)</span>
                         <span class="va">out</span><span class="op">$</span><span class="va">models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="fu">FCNN4R</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_teach_sgd.html">mlp_teach_sgd</a></span>, <span class="va">args</span><span class="op">)</span>
                       <span class="op">}</span>
                       <span class="va">out</span>
                     <span class="op">}</span>,
                     predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                       <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">is.matrix</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span><span class="op">)</span> <span class="va">newdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span>
                       <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">models</span>, 
                                     <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">newdata</span><span class="op">)</span>
                                       <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_eval.html">mlp_eval</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">net</span>, input <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span>,
                                     newdata <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span>
                       <span class="kw">if</span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">problemType</span> <span class="op">==</span> <span class="st">"Classification"</span><span class="op">)</span> <span class="op">{</span>
                         <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">out</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                         <span class="va">out</span><span class="op">$</span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">models</span><span class="op">)</span><span class="op">)</span>
                         <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/ddply.html">ddply</a></span><span class="op">(</span><span class="va">out</span>, <span class="fu">plyr</span><span class="fu">::</span><span class="fu">`.`</span><span class="op">(</span><span class="va">sample</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>
                         <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">modelFit</span><span class="op">$</span><span class="va">obsLevels</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">out</span>, <span class="fl">1</span>, <span class="va">which.max</span><span class="op">)</span><span class="op">]</span>
                       <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                         <span class="va">out</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> 
                           <span class="va">out</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>  <span class="kw">else</span> <span class="op">{</span>
                             <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"cbind"</span>, <span class="va">out</span><span class="op">)</span>
                             <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">out</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span>
                           <span class="op">}</span>
                       <span class="op">}</span>
                       <span class="va">out</span>
                     <span class="op">}</span>,
                     prob <span class="op">=</span>  <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                       <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">is.matrix</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span><span class="op">)</span> <span class="va">newdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span>
                       <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">models</span>, 
                                     <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">newdata</span><span class="op">)</span>
                                       <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_eval.html">mlp_eval</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">net</span>, input <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span>,
                                     newdata <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span>
                       <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">out</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                       <span class="va">out</span><span class="op">$</span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">models</span><span class="op">)</span><span class="op">)</span>
                       <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/ddply.html">ddply</a></span><span class="op">(</span><span class="va">out</span>, <span class="fu">plyr</span><span class="fu">::</span><span class="fu">`.`</span><span class="op">(</span><span class="va">sample</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>
                       <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">out</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
                       <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">modelFit</span><span class="op">$</span><span class="va">obsLevels</span>
                       <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">out</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                     <span class="op">}</span>,
                     varImp <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                       <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">models</span>, <span class="fu">caret</span><span class="fu">:::</span><span class="va">GarsonWeights_FCNN4R</span>, xnames <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">xNames</span><span class="op">)</span>
                       <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">imps</span><span class="op">)</span>
                       <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">imps</span>, <span class="fl">1</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                       <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">imps</span><span class="op">)</span>, imp <span class="op">=</span> <span class="va">imps</span><span class="op">)</span>
                       <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/ddply.html">ddply</a></span><span class="op">(</span><span class="va">imps</span>, <span class="fu">plyr</span><span class="fu">::</span><span class="fu">`.`</span><span class="op">(</span><span class="va">var</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>Overall <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">imp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
                       <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">imps</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">imps</span><span class="op">$</span><span class="va">var</span><span class="op">)</span>
                       <span class="va">imps</span><span class="op">$</span><span class="va">var</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
                       <span class="va">imps</span><span class="op">[</span><span class="va">object</span><span class="op">$</span><span class="va">xNames</span>,,drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
                     <span class="op">}</span>,
                     tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Neural Network"</span>, <span class="st">"L2 Regularization"</span><span class="op">)</span>,
                     sort <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">units1</span>, <span class="va">x</span><span class="op">$</span><span class="va">units2</span>,<span class="op">-</span><span class="va">x</span><span class="op">$</span><span class="va">l2reg</span>, <span class="op">-</span><span class="va">x</span><span class="op">$</span><span class="va">gamma</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span>

<span class="va">varImpFCNN4</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">models</span>, <span class="fu">caret</span><span class="fu">:::</span><span class="va">GarsonWeights_FCNN4R</span>, xnames <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">xNames</span><span class="op">)</span>
                    <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">imps</span><span class="op">)</span>
                    <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">imps</span>, <span class="fl">1</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                    <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">imps</span><span class="op">)</span>, imp <span class="op">=</span> <span class="va">imps</span><span class="op">)</span>
                    <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/ddply.html">ddply</a></span><span class="op">(</span><span class="va">imps</span>, <span class="fu">plyr</span><span class="fu">::</span><span class="fu">`.`</span><span class="op">(</span><span class="va">var</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>Overall <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">imp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">imps</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">imps</span><span class="op">$</span><span class="va">var</span><span class="op">)</span>
                    <span class="va">imps</span><span class="op">$</span><span class="va">var</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
                    <span class="va">imps</span><span class="op">[</span><span class="va">object</span><span class="op">$</span><span class="va">xNames</span>,,drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
<span class="op">}</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">para</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">" train neuralnet"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
    <span class="co">#env=normalize(simdata[[j]][,2:11])</span>
    <span class="va">genotype_norm</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">sim_example</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span><span class="op">)</span>
    <span class="va">simf</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">[</span>,<span class="fl">15</span><span class="op">:</span><span class="fl">1014</span><span class="op">]</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">"~"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">model_FCNN4Rsgd_envi_mlp</span><span class="op">=</span><span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="va">simf</span>, data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>,
                                          method<span class="op">=</span><span class="st">"mlpSGD"</span>,
                                          metric <span class="op">=</span> <span class="st">"MAE"</span>,<span class="co">## "Accuracy", "RMSE"</span>
                                          <span class="co">#preProcess=c("scale"),</span>
                                          tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### search 10 combinations of parameters</span>
                                          <span class="co"># verbose=1 is reporting the progress,o is sclience</span>
                                          trControl <span class="op">=</span> <span class="va">econtrol</span><span class="op">)</span>
    

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"tuning FCNN4Rsgd finished"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">model_FCNN4Rsgd_envi_mlp</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpFCNN4Rsgd_env_trained_model.RData"</span><span class="op">)</span><span class="op">)</span>
    <span class="co">### olden importance</span>
   <span class="co"># FCNN4Rsgd_simimp1=NeuralNetTools::olden(model_FCNN4Rsgd_envi_mlp$finalModel, bar_plot=FALSE)</span>
    <span class="va">FCNN4Rsgd_simimp2</span><span class="op">=</span><span class="fu">varImpFCNN4</span><span class="op">(</span><span class="va">model_FCNN4Rsgd_envi_mlp</span><span class="op">$</span><span class="va">finalModel</span><span class="op">)</span>
    <span class="co">#write.csv(FCNN4Rsgd_simimp1$importance,file = paste0("sim_1_",para[i],"_mlpFCNN4Rsgd_importance_env.csv"))</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">FCNN4Rsgd_simimp2</span><span class="op">$</span><span class="va">Overall</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpFCNN4Rsgd_importance2_env.csv"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">model_FCNN4Rsgd_envi_mlp</span><span class="op">$</span><span class="va">results</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpFCNN4Rsgd_env_tuning.csv"</span><span class="op">)</span> <span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"importance output finished"</span><span class="op">)</span><span class="op">)</span>
    <span class="co">#registerDoSEQ()</span>
    <span class="co">#stopCluster(cl)</span>
  <span class="op">}</span>


<span class="co">##save.image(file = "FCNN4Rsgd_mlp_Scan_sims_final_after_trained_data.RData")</span></pre></div>
</div>
</div>
</div>
<div id="reading-the-importance-values-and-calculate-p-valuesq-values" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-the-importance-values-and-calculate-p-valuesq-values" class="anchor"></a>Reading the importance values and calculate p-values/q-values</h2>
<div class="sourceCode"><pre class="downlit">
<span class="va">impdir</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.dirs</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"/home/xinghu2019/Simulations/DeepGenomeScan_v0.1/vignettes"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">impfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">impdir</span>, pattern<span class="op">=</span><span class="st">"*_mlpFCNN4Rsgd_importance2_env.csv"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## 100 simulations and 10 envir variables, </span>

<span class="va">impSim_all</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">impfile</span>, <span class="va">read.csv</span><span class="op">)</span> <span class="co">### including all 100 simulations and 10 variables each simuilations, </span>


<span class="co">### combine every factor (envir) into one file, meaning combining each single simulation into one file</span>


<span class="va">imp_sim_list</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">impSim_all</span><span class="op">)</span><span class="op">)</span>
<span class="co">### remove the loci ID</span>
<span class="va">Xrep</span><span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">imp_sim_list</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>
<span class="va">DLdata</span> <span class="op">&lt;-</span> <span class="va">imp_sim_list</span><span class="op">[</span>,<span class="va">Xrep</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">DLdata</span><span class="op">)</span> <span class="co">### now 1:10 is the first simulation</span>
<span class="co">### spilt into 100 simulations each by 10</span>
<span class="co">#save.image(file = "DL_mlp_FNCC4_Scan_sim1.RData")</span>

<span class="co">###calculate q-values</span>

<span class="va">DLdata1</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">DLdata</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span>
<span class="va">Simqvalue</span><span class="op">=</span><span class="fu"><a href="../reference/DLqvalues.html">DLqvalues</a></span><span class="op">(</span><span class="va">DLdata1</span>,<span class="fl">10</span><span class="op">)</span>
<span class="co"># Loading required package: robust</span>
<span class="co"># Loading required package: fit.models</span>
<span class="co"># Loading required package: qvalue</span>

<span class="va">Loci</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"Neutral"</span>, <span class="fl">1000</span><span class="op">)</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">11</span>,<span class="fl">21</span>,<span class="fl">31</span>,<span class="fl">41</span>,<span class="fl">51</span>,<span class="fl">61</span>,<span class="fl">71</span>,<span class="fl">81</span>,<span class="fl">91</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL1"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">101</span>,<span class="fl">111</span>,<span class="fl">121</span>,<span class="fl">131</span>,<span class="fl">141</span>,<span class="fl">151</span>,<span class="fl">161</span>,<span class="fl">171</span>,<span class="fl">181</span>,<span class="fl">191</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL2"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">201</span>,<span class="fl">211</span>,<span class="fl">221</span>,<span class="fl">231</span>,<span class="fl">241</span>,<span class="fl">251</span>,<span class="fl">261</span>,<span class="fl">271</span>,<span class="fl">281</span>,<span class="fl">291</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL3"</span>
<span class="va">p.values</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span>, DL_mlp<span class="op">=</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/H2OFrame.html">log10</a></span><span class="op">(</span><span class="va">Simqvalue</span><span class="op">$</span><span class="va">p.values</span><span class="op">)</span>,Loci<span class="op">=</span><span class="va">Loci</span><span class="op">)</span>
<span class="va">Selected_Loci</span><span class="op">&lt;-</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span>
<span class="co">#  [1] "x"   "x.1" "x.2" "x.3" "x.4" "x.5" "x.6" "x.7" "x.8" "x.9"</span></pre></div>
</div>
<div id="plotting-manhattan-plot" class="section level2">
<h2 class="hasAnchor">
<a href="#plotting-manhattan-plot" class="anchor"></a>Plotting Manhattan plot</h2>
<div class="sourceCode"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"DL_mlp_FNCC4_Scan_sim1_manhattan.RData"</span><span class="op">)</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span>, y<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"gray83"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, colour <span class="op">=</span> <span class="va">Selected_Loci</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"SNP (with maf &gt; 0.05)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"DL_MLP -log10(p-values)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">120</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">p1</span></pre></div>
<div class="figure" style="text-align: center">
<img src="Detecting%20signatures%20of%20selection%20Simulation%20Case_files/figure-html/figure%201-1.png" alt="&amp;nbsp;" width="768"><p class="caption">
 
</p>
</div>
</div>
<div id="dl_h20-example" class="section level2">
<h2 class="hasAnchor">
<a href="#dl_h20-example" class="anchor"></a>DL_h20 example</h2>
<p>This example use H2o library to construct the neural network.</p>
<div id="compiling-the-dl_h2o-model-with-2-hidden-layers" class="section level4">
<h4 class="hasAnchor">
<a href="#compiling-the-dl_h2o-model-with-2-hidden-layers" class="anchor"></a>Compiling the DL_h2o model with 2 hidden layers</h4>
<div class="sourceCode"><pre class="downlit">
<span class="va">DL_h2o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"DL_h2o"</span>,
                  library <span class="op">=</span> <span class="st">"h2o"</span>,
                  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Regression"</span>, <span class="st">"Classification"</span><span class="op">)</span>,
                  parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'units1'</span>,<span class="st">'units2'</span>, <span class="st">'l2reg'</span>, <span class="st">"rho"</span>, <span class="st">"activation"</span><span class="op">)</span>,
                                          class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">'numeric'</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"character"</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
                                          label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Number of hidden Units1'</span>,<span class="st">'Number of hidden Units2'</span>, <span class="st">'L2 Regularization'</span>, 
                                                     <span class="st">"Adaptive learning rate time decay factor"</span>, 
                                                    <span class="st">'Activation function at hidden layer'</span><span class="op">)</span><span class="op">)</span>,
                  grid <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">len</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">search</span> <span class="op">=</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                    
                    <span class="va">afuncs</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Tanh"</span>, <span class="st">"TanhWithDropout"</span>, <span class="st">"Rectifier"</span>, <span class="st">"RectifierWithDropout"</span><span class="op">)</span>
                    
                    <span class="kw">if</span><span class="op">(</span><span class="va">search</span> <span class="op">==</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>units1 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, <span class="co">### two hidden layers</span>
                                         units2 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, 
                                          l2reg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span> <span class="op">^</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">4</span>, length <span class="op">=</span> <span class="va">len</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, 
                                          rho <span class="op">=</span> <span class="fl">2e-3</span>, 
                                          activation<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Tanh"</span>, <span class="st">"TanhWithDropout"</span>, <span class="st">"Rectifier"</span>, <span class="st">"RectifierWithDropout"</span><span class="op">)</span><span class="op">)</span>
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>units1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                        units2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                        l2reg <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">)</span>,
                                        rho <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span>,
                                        activation<span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
                    <span class="op">}</span>
                    <span class="va">out</span>
                  <span class="op">}</span>,
                  loop <span class="op">=</span> <span class="cn">NULL</span>,
                  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">wts</span>, <span class="va">param</span>, <span class="va">lev</span>, <span class="va">last</span>, <span class="va">classProbs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                    
                    <span class="va">dat</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">is.data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">x</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="kw">else</span> <span class="va">x</span>
                    <span class="va">dat</span><span class="op">$</span><span class="va">.outcome</span> <span class="op">&lt;-</span> <span class="va">y</span>
                    <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>
                    <span class="va">frame_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"tmp_DL_h2o_dat_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fl">100000</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
                    <span class="va">tmp_train_dat</span> <span class="op">=</span> <span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.h2o.html">as.h2o</a></span><span class="op">(</span><span class="va">dat</span>, destination_frame <span class="op">=</span> <span class="va">frame_name</span><span class="op">)</span>
                    
                    <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">units1</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">units2</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">nodes</span>, <span class="va">param</span><span class="op">$</span><span class="va">units2</span><span class="op">)</span>
                    <span class="op">}</span>
                    <span class="va">acts</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation</span><span class="op">)</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.deeplearning.html">h2o.deeplearning</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y <span class="op">=</span> <span class="st">".outcome"</span>,
                                        training_frame <span class="op">=</span> <span class="va">tmp_train_dat</span>,
                                        standardize <span class="op">=</span> <span class="cn">F</span>,
                                       <span class="co"># model_id = "deep_model",        </span>
                                        activation <span class="op">=</span><span class="va">acts</span>, 
                                        hidden<span class="op">=</span><span class="va">nodes</span>,
                                        epochs <span class="op">=</span> <span class="fl">100</span>,       
                                        seed <span class="op">=</span> <span class="fl">123</span>,
                                        variable_importances <span class="op">=</span> <span class="cn">T</span>,
                                        l2<span class="op">=</span><span class="va">param</span><span class="op">$</span><span class="va">L2reg</span>,
                                        stopping_metric<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/is.factor.html">is.factor</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, <span class="st">"misclassification"</span>, <span class="st">"RMSE"</span><span class="op">)</span>,
                                        rho<span class="op">=</span><span class="va">param</span><span class="op">$</span><span class="va">rho</span>,<span class="va">...</span><span class="op">)</span>
                    <span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.getModel.html">h2o.getModel</a></span><span class="op">(</span><span class="va">out</span><span class="op">@</span><span class="va">model_id</span><span class="op">)</span>
                  <span class="op">}</span>,
                  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">frame_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"new_DL_h2o_dat_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fl">100000</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
                    <span class="va">newdata</span> <span class="op">&lt;-</span> <span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.h2o.html">as.h2o</a></span><span class="op">(</span><span class="va">newdata</span>, destination_frame <span class="op">=</span> <span class="va">frame_name</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.predict.html">h2o.predict</a></span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
                  <span class="op">}</span>,
                  prob <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">frame_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"new_DL_h2o_dat_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fl">100000</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
                    <span class="va">newdata</span> <span class="op">&lt;-</span> <span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.h2o.html">as.h2o</a></span><span class="op">(</span><span class="va">newdata</span>, destination_frame <span class="op">=</span> <span class="va">frame_name</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.predict.html">h2o.predict</a></span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>
                  <span class="op">}</span>,
                  predictors <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.varimp.html">h2o.varimp</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">finalModel</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">==</span> <span class="st">"scaled_importance"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Overall"</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">Overall</span><span class="op">)</span>,<span class="op">]</span>   
                    <span class="va">out</span><span class="op">$</span><span class="va">names</span>
                  <span class="op">}</span>,
                  varImp <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.varimp.html">h2o.varimp</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">finalModel</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">==</span> <span class="st">"scaled_importance"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Overall"</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">names</span>
                  <span class="co">#  out &lt;- out[!is.na(out$Overall), c("Overall"), drop = FALSE]   </span>
                  <span class="co">#  all_var &lt;- object$finalModel@allparameters$x</span>
                 <span class="co">#   if(any(!(all_var %in% rownames(out)))) {</span>
                 <span class="co">#     missing &lt;- all_var[!(all_var %in% rownames(out))]</span>
                  <span class="co">#    tmp &lt;- data.frame(OVerall = rep(0, length(missing)))</span>
                 <span class="co">#     rownames(tmp) &lt;- missing</span>
                   <span class="co">#   out &lt;- rbind(out, tmp)</span>
                   <span class="co"># }</span>
                    <span class="va">out</span>
                  <span class="op">}</span>,
                  levels <span class="op">=</span> <span class="cn">NULL</span>,
                  tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Deep Learning"</span>, <span class="st">"MLP"</span>, 
                           <span class="st">"L2 Regularization"</span>, <span class="st">"learning rate"</span>,
                           <span class="st">"neural network regression"</span><span class="op">)</span>,
                  sort <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">x</span><span class="op">$</span><span class="va">units1</span>, <span class="va">x</span><span class="op">$</span><span class="va">units2</span><span class="op">)</span>,<span class="op">]</span>,
                  trim <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></pre></div>
</div>
</div>
<div id="doing-genome-scan-with-the-compiled-model-" class="section level2">
<h2 class="hasAnchor">
<a href="#doing-genome-scan-with-the-compiled-model-" class="anchor"></a>Doing genome scan with the compiled model.</h2>
<div class="sourceCode"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/h2oai/h2o-3">h2o</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">econtrol</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span><span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"adaptive_cv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,
 adaptive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.05</span>,method <span class="op">=</span> <span class="st">"gls"</span>, complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">" train neuralnet"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
   <span class="va">localH2o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.init.html">h2o.init</a></span><span class="op">(</span>nthreads <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, max_mem_size <span class="op">=</span> <span class="st">"6G"</span><span class="op">)</span>
   <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.no_progress.html">h2o.no_progress</a></span><span class="op">(</span><span class="op">)</span>
    <span class="co">#env=normalize(simdata[[j]][,2:11])</span>
    <span class="va">genotype_norm</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">genotype</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span><span class="op">)</span>
    <span class="co">#simf=as.formula(paste(colnames(env)[i],paste(names(genotype_norm[,15:1014]), collapse="+"),sep="~"))</span>
    <span class="va">model_mlph2o_envi_mlp</span><span class="op">=</span><span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span>genotype<span class="op">=</span><span class="va">genotype_norm</span>,env<span class="op">=</span><span class="va">env</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>, 
                                          method<span class="op">=</span><span class="va">DL_h2o</span>,
                                          metric <span class="op">=</span> <span class="st">"MAE"</span>,<span class="co">## "Accuracy", "RMSE"</span>
                                          <span class="co">#preProcess=c("scale"),</span>
                                          tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### search 10 combinations of parameters</span>
                                          verbose<span class="op">=</span><span class="fl">0</span>, <span class="co">#is reporting the progress,o is sclience</span>
                                          trControl <span class="op">=</span> <span class="va">econtrol</span><span class="op">)</span>
    

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"tuning mlph2o finished"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">model_mlph2o_envi_mlp</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlph2o_env_trained_model.RData"</span><span class="op">)</span><span class="op">)</span>
    <span class="co">### olden importance</span>
   <span class="co"># mlph2o_simimp1=NeuralNetTools::olden(model_mlph2o_envi_mlp$finalModel, bar_plot=FALSE)</span>
    <span class="va">mlph2o_simimp2</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.varimp.html">h2o.varimp</a></span><span class="op">(</span><span class="va">model_mlph2o_envi_mlp</span><span class="op">$</span><span class="va">finalModel</span><span class="op">)</span><span class="op">)</span>
    <span class="co">#write.csv(mlph2o_simimp1$importance,file = paste0("sim_1_",para[i],"_mlpmlph2o_importance_env.csv"))</span>
    <span class="co">####note: rearrange the order of row</span>
    <span class="va">locname</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">genotype</span><span class="op">)</span>
    <span class="va">macha</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">locname</span>,<span class="va">mlph2o_simimp2</span><span class="op">$</span><span class="va">variable</span><span class="op">)</span>
    <span class="va">ragimp</span><span class="op">=</span><span class="va">mlph2o_simimp2</span><span class="op">[</span><span class="va">macha</span>,<span class="op">]</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">ragimp</span><span class="op">$</span><span class="va">scaled_importance</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlph2o_importance2_env.csv"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">model_mlph2o_envi_mlp</span><span class="op">$</span><span class="va">results</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlph2o_env_tuning.csv"</span><span class="op">)</span> <span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"importance output finished"</span><span class="op">)</span><span class="op">)</span>
    <span class="co">#registerDoSEQ()</span>
    <span class="co">#stopCluster(cl)</span>
  <span class="op">}</span>



<span class="co">##save.image(file = "mlph2o_mlp_Scan_sims1_final_after_trained_data.RData")</span>
<span class="co">## Defining function to calculate the p-value and q-values</span>

<span class="va">DLqvalues</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">DL_data</span>,<span class="va">K</span>,<span class="va">estimation</span><span class="op">=</span><span class="st">"auto"</span><span class="op">)</span>
<span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">robust</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="http://github.com/jdstorey/qvalue">qvalue</a></span><span class="op">)</span>
  <span class="va">loadings</span><span class="op">&lt;-</span><span class="va">DL_data</span><span class="co"># [,1:as.numeric(K)]</span>
  <span class="va">resscale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">loadings</span>, <span class="fl">2</span>, <span class="va">scale</span><span class="op">)</span>
  <span class="va">resmaha</span> <span class="op">&lt;-</span> <span class="fu">robust</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/robust/man/covRob.html">covRob</a></span><span class="op">(</span><span class="va">resscale</span>, distance <span class="op">=</span> <span class="cn">TRUE</span>, na.action<span class="op">=</span> <span class="va">na.omit</span>, estim<span class="op">=</span><span class="va">estimation</span><span class="op">)</span><span class="op">$</span><span class="va">dist</span>
  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">resmaha</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">qchisq</a></span><span class="op">(</span><span class="fl">0.5</span>,df<span class="op">=</span><span class="va">K</span><span class="op">)</span>
  <span class="va">reschi2test</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">pchisq</a></span><span class="op">(</span><span class="va">resmaha</span><span class="op">/</span><span class="va">lambda</span>,<span class="va">K</span>,lower.tail<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
  <span class="va">qval</span> <span class="op">&lt;-</span> <span class="fu">qvalue</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/qvalue/man/qvalue.html">qvalue</a></span><span class="op">(</span><span class="va">reschi2test</span><span class="op">)</span>
  <span class="va">q.values_DL</span><span class="op">&lt;-</span><span class="va">qval</span><span class="op">$</span><span class="va">qvalues</span>
  <span class="va">padj</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">reschi2test</span>,method<span class="op">=</span><span class="st">"bonferroni"</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>p.values<span class="op">=</span><span class="va">reschi2test</span>, q.values<span class="op">=</span><span class="va">q.values_DL</span>,padj<span class="op">=</span><span class="va">padj</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></pre></div>
</div>
<div id="reading-importance-values-and-calculate-the-p-valuesq-values" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-importance-values-and-calculate-the-p-valuesq-values" class="anchor"></a>Reading importance values and calculate the p-values/q-values</h2>
<div class="sourceCode"><pre class="downlit">
<span class="va">impdir</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.dirs</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"."</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">impfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">impdir</span>, pattern<span class="op">=</span><span class="st">"*_mlph2o_importance_update_env.csv"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## 100 simulations and 10 envir variables, </span>
<span class="va">impSim_all</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">impfile</span>, <span class="va">read.csv</span><span class="op">)</span> <span class="co">### including all 100 simulations and 10 variables each simuilations, </span>
<span class="co">### combine every factor (envir) into one file, meaning combining each single simulation into one file</span>
<span class="va">imp_sim_list</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">impSim_all</span><span class="op">)</span><span class="op">)</span>
<span class="co">### remove the loci ID</span>
<span class="va">Xrep</span><span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">imp_sim_list</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>
<span class="va">DLdata</span> <span class="op">&lt;-</span> <span class="va">imp_sim_list</span><span class="op">[</span>,<span class="va">Xrep</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">DLdata</span><span class="op">)</span> <span class="co">### now 1:10 is the first simulation</span>
<span class="co">### spilt into 100 simulations each by 10</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"DL_mlp_h2o_Scan_sim1.RData"</span><span class="op">)</span>

<span class="co">###calculate q-values</span>

<span class="va">DLdata1</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">DLdata</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span>
<span class="va">Simqvalue</span><span class="op">=</span><span class="fu"><a href="../reference/DLqvalues.html">DLqvalues</a></span><span class="op">(</span><span class="va">DLdata1</span>,<span class="fl">10</span><span class="op">)</span>

<span class="va">Loci</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"Neutral"</span>, <span class="fl">1000</span><span class="op">)</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">11</span>,<span class="fl">21</span>,<span class="fl">31</span>,<span class="fl">41</span>,<span class="fl">51</span>,<span class="fl">61</span>,<span class="fl">71</span>,<span class="fl">81</span>,<span class="fl">91</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL1"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">101</span>,<span class="fl">111</span>,<span class="fl">121</span>,<span class="fl">131</span>,<span class="fl">141</span>,<span class="fl">151</span>,<span class="fl">161</span>,<span class="fl">171</span>,<span class="fl">181</span>,<span class="fl">191</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL2"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">201</span>,<span class="fl">211</span>,<span class="fl">221</span>,<span class="fl">231</span>,<span class="fl">241</span>,<span class="fl">251</span>,<span class="fl">261</span>,<span class="fl">271</span>,<span class="fl">281</span>,<span class="fl">291</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL3"</span>
<span class="va">p.values</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span>, DL_mlp<span class="op">=</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/H2OFrame.html">log10</a></span><span class="op">(</span><span class="va">Simqvalue</span><span class="op">$</span><span class="va">p.values</span><span class="op">)</span>,Loci<span class="op">=</span><span class="va">Loci</span><span class="op">)</span>
<span class="va">Selected_Loci</span><span class="op">&lt;-</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span></pre></div>
</div>
<div id="plotting-manhattan-plot-1" class="section level2">
<h2 class="hasAnchor">
<a href="#plotting-manhattan-plot-1" class="anchor"></a>Plotting Manhattan plot</h2>
<div class="sourceCode"><pre class="downlit">

<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"DL_mlph2o_Scan_sim1_manhattan.RData"</span><span class="op">)</span>

<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span>, y<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"gray83"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, colour <span class="op">=</span> <span class="va">Selected_Loci</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"SNP (with maf &gt; 0.05)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"DL_MLP -log10(p-values)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">40</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">p2</span></pre></div>
<div class="figure" style="text-align: center">
<img src="Detecting%20signatures%20of%20selection%20Simulation%20Case_files/figure-html/figure%202-1.png" alt="&amp;nbsp;" width="768"><p class="caption">
 
</p>
</div>
<div class="sourceCode"><pre class="downlit">

<span class="co">#save.image(file = "DL_mlph2o_Scan_sim1_manhattan.RData")</span></pre></div>
<div id="h2o-already-has-its-own-framework-that-can-train-tune-and-optimize-the-model--lets-firt-implements-h2os-own-framework-" class="section level5">
<h5 class="hasAnchor">
<a href="#h2o-already-has-its-own-framework-that-can-train-tune-and-optimize-the-model--lets-firt-implements-h2os-own-framework-" class="anchor"></a>h2o already has its own framework that can train, tune, and optimize the model. Let’s firt implements h2o’s own framework.</h5>
</div>
<div id="now-lets-define-a-deep-learning-model-with-two-hidden-layers-and-test-until-it-is-working-before-pass-to-the-framework-" class="section level5">
<h5 class="hasAnchor">
<a href="#now-lets-define-a-deep-learning-model-with-two-hidden-layers-and-test-until-it-is-working-before-pass-to-the-framework-" class="anchor"></a>Now, let’s define a deep learning model with two hidden layers and test until it is working before pass to the framework.</h5>
<div class="sourceCode"><pre class="downlit">

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/h2oai/h2o-3">h2o</a></span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">is.data.frame</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">genotype_norm</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="kw">else</span> <span class="va">genotype_norm</span>
<span class="va">dat</span><span class="op">$</span><span class="va">.outcome</span> <span class="op">&lt;-</span> <span class="va">env</span><span class="op">$</span><span class="va">envir1</span>
<span class="va">frame_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"tmp_DL_h2o_dat_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fl">100000</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">tmp_train_dat</span> <span class="op">=</span> <span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.h2o.html">as.h2o</a></span><span class="op">(</span><span class="va">dat</span>, destination_frame <span class="op">=</span> <span class="va">frame_name</span><span class="op">)</span>

<span class="va">DL_model_h2o1</span><span class="op">=</span><span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.deeplearning.html">h2o.deeplearning</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>, y <span class="op">=</span> <span class="st">".outcome"</span>,
                      training_frame <span class="op">=</span> <span class="va">tmp_train_dat</span>,
                      standardize <span class="op">=</span> <span class="cn">T</span>,
                      model_id <span class="op">=</span> <span class="st">"deep_model"</span>,        
                      activation <span class="op">=</span> <span class="st">"TanhWithDropout"</span>, 
                      hidden<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">20</span><span class="op">)</span>,
                      epochs <span class="op">=</span> <span class="fl">100</span>,       
                      seed <span class="op">=</span> <span class="fl">123</span>,
                      variable_importances <span class="op">=</span> <span class="cn">T</span>,
                      l2<span class="op">=</span><span class="fl">0.05</span>,
                      stopping_metric<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/is.factor.html">is.factor</a></span><span class="op">(</span><span class="va">env</span><span class="op">$</span><span class="va">envir1</span><span class="op">)</span>, <span class="st">"misclassification"</span>, <span class="st">"RMSE"</span><span class="op">)</span>,
                      rho<span class="op">=</span><span class="fl">0.02</span><span class="op">)</span>

<span class="va">imp_h20_DL</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.varimp.html">h2o.varimp</a></span><span class="op">(</span><span class="va">DL_model_h2o1</span><span class="op">)</span>
<span class="co">#### good performance!!</span>
<span class="co">#compute variable importance and performance</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.varimp_plot.html">h2o.varimp_plot</a></span><span class="op">(</span><span class="va">DL_model_h2o1</span>,num_of_features <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.performance.html">h2o.performance</a></span><span class="op">(</span><span class="va">DL_model_h2o1</span>,xval <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="co">###For hyperparameter tuning, we'll perform a random grid search over all parameters and choose the model which returns lowest error.  </span>

<span class="co">#set parameter space</span>
<span class="va">activation_h2o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Rectifier"</span>,<span class="st">"RectifierWithDropout"</span>, <span class="st">"Maxout"</span>,<span class="st">"MaxoutWithDropout"</span><span class="op">)</span>
<span class="va">hidden_h2o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>,<span class="fl">10</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">25</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>,<span class="fl">30</span>,<span class="fl">50</span><span class="op">)</span><span class="op">)</span>
<span class="va">l1_h2o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1e-2</span>,<span class="fl">1e-4</span><span class="op">)</span>
<span class="va">l2_h2o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1e-3</span>,<span class="fl">1e-5</span><span class="op">)</span>

<span class="va">hyper_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> activation<span class="op">=</span><span class="va">activation_h2o</span>,
                      hidden<span class="op">=</span><span class="va">hidden_h2o</span>,
                      l1<span class="op">=</span><span class="va">l1_h2o</span>,
                      l2<span class="op">=</span><span class="va">l2_h2o</span> <span class="op">)</span>
<span class="co">#set search criteria</span>
<span class="va">search_criteria</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>strategy <span class="op">=</span> <span class="st">"RandomDiscrete"</span>, max_models<span class="op">=</span><span class="fl">50</span><span class="op">)</span><span class="co">#### mumber of models here is the number of hyperparamter combinations</span>

<span class="co">#train model</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">9</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">" train neuralnet"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">localH2o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.init.html">h2o.init</a></span><span class="op">(</span>nthreads <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, max_mem_size <span class="op">=</span> <span class="st">"6G"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.no_progress.html">h2o.no_progress</a></span><span class="op">(</span><span class="op">)</span>
    <span class="co">#env=normalize(simdata[[j]][,2:11])</span>
  <span class="va">genotype_norm</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">genotype</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span><span class="op">)</span>
  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">is.data.frame</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">genotype_norm</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="kw">else</span> <span class="va">genotype_norm</span>
<span class="va">dat</span><span class="op">$</span><span class="va">.outcome</span> <span class="op">&lt;-</span> <span class="va">env</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>
<span class="va">frame_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"tmp_DL_h2o_dat_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fl">100000</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">tmp_train_dat</span> <span class="op">=</span> <span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.h2o.html">as.h2o</a></span><span class="op">(</span><span class="va">dat</span>, destination_frame <span class="op">=</span> <span class="va">frame_name</span><span class="op">)</span>
<span class="va">dl_h2o_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.grid.html">h2o.grid</a></span><span class="op">(</span><span class="st">"deeplearning"</span> ,
                    grid_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"deep_learn"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> ,
                    hyper_params <span class="op">=</span> <span class="va">hyper_params</span>,
                    search_criteria <span class="op">=</span> <span class="va">search_criteria</span>,
                    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>, y <span class="op">=</span> <span class="st">".outcome"</span>,
                    training_frame <span class="op">=</span> <span class="va">tmp_train_dat</span>,
                    nfolds <span class="op">=</span> <span class="fl">5</span>,epochs <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>

<span class="co">#get best model</span>
<span class="co">#summary(dl_h2o_grid)</span>
<span class="va">d_h2o_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.getGrid.html">h2o.getGrid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"deep_learn"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>,sort_by <span class="op">=</span> <span class="st">"RMSE"</span><span class="op">)</span>
<span class="va">best_dl_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.getModel.html">h2o.getModel</a></span><span class="op">(</span><span class="va">d_h2o_grid</span><span class="op">@</span><span class="va">model_ids</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.performance.html">h2o.performance</a></span><span class="op">(</span><span class="va">best_dl_model</span>,xval <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">imp_h20_DL</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.varimp.html">h2o.varimp</a></span><span class="op">(</span><span class="va">best_dl_model</span><span class="op">)</span><span class="op">)</span>
<span class="va">locname</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">genotype</span><span class="op">)</span>
    <span class="va">macha</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">locname</span>,<span class="va">imp_h20_DL</span><span class="op">$</span><span class="va">variable</span><span class="op">)</span>
    <span class="va">ragimp1</span><span class="op">=</span><span class="va">imp_h20_DL</span><span class="op">[</span><span class="va">macha</span>,<span class="op">]</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">ragimp1</span><span class="op">$</span><span class="va">scaled_importance</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlph2o_varimp_env.csv"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"importance output finished"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">dl_h2o_grid</span><span class="op">)</span>  
<span class="op">}</span>
<span class="co"># Fetch grid models</span>
<span class="co">#model_ids_h2o &lt;- dl_h2o_grid@model_ids</span>
<span class="co">#models &lt;- lapply(model_ids_h2o, function(id) { h2o.getModel(id)})</span>

<span class="co">#predicted_h2o = as.data.frame(h2o::h2o.predict(best_dl_model, tmp_train_dat), stringsAsFactors = TRUE)[,1]</span>
<span class="co">#cor.test(env$envir1,predicted_h2o)</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"pureh2o_sims1_final_after_trained_data.RData"</span><span class="op">)</span>

<span class="va">DLqvalues</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">DL_data</span>,<span class="va">K</span>,<span class="va">estimation</span><span class="op">=</span><span class="st">"auto"</span><span class="op">)</span>
<span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">robust</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="http://github.com/jdstorey/qvalue">qvalue</a></span><span class="op">)</span>
  <span class="va">loadings</span><span class="op">&lt;-</span><span class="va">DL_data</span><span class="co"># [,1:as.numeric(K)]</span>
  <span class="va">resscale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">loadings</span>, <span class="fl">2</span>, <span class="va">scale</span><span class="op">)</span>
  <span class="va">resmaha</span> <span class="op">&lt;-</span> <span class="fu">robust</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/robust/man/covRob.html">covRob</a></span><span class="op">(</span><span class="va">resscale</span>, distance <span class="op">=</span> <span class="cn">TRUE</span>, na.action<span class="op">=</span> <span class="va">na.omit</span>, estim<span class="op">=</span><span class="va">estimation</span><span class="op">)</span><span class="op">$</span><span class="va">dist</span>
  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">resmaha</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">qchisq</a></span><span class="op">(</span><span class="fl">0.5</span>,df<span class="op">=</span><span class="va">K</span><span class="op">)</span>
  <span class="va">reschi2test</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">pchisq</a></span><span class="op">(</span><span class="va">resmaha</span><span class="op">/</span><span class="va">lambda</span>,<span class="va">K</span>,lower.tail<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
  <span class="va">qval</span> <span class="op">&lt;-</span> <span class="fu">qvalue</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/qvalue/man/qvalue.html">qvalue</a></span><span class="op">(</span><span class="va">reschi2test</span><span class="op">)</span>
  <span class="va">q.values_DL</span><span class="op">&lt;-</span><span class="va">qval</span><span class="op">$</span><span class="va">qvalues</span>
  <span class="va">padj</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">reschi2test</span>,method<span class="op">=</span><span class="st">"bonferroni"</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>p.values<span class="op">=</span><span class="va">reschi2test</span>, q.values<span class="op">=</span><span class="va">q.values_DL</span>,padj<span class="op">=</span><span class="va">padj</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></pre></div>
</div>
<div id="reading-importance-values-and-calculate-the-p-valuesq-values-1" class="section level3">
<h3 class="hasAnchor">
<a href="#reading-importance-values-and-calculate-the-p-valuesq-values-1" class="anchor"></a>Reading importance values and calculate the p-values/q-values</h3>
<div class="sourceCode"><pre class="downlit">
<span class="va">impdir</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.dirs</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"."</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">impfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">impdir</span>, pattern<span class="op">=</span><span class="st">"*_mlph2o_varimp_env.csv"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## 100 simulations and 10 envir variables, </span>
<span class="va">impSim_all</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">impfile</span>, <span class="va">read.csv</span><span class="op">)</span> <span class="co">### including all 100 simulations and 10 variables each simuilations, </span>
<span class="co">### combine every factor (envir) into one file, meaning combining each single simulation into one file</span>
<span class="va">imp_sim_list</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">impSim_all</span><span class="op">)</span><span class="op">)</span>
<span class="co">### remove the loci ID</span>
<span class="va">Xrep</span><span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">imp_sim_list</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>
<span class="va">DLdata</span> <span class="op">&lt;-</span> <span class="va">imp_sim_list</span><span class="op">[</span>,<span class="va">Xrep</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">DLdata</span><span class="op">)</span> <span class="co">### now 1:10 is the first simulation</span>
<span class="co">### spilt into 100 simulations each by 10</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"DL_mlp_pureh2o_Scan_sim1.RData"</span><span class="op">)</span>
<span class="co">###calculate q-values</span>
<span class="va">DLdata1</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">DLdata</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span>
<span class="va">Simqvalue</span><span class="op">=</span><span class="fu"><a href="../reference/DLqvalues.html">DLqvalues</a></span><span class="op">(</span><span class="va">DLdata</span>,<span class="fl">10</span><span class="op">)</span>

<span class="va">Loci</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"Neutral"</span>, <span class="fl">1000</span><span class="op">)</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">11</span>,<span class="fl">21</span>,<span class="fl">31</span>,<span class="fl">41</span>,<span class="fl">51</span>,<span class="fl">61</span>,<span class="fl">71</span>,<span class="fl">81</span>,<span class="fl">91</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL1"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">101</span>,<span class="fl">111</span>,<span class="fl">121</span>,<span class="fl">131</span>,<span class="fl">141</span>,<span class="fl">151</span>,<span class="fl">161</span>,<span class="fl">171</span>,<span class="fl">181</span>,<span class="fl">191</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL2"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">201</span>,<span class="fl">211</span>,<span class="fl">221</span>,<span class="fl">231</span>,<span class="fl">241</span>,<span class="fl">251</span>,<span class="fl">261</span>,<span class="fl">271</span>,<span class="fl">281</span>,<span class="fl">291</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL3"</span>
<span class="va">p.values</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span>, DL_mlp<span class="op">=</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/H2OFrame.html">log10</a></span><span class="op">(</span><span class="va">Simqvalue</span><span class="op">$</span><span class="va">q.values</span><span class="op">)</span>,Loci<span class="op">=</span><span class="va">Loci</span><span class="op">)</span>
<span class="va">Selected_Loci</span><span class="op">&lt;-</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span></pre></div>
</div>
<div id="plotting-manhattan-plot-2" class="section level3">
<h3 class="hasAnchor">
<a href="#plotting-manhattan-plot-2" class="anchor"></a>Plotting Manhattan plot</h3>
<div class="sourceCode"><pre class="downlit">

<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"DL_mlph2o_Scan_sim1_manhattan.RData"</span><span class="op">)</span>
<span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span>, y<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"gray83"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, colour <span class="op">=</span> <span class="va">Selected_Loci</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"SNP (with maf &gt; 0.05)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"DL_MLP -log10(p-values)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">40</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">p3</span>

<span class="co">#save.image(file = "DL_mlph2o_Scan_sim1_manhattan.RData")</span></pre></div>
</div>
</div>
<div id="neural-network-example-with-nnet" class="section level2">
<h2 class="hasAnchor">
<a href="#neural-network-example-with-nnet" class="anchor"></a>Neural network example with “nnet”</h2>
<p>Now we use nnet library to construct the neural netwok.</p>
<div class="sourceCode"><pre class="downlit">
<span class="va">econtrol</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span> <span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"adaptive_cv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,
 adaptive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.05</span>,method <span class="op">=</span> <span class="st">"gls"</span>, complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>

 <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">para</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"tuning nnet tree 10 parameters"</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>

  <span class="co">#env=normalize(simdata[[j]][,2:11])</span>

  <span class="co">#genotype_norm=as.data.frame(apply(simdata,2,normalize))</span>

<span class="co"># simf=as.formula(paste(colnames(env)[i],paste(names(genotype_norm[,15:1014]), collapse="+"),sep="~"))</span>

 <span class="va">model_nnet_envi</span><span class="op">=</span><span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span>genotype<span class="op">=</span><span class="va">genotype_norm</span>, env<span class="op">=</span><span class="va">env</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>,
                                        method<span class="op">=</span><span class="st">"nnet"</span>,

                                        metric <span class="op">=</span> <span class="st">"MAE"</span>,<span class="co">## "Accuracy", "RMSE"</span>

                                        <span class="co">#preProcess=c("scale"),</span>

                                        tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### search 10 combinations of parameters</span>

                                        <span class="co"># verbose=1 is reporting the progress,o is sclience</span>

                                        trControl <span class="op">=</span> <span class="va">econtrol</span>,maxit<span class="op">=</span><span class="fl">100</span>,MaxNWts<span class="op">=</span><span class="fl">94581</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"tuning nnet finished"</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">model_nnet_envi</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_nnet_Scan_env_trained_model.RData"</span><span class="op">)</span><span class="op">)</span>

  <span class="co">### olden importance</span>

  <span class="va">nnet_simimp1</span><span class="op">=</span><span class="fu"><a href="../reference/varImp.html">varImp</a></span><span class="op">(</span><span class="va">model_nnet_envi</span><span class="op">$</span><span class="va">finalModel</span><span class="op">)</span>
  <span class="va">nnet_oldenimp</span><span class="op">=</span><span class="fu">NeuralNetTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/NeuralNetTools/man/olden.html">olden</a></span><span class="op">(</span><span class="va">model_nnet_envi</span><span class="op">$</span><span class="va">finalModel</span>,bar_plot<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">nnet_simimp1</span><span class="op">$</span><span class="va">Overall</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_nnet_Scan_importance_env.csv"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">nnet_oldenimp</span><span class="op">$</span><span class="va">importance</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_nnet_Scan_oldenimportance_env.csv"</span><span class="op">)</span><span class="op">)</span>


  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">model_nnet_envi</span><span class="op">$</span><span class="va">results</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_model_nnet_envi_tuning.csv"</span><span class="op">)</span> <span class="op">)</span>

  <span class="co">#registerDoSEQ()</span>

  <span class="co">#stopCluster(cl)</span>

<span class="op">}</span></pre></div>
</div>
<div id="defining-the-function-to-calculate-the-mahalanobis-distance-" class="section level2">
<h2 class="hasAnchor">
<a href="#defining-the-function-to-calculate-the-mahalanobis-distance-" class="anchor"></a>Defining the function to calculate the Mahalanobis distance.</h2>
<div class="sourceCode"><pre class="downlit">

<span class="va">DLqvalues</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">DL_data</span>,<span class="va">K</span>,<span class="va">estimation</span><span class="op">=</span><span class="st">"donostah"</span><span class="op">)</span>
<span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">robust</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="http://github.com/jdstorey/qvalue">qvalue</a></span><span class="op">)</span>
  <span class="va">loadings</span><span class="op">&lt;-</span><span class="va">DL_data</span><span class="co"># [,1:as.numeric(K)]</span>
  <span class="va">resscale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">loadings</span>, <span class="fl">2</span>, <span class="va">scale</span><span class="op">)</span>
  <span class="va">resmaha</span> <span class="op">&lt;-</span> <span class="fu">robust</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/robust/man/covRob.html">covRob</a></span><span class="op">(</span><span class="va">resscale</span>, distance <span class="op">=</span> <span class="cn">TRUE</span>, na.action<span class="op">=</span> <span class="va">na.omit</span>, estim<span class="op">=</span><span class="va">estimation</span><span class="op">)</span><span class="op">$</span><span class="va">dist</span>
  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">resmaha</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">qchisq</a></span><span class="op">(</span><span class="fl">0.5</span>,df<span class="op">=</span><span class="va">K</span><span class="op">)</span>
  <span class="va">reschi2test</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">pchisq</a></span><span class="op">(</span><span class="va">resmaha</span><span class="op">/</span><span class="va">lambda</span>,<span class="va">K</span>,lower.tail<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
  <span class="va">qval</span> <span class="op">&lt;-</span> <span class="fu">qvalue</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/qvalue/man/qvalue.html">qvalue</a></span><span class="op">(</span><span class="va">reschi2test</span><span class="op">)</span>
  <span class="va">q.values_DL</span><span class="op">&lt;-</span><span class="va">qval</span><span class="op">$</span><span class="va">qvalues</span>
  <span class="va">padj</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">reschi2test</span>,method<span class="op">=</span><span class="st">"bonferroni"</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>p.values<span class="op">=</span><span class="va">reschi2test</span>, q.values<span class="op">=</span><span class="va">q.values_DL</span>,padj<span class="op">=</span><span class="va">padj</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></pre></div>
</div>
<div id="calculating-the-mahalanobis-distance-and-p-valuesq-values" class="section level2">
<h2 class="hasAnchor">
<a href="#calculating-the-mahalanobis-distance-and-p-valuesq-values" class="anchor"></a>Calculating the Mahalanobis distance and p-values/q-values</h2>
<div class="sourceCode"><pre class="downlit">
<span class="va">impdir</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.dirs</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"."</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">impfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">impdir</span>, pattern<span class="op">=</span><span class="st">"*_nnet_Scan_oldenimportance_env.csv"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## 100 simulations and 10 envir variables, </span>
<span class="va">impSim_all</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">impfile</span>, <span class="va">read.csv</span><span class="op">)</span> <span class="co">### including all 100 simulations and 10 variables each simuilations, </span>
<span class="co">### combine every factor (envir) into one file, meaning combining each single simulation into one file</span>
<span class="va">imp_sim_list</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">impSim_all</span><span class="op">)</span><span class="op">)</span>
<span class="co">### remove the loci ID</span>
<span class="va">Xrep</span><span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">imp_sim_list</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>
<span class="va">DLdata</span> <span class="op">&lt;-</span> <span class="va">imp_sim_list</span><span class="op">[</span>,<span class="va">Xrep</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">DLdata</span><span class="op">)</span> <span class="co">### now 1:10 is the first simulation</span>
<span class="co">### spilt into 100 simulations each by 10</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"DL_nnet_scan_olden_sim1.RData"</span><span class="op">)</span>

<span class="co">###calculate q-values</span>

<span class="va">DLdata1</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">DLdata</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span>
<span class="va">Simqvalue</span><span class="op">=</span><span class="fu"><a href="../reference/DLqvalues.html">DLqvalues</a></span><span class="op">(</span><span class="va">DLdata1</span>,<span class="fl">10</span><span class="op">)</span>

<span class="va">Loci</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"Neutral"</span>, <span class="fl">1000</span><span class="op">)</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">11</span>,<span class="fl">21</span>,<span class="fl">31</span>,<span class="fl">41</span>,<span class="fl">51</span>,<span class="fl">61</span>,<span class="fl">71</span>,<span class="fl">81</span>,<span class="fl">91</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL1"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">101</span>,<span class="fl">111</span>,<span class="fl">121</span>,<span class="fl">131</span>,<span class="fl">141</span>,<span class="fl">151</span>,<span class="fl">161</span>,<span class="fl">171</span>,<span class="fl">181</span>,<span class="fl">191</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL2"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">201</span>,<span class="fl">211</span>,<span class="fl">221</span>,<span class="fl">231</span>,<span class="fl">241</span>,<span class="fl">251</span>,<span class="fl">261</span>,<span class="fl">271</span>,<span class="fl">281</span>,<span class="fl">291</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL3"</span>
<span class="va">p.values</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span>, DL_mlp<span class="op">=</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/H2OFrame.html">log10</a></span><span class="op">(</span><span class="va">Simqvalue</span><span class="op">$</span><span class="va">q.values</span><span class="op">)</span>,Loci<span class="op">=</span><span class="va">Loci</span><span class="op">)</span>
<span class="va">Selected_Loci</span><span class="op">&lt;-</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span></pre></div>
<div id="plotting-manhattan-plot-3" class="section level3">
<h3 class="hasAnchor">
<a href="#plotting-manhattan-plot-3" class="anchor"></a>Plotting Manhattan plot</h3>
<div class="sourceCode"><pre class="downlit">

<span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span>, y<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"gray83"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, colour <span class="op">=</span> <span class="va">Selected_Loci</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"SNP (with maf &gt; 0.05)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"DL_MLP -log10(p-values)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">p4</span>

<span class="co">#save.image(file = "DL_nnet_Scan_sim1_manhattan.RData")</span></pre></div>
</div>
<div id="using-other-machine-learning-models" class="section level3">
<h3 class="hasAnchor">
<a href="#using-other-machine-learning-models" class="anchor"></a>Using other machine learning models</h3>
<p>Besides the neural netwok model, other machine learning models also present impressive performance in various areas, such as extreme gradient boosting, random forest,etc. Now, we will try some extreme gradient boosting examples.</p>
</div>
<div id="extreme-gradient-boosting-with-xgbtree" class="section level3">
<h3 class="hasAnchor">
<a href="#extreme-gradient-boosting-with-xgbtree" class="anchor"></a>Extreme gradient boosting with “xgbTree”</h3>
<div class="sourceCode"><pre class="downlit">
<span class="va">econtrol</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span> <span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"adaptive_cv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,
 adaptive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.05</span>,method <span class="op">=</span> <span class="st">"gls"</span>, complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>

<span class="co">### xgbTree example</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">para</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"tuning xboost tree 10 parameters"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
  <span class="co">#env=normalize(simdata[[1]][,2:11])</span>
  <span class="co">#genotype_norm=as.data.frame(apply(simdata,2,normalize))</span>
<span class="co"># simf=as.formula(paste(colnames(env)[i],paste(names(genotype_norm[,15:1014]), collapse="+"),sep="~"))</span>
  <span class="va">model_xgbTree_envi</span><span class="op">=</span><span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">genotype</span>, y<span class="op">=</span><span class="va">env</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>,<span class="co">### using genotype_norm probably will generate 0 values and the RMSE can get NA</span>
                                        method<span class="op">=</span><span class="st">"xgbTree"</span>,
                                        metric <span class="op">=</span> <span class="st">"MAE"</span>,<span class="co">## "Accuracy", "RMSE"</span>
                                        <span class="co">#preProcess=c("scale"),</span>
                                        tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### search 100 combinations of parameters</span>
                                        <span class="co"># verbose=1 is reporting the progress,o is sclience</span>
                                        trControl <span class="op">=</span> <span class="va">econtrol</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"tuning xgbTree finished"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">model_xgbTree_envi</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_xgbTree_Scan_env_trained_model.RData"</span><span class="op">)</span><span class="op">)</span>
  <span class="co">### olden importance</span>
  <span class="va">GradiexgbTree_simimp1</span><span class="op">=</span><span class="fu"><a href="../reference/varImp.html">varImp</a></span><span class="op">(</span><span class="va">model_xgbTree_envi</span><span class="op">)</span>
   <span class="va">locname</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">genotype</span><span class="op">)</span>
    <span class="va">macha</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">locname</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">GradiexgbTree_simimp1</span><span class="op">$</span><span class="va">importance</span><span class="op">)</span><span class="op">)</span>
    <span class="va">gbtreeimp</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">GradiexgbTree_simimp1</span><span class="op">$</span><span class="va">importance</span><span class="op">)</span>,<span class="va">GradiexgbTree_simimp1</span><span class="op">$</span><span class="va">importance</span><span class="op">)</span>
    <span class="va">gbtreeimp1</span><span class="op">=</span><span class="va">gbtreeimp</span><span class="op">[</span><span class="va">macha</span>,<span class="op">]</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">gbtreeimp1</span><span class="op">$</span><span class="va">Overall</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_xgbTree_Scan_importance_env.csv"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">model_xgbTree_envi</span><span class="op">$</span><span class="va">results</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_model_xgbTree_envi_tuning.csv"</span><span class="op">)</span> <span class="op">)</span>
  <span class="co">#registerDoSEQ()</span>
  <span class="co">#stopCluster(cl)</span>
<span class="op">}</span>

 </pre></div>
<div class="sourceCode"><pre class="downlit">
<span class="va">DLqvalues</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">DL_data</span>,<span class="va">K</span>,<span class="va">estimation</span><span class="op">=</span><span class="st">"auto"</span><span class="op">)</span>
<span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">robust</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="http://github.com/jdstorey/qvalue">qvalue</a></span><span class="op">)</span>
  <span class="va">loadings</span><span class="op">&lt;-</span><span class="va">DL_data</span><span class="co"># [,1:as.numeric(K)]</span>
  <span class="va">resscale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">loadings</span>, <span class="fl">2</span>, <span class="va">scale</span><span class="op">)</span>
  <span class="va">resmaha</span> <span class="op">&lt;-</span> <span class="fu">robust</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/robust/man/covRob.html">covRob</a></span><span class="op">(</span><span class="va">resscale</span>, distance <span class="op">=</span> <span class="cn">TRUE</span>, na.action<span class="op">=</span> <span class="va">na.omit</span>, estim<span class="op">=</span><span class="va">estimation</span><span class="op">)</span><span class="op">$</span><span class="va">dist</span>
  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">resmaha</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">qchisq</a></span><span class="op">(</span><span class="fl">0.5</span>,df<span class="op">=</span><span class="va">K</span><span class="op">)</span>
  <span class="va">reschi2test</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">pchisq</a></span><span class="op">(</span><span class="va">resmaha</span><span class="op">/</span><span class="va">lambda</span>,<span class="va">K</span>,lower.tail<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
  <span class="va">qval</span> <span class="op">&lt;-</span> <span class="fu">qvalue</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/qvalue/man/qvalue.html">qvalue</a></span><span class="op">(</span><span class="va">reschi2test</span><span class="op">)</span>
  <span class="va">q.values_DL</span><span class="op">&lt;-</span><span class="va">qval</span><span class="op">$</span><span class="va">qvalues</span>
  <span class="va">padj</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">reschi2test</span>,method<span class="op">=</span><span class="st">"bonferroni"</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>p.values<span class="op">=</span><span class="va">reschi2test</span>, q.values<span class="op">=</span><span class="va">q.values_DL</span>,padj<span class="op">=</span><span class="va">padj</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></pre></div>
</div>
<div id="reading-importance-values-and-calculate-the-p-valuesq-values-2" class="section level3">
<h3 class="hasAnchor">
<a href="#reading-importance-values-and-calculate-the-p-valuesq-values-2" class="anchor"></a>Reading importance values and calculate the p-values/q-values</h3>
<div class="sourceCode"><pre class="downlit">
<span class="va">impdir</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.dirs</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"."</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">impfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">impdir</span>, pattern<span class="op">=</span><span class="st">"*_xgbTree_Scan_importance_env.csv"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## 100 simulations and 10 envir variables, </span>
<span class="va">impSim_all</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">impfile</span>, <span class="va">read.csv</span><span class="op">)</span> <span class="co">### including all 100 simulations and 10 variables each simuilations, </span>
<span class="co">### combine every factor (envir) into one file, meaning combining each single simulation into one file</span>
<span class="va">imp_sim_list</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">impSim_all</span><span class="op">)</span><span class="op">)</span>
<span class="co">### remove the loci ID</span>
<span class="va">Xrep</span><span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">imp_sim_list</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>
<span class="va">DLdata</span> <span class="op">&lt;-</span> <span class="va">imp_sim_list</span><span class="op">[</span>,<span class="va">Xrep</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">DLdata</span><span class="op">)</span> <span class="co">### now 1:10 is the first simulation</span>
<span class="co">### spilt into 100 simulations each by 10</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"DL_xgbtree_scan_sim1.RData"</span><span class="op">)</span>
<span class="co">###calculate q-values</span>
<span class="va">DLdata1</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">DLdata</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span>
<span class="va">Simqvalue</span><span class="op">=</span><span class="fu"><a href="../reference/DLqvalues.html">DLqvalues</a></span><span class="op">(</span><span class="va">DLdata1</span>,<span class="fl">10</span>,estimation<span class="op">=</span><span class="st">"auto"</span><span class="op">)</span>

<span class="va">Loci</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"Neutral"</span>, <span class="fl">1000</span><span class="op">)</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">11</span>,<span class="fl">21</span>,<span class="fl">31</span>,<span class="fl">41</span>,<span class="fl">51</span>,<span class="fl">61</span>,<span class="fl">71</span>,<span class="fl">81</span>,<span class="fl">91</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL1"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">101</span>,<span class="fl">111</span>,<span class="fl">121</span>,<span class="fl">131</span>,<span class="fl">141</span>,<span class="fl">151</span>,<span class="fl">161</span>,<span class="fl">171</span>,<span class="fl">181</span>,<span class="fl">191</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL2"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">201</span>,<span class="fl">211</span>,<span class="fl">221</span>,<span class="fl">231</span>,<span class="fl">241</span>,<span class="fl">251</span>,<span class="fl">261</span>,<span class="fl">271</span>,<span class="fl">281</span>,<span class="fl">291</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL3"</span>
<span class="va">p.values</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span>, DL_mlp<span class="op">=</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/H2OFrame.html">log10</a></span><span class="op">(</span><span class="va">Simqvalue</span><span class="op">$</span><span class="va">q.values</span><span class="op">)</span>,Loci<span class="op">=</span><span class="va">Loci</span><span class="op">)</span>
<span class="va">Selected_Loci</span><span class="op">&lt;-</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span></pre></div>
</div>
<div id="plotting-manhatan-plot" class="section level3">
<h3 class="hasAnchor">
<a href="#plotting-manhatan-plot" class="anchor"></a>Plotting Manhatan plot</h3>
<div class="sourceCode"><pre class="downlit">
<span class="va">p5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span>, y<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"gray83"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, colour <span class="op">=</span> <span class="va">Selected_Loci</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"SNP (with maf &gt; 0.05)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"DL_MLP -log10(p-values)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1000</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">p5</span>
<span class="co">#save.image(file = "DL_xgbtree_Scan_sim1_manhattan.RData")</span></pre></div>
</div>
<div id="extreme-gradient-boosting-with-xgbdart" class="section level3">
<h3 class="hasAnchor">
<a href="#extreme-gradient-boosting-with-xgbdart" class="anchor"></a>Extreme gradient boosting with “xgbDART”</h3>
<div class="sourceCode"><pre class="downlit">
<span class="va">econtrol</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span> <span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"adaptive_cv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,
 adaptive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.05</span>,method <span class="op">=</span> <span class="st">"gls"</span>, complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>
<span class="co">### xgbDART example</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">para</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"tuning xboost tree 50 parameters"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
  <span class="co">#env=normalize(simdata[[1]][,2:11])</span>
  <span class="co">#genotype_norm=as.data.frame(apply(simdata,2,normalize))</span>
<span class="co"># simf=as.formula(paste(colnames(env)[i],paste(names(genotype_norm[,15:1014]), collapse="+"),sep="~"))</span>
  <span class="va">model_xgbDART_envi</span><span class="op">=</span><span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">genotype</span>, y<span class="op">=</span><span class="va">env</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>,<span class="co">### using genotype_norm probably will generate 0 values and the RMSE can get NA</span>
                                        method<span class="op">=</span><span class="st">"xgbDART"</span>,
                                        metric <span class="op">=</span> <span class="st">"MAE"</span>,<span class="co">## "Accuracy", "RMSE"</span>
                                        <span class="co">#preProcess=c("scale"),</span>
                                      tuneLength <span class="op">=</span> <span class="fl">50</span>, <span class="co">### search 100 combinations of parameters</span>
                                      <span class="co"># verbose=1 is reporting the progress,o is sclience</span>
                                        trControl <span class="op">=</span> <span class="va">econtrol</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"tuning xgbDART finished"</span><span class="op">)</span><span class="op">)</span>
 <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">model_xgbDART_envi</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_xgbDART_Scan_env_trained_model.RData"</span><span class="op">)</span><span class="op">)</span>
  <span class="co">### olden importance</span>
  <span class="va">GradiexgbDART_simimp1</span><span class="op">=</span><span class="fu"><a href="../reference/varImp.html">varImp</a></span><span class="op">(</span><span class="va">model_xgbDART_envi</span><span class="op">)</span>
   <span class="va">locname</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">genotype</span><span class="op">)</span>
    <span class="va">macha</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">locname</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">GradiexgbDART_simimp1</span><span class="op">$</span><span class="va">importance</span><span class="op">)</span><span class="op">)</span>
    <span class="va">gbtreeimp</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">GradiexgbDART_simimp1</span><span class="op">$</span><span class="va">importance</span><span class="op">)</span>,<span class="va">GradiexgbDART_simimp1</span><span class="op">$</span><span class="va">importance</span><span class="op">)</span>
    <span class="va">gbtreeimp1</span><span class="op">=</span><span class="va">gbtreeimp</span><span class="op">[</span><span class="va">macha</span>,<span class="op">]</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">gbtreeimp1</span><span class="op">$</span><span class="va">Overall</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_xgbDART_Scan_importance_env.csv"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">model_xgbDART_envi</span><span class="op">$</span><span class="va">results</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_model_xgbDART_envi_tuning.csv"</span><span class="op">)</span> <span class="op">)</span>
  <span class="co">#registerDoSEQ()</span>
  <span class="co">#stopCluster(cl)</span>
<span class="op">}</span></pre></div>
</div>
<div id="read-importance-values" class="section level3">
<h3 class="hasAnchor">
<a href="#read-importance-values" class="anchor"></a>read importance values</h3>
<div class="sourceCode"><pre class="downlit">
<span class="va">impdir</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.dirs</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"."</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">impfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">impdir</span>, pattern<span class="op">=</span><span class="st">"*_xgbDART_Scan_importance_env.csv"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## 100 simulations and 10 envir variables, </span>
<span class="va">impSim_all</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">impfile</span>, <span class="va">read.csv</span><span class="op">)</span> <span class="co">### including all 100 simulations and 10 variables each simuilations, </span>
<span class="co">### combine every factor (envir) into one file, meaning combining each single simulation into one file</span>
<span class="va">imp_sim_list</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">impSim_all</span><span class="op">)</span><span class="op">)</span>
<span class="co">### remove the loci ID</span>
<span class="va">Xrep</span><span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">imp_sim_list</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>
<span class="va">DLdata</span> <span class="op">&lt;-</span> <span class="va">imp_sim_list</span><span class="op">[</span>,<span class="va">Xrep</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">DLdata</span><span class="op">)</span> <span class="co">### now 1:10 is the first simulation</span>
<span class="co">### spilt into 100 simulations each by 10</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"DL_xgbDART_scan_sim1.RData"</span><span class="op">)</span>

<span class="co">###calculate q-values</span>
<span class="va">DLdata1</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">DLdata</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span>
<span class="va">Simqvalue</span><span class="op">=</span><span class="fu"><a href="../reference/DLqvalues.html">DLqvalues</a></span><span class="op">(</span><span class="va">DLdata1</span>,<span class="fl">10</span>,estimation<span class="op">=</span><span class="st">"auto"</span><span class="op">)</span>
<span class="va">Loci</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"Neutral"</span>, <span class="fl">1000</span><span class="op">)</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">11</span>,<span class="fl">21</span>,<span class="fl">31</span>,<span class="fl">41</span>,<span class="fl">51</span>,<span class="fl">61</span>,<span class="fl">71</span>,<span class="fl">81</span>,<span class="fl">91</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL1"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">101</span>,<span class="fl">111</span>,<span class="fl">121</span>,<span class="fl">131</span>,<span class="fl">141</span>,<span class="fl">151</span>,<span class="fl">161</span>,<span class="fl">171</span>,<span class="fl">181</span>,<span class="fl">191</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL2"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">201</span>,<span class="fl">211</span>,<span class="fl">221</span>,<span class="fl">231</span>,<span class="fl">241</span>,<span class="fl">251</span>,<span class="fl">261</span>,<span class="fl">271</span>,<span class="fl">281</span>,<span class="fl">291</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL3"</span>
<span class="va">p.values</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span>, DL_mlp<span class="op">=</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/H2OFrame.html">log10</a></span><span class="op">(</span><span class="va">Simqvalue</span><span class="op">$</span><span class="va">q.values</span><span class="op">)</span>,Loci<span class="op">=</span><span class="va">Loci</span><span class="op">)</span>
<span class="va">Selected_Loci</span><span class="op">&lt;-</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span></pre></div>
</div>
<div id="plotting-manhattan-plot-4" class="section level3">
<h3 class="hasAnchor">
<a href="#plotting-manhattan-plot-4" class="anchor"></a>Plotting Manhattan plot</h3>
<div class="sourceCode"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"DL_xgbDART_Scan_sim1_manhattan.RData"</span><span class="op">)</span>
<span class="va">p6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span>, y<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"gray83"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, colour <span class="op">=</span> <span class="va">Selected_Loci</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"SNP (with maf &gt; 0.05)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"DL_MLP -log10(p-values)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">150</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">p6</span></pre></div>
<div class="figure" style="text-align: center">
<img src="Detecting%20signatures%20of%20selection%20Simulation%20Case_files/figure-html/figure%206-1.png" alt="&amp;nbsp;" width="768"><p class="caption">
 
</p>
</div>
<p>Note the outliers detection method based on mahalanobis distance and p-values no longer work here becasue the distances might not follow chi-square distribution. Please see the below section using autoencoder to correct the mahalanobis distance-based method.</p>
</div>
</div>
<div id="multi-step-adaptive-mcp-net-msaenet-example" class="section level2">
<h2 class="hasAnchor">
<a href="#multi-step-adaptive-mcp-net-msaenet-example" class="anchor"></a>Multi-Step Adaptive MCP-Net (msaenet) example</h2>
<p>This method implements the multi-step adaptive elastic-net method introduced in Xiao and Xu (2015) for feature selection in high-dimensional regressions.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">#Multi-Step Adaptive MCP-Net</span>
<span class="va">econtrol</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span> <span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"adaptive_cv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,
 adaptive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.05</span>,method <span class="op">=</span> <span class="st">"gls"</span>, complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>

<span class="co">### msaenet example</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">para</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"tuning Multi-Step Adaptive MCP-Net tree 10 parameters"</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>

  <span class="co">#env=normalize(simdata[[1]][,2:11])</span>

  <span class="co">#genotype_norm=as.data.frame(apply(simdata,2,normalize))</span>

<span class="co"># simf=as.formula(paste(colnames(env)[i],paste(names(genotype_norm[,15:1014]), collapse="+"),sep="~"))</span>

  <span class="va">model_msaenet_envi</span><span class="op">=</span><span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">genotype</span>, y<span class="op">=</span><span class="va">env</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>,<span class="co">### using genotype_norm probably will generate 0 values and the RMSE can get NA</span>

                                        method<span class="op">=</span><span class="st">"msaenet"</span>,

                                        metric <span class="op">=</span> <span class="st">"MAE"</span>,<span class="co">## "Accuracy", "RMSE"</span>

                                        <span class="co">#preProcess=c("scale"),</span>

                                        tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### search 100 combinations of parameters</span>

                                        <span class="co"># verbose=1 is reporting the progress,o is sclience</span>

                                        trControl <span class="op">=</span> <span class="va">econtrol</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"tuning msaenet finished"</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">model_msaenet_envi</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_msaenet_Scan_env_trained_model.RData"</span><span class="op">)</span><span class="op">)</span>

  <span class="co">### olden importance</span>

  <span class="va">msaenet_simimp1</span><span class="op">=</span><span class="fu"><a href="../reference/varImp.html">varImp</a></span><span class="op">(</span><span class="va">model_msaenet_envi</span><span class="op">)</span>
   <span class="va">locname</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">genotype</span><span class="op">)</span>
    <span class="va">macha</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">locname</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">msaenet_simimp1</span><span class="op">$</span><span class="va">importance</span><span class="op">)</span><span class="op">)</span>
    <span class="va">msaenetimp</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">msaenet_simimp1</span><span class="op">$</span><span class="va">importance</span><span class="op">)</span>,<span class="va">msaenet_simimp1</span><span class="op">$</span><span class="va">importance</span><span class="op">)</span><span class="op">)</span>
    <span class="va">msaenetimp1</span><span class="op">=</span><span class="va">msaenetimp</span><span class="op">[</span><span class="va">macha</span>,<span class="op">]</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">msaenetimp1</span><span class="op">$</span><span class="va">Overall</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_msaenet_Scan_importance_env.csv"</span><span class="op">)</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">model_msaenet_envi</span><span class="op">$</span><span class="va">results</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_model_msaenet_envi_tuning.csv"</span><span class="op">)</span> <span class="op">)</span>

  <span class="co">#registerDoSEQ()</span>

  <span class="co">#stopCluster(cl)</span>

<span class="op">}</span></pre></div>
<div id="reading-importance-values" class="section level3">
<h3 class="hasAnchor">
<a href="#reading-importance-values" class="anchor"></a>Reading importance values</h3>
<div class="sourceCode"><pre class="downlit">
<span class="va">impdir</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.dirs</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"."</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">impfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">impdir</span>, pattern<span class="op">=</span><span class="st">"*_msaenet_Scan_importance_env.csv"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## 100 simulations and 10 envir variables, </span>

<span class="va">impSim_all</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">impfile</span>, <span class="va">read.csv</span><span class="op">)</span> <span class="co">### including all 100 simulations and 10 variables each simuilations, </span>

<span class="co">### combine every factor (envir) into one file, meaning combining each single simulation into one file</span>

<span class="va">imp_sim_list</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">impSim_all</span><span class="op">)</span><span class="op">)</span>
<span class="co">### remove the loci ID</span>
<span class="va">Xrep</span><span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">imp_sim_list</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>
<span class="va">DLdata</span> <span class="op">&lt;-</span> <span class="va">imp_sim_list</span><span class="op">[</span>,<span class="va">Xrep</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">DLdata</span><span class="op">)</span> <span class="co">### now 1:10 is the first simulation</span>
<span class="co">### spilt into 100 simulations each by 10</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"DL_msaenet_scan_sim1.RData"</span><span class="op">)</span>

<span class="co">###calculate q-values</span>

<span class="va">DLdata1</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">DLdata</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span>
<span class="va">Simqvalue</span><span class="op">=</span><span class="fu"><a href="../reference/DLqvalues.html">DLqvalues</a></span><span class="op">(</span><span class="va">DLdata1</span>,<span class="fl">10</span>,estimation<span class="op">=</span><span class="st">"auto"</span><span class="op">)</span>

<span class="va">Loci</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"Neutral"</span>, <span class="fl">1000</span><span class="op">)</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">11</span>,<span class="fl">21</span>,<span class="fl">31</span>,<span class="fl">41</span>,<span class="fl">51</span>,<span class="fl">61</span>,<span class="fl">71</span>,<span class="fl">81</span>,<span class="fl">91</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL1"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">101</span>,<span class="fl">111</span>,<span class="fl">121</span>,<span class="fl">131</span>,<span class="fl">141</span>,<span class="fl">151</span>,<span class="fl">161</span>,<span class="fl">171</span>,<span class="fl">181</span>,<span class="fl">191</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL2"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">201</span>,<span class="fl">211</span>,<span class="fl">221</span>,<span class="fl">231</span>,<span class="fl">241</span>,<span class="fl">251</span>,<span class="fl">261</span>,<span class="fl">271</span>,<span class="fl">281</span>,<span class="fl">291</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL3"</span>
<span class="va">p.values</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span>, DL_mlp<span class="op">=</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/H2OFrame.html">log10</a></span><span class="op">(</span><span class="va">Simqvalue</span><span class="op">$</span><span class="va">q.values</span><span class="op">)</span>,Loci<span class="op">=</span><span class="va">Loci</span><span class="op">)</span>
<span class="va">Selected_Loci</span><span class="op">&lt;-</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span></pre></div>
<div class="sourceCode"><pre class="downlit">
<span class="co">##load("DL_msaenet_Scan_sim1_manhattan.RData")</span>
<span class="va">p7</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span>, y<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"gray83"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, colour <span class="op">=</span> <span class="va">Selected_Loci</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"SNP (with maf &gt; 0.05)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"DL_MLP -log10(p-values)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">150</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">p7</span></pre></div>
</div>
<div id="random-forest-example-using-ranger" class="section level3">
<h3 class="hasAnchor">
<a href="#random-forest-example-using-ranger" class="anchor"></a>Random forest example using “ranger”</h3>
<div class="sourceCode"><pre class="downlit">
<span class="co">## random forest</span>
<span class="co">## Use GenABEL interface to read Plink data into R and grow a classification forest</span>
<span class="co">## The ped and map files are not included</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.genabel.org">GenABEL</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/GenABEL/man/convert.snp.ped.html">convert.snp.ped</a></span><span class="op">(</span><span class="st">"data.ped"</span>, <span class="st">"data.map"</span>, <span class="st">"data.raw"</span><span class="op">)</span>
<span class="va">dat.gwaa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/GenABEL/man/load.gwaa.data.html">load.gwaa.data</a></span><span class="op">(</span><span class="st">"data.pheno"</span>, <span class="st">"data.raw"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/GenABEL/man/gwaa.data-class.html">phdata</a></span><span class="op">(</span><span class="va">dat.gwaa</span><span class="op">)</span><span class="op">$</span><span class="va">trait</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/GenABEL/man/gwaa.data-class.html">phdata</a></span><span class="op">(</span><span class="va">dat.gwaa</span><span class="op">)</span><span class="op">$</span><span class="va">trait</span><span class="op">)</span>
<span class="fu">ranger</span><span class="op">(</span><span class="va">trait</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">dat.gwaa</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">para</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">" random forest for SNP identification "</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
  <span class="co">#env=normalize(simdata[[1]][,2:11])</span>
  <span class="co">#genotype_norm=as.data.frame(apply(simdata,2,normalize))</span>
<span class="co"># simf=as.formula(paste(colnames(env)[i],paste(names(genotype_norm[,15:1014]), collapse="+"),sep="~"))</span>
  <span class="va">model_ranger_envi</span><span class="op">=</span><span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">genotype</span>, y<span class="op">=</span><span class="va">env</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>,<span class="co">### using genotype_norm probably will generate 0 values and the RMSE can get NA</span>

                                        method<span class="op">=</span><span class="st">"ranger"</span>,

                                        metric <span class="op">=</span> <span class="st">"MAE"</span>,<span class="co">## "Accuracy", "RMSE"</span>

                                        <span class="co">#preProcess=c("scale"),</span>

                                        tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### search 100 combinations of parameters</span>

                                        <span class="co"># verbose=1 is reporting the progress,o is sclience</span>

                                        trControl <span class="op">=</span> <span class="va">econtrol</span>,importance<span class="op">=</span><span class="st">"impurity_corrected"</span>,replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"tuning ranger finished"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">model_ranger_envi</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_ranger_Scan_env_trained_model.RData"</span><span class="op">)</span><span class="op">)</span>
  <span class="co">### olden importance</span>
  <span class="va">ranger_simimp1</span><span class="op">=</span><span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/varImp.html">varImp</a></span><span class="op">(</span><span class="va">model_ranger_envi</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">ranger_simimp1</span><span class="op">$</span><span class="va">importance</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_ranger_Scan_importance_env.csv"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">model_ranger_envi</span><span class="op">$</span><span class="va">results</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fl">1</span>,<span class="st">"_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_model_ranger_envi_tuning.csv"</span><span class="op">)</span> <span class="op">)</span>
<span class="op">}</span></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">impdir=<span class="kw">list.dirs</span>(<span class="dt">path =</span> <span class="st">"/home/xinghu2019/Simulations/DeepGenomeScan_v0.1/vignettes"</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>, <span class="dt">recursive =</span> <span class="ot">TRUE</span>)
impfile &lt;-<span class="st"> </span><span class="kw">list.files</span>(impdir, <span class="dt">pattern=</span><span class="st">"*_ranger_Scan_importance_env.csv"</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)
## 100 simulations and 10 envir variables, 
impSim_all=<span class="kw">lapply</span>(impfile, read.csv) ### including all 100 simulations and 10 variables each simuilations, 
### combine every factor (envir) into one file, meaning combining each single simulation into one file
imp_sim_list=<span class="kw">as.data.frame</span>(<span class="kw">do.call</span>(cbind, impSim_all))
### remove the loci ID
Xrep&lt;-<span class="st"> </span><span class="op">!</span><span class="kw">names</span>(imp_sim_list) <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">"X"</span>)
DLdata &lt;-<span class="st"> </span>imp_sim_list[,Xrep, drop =<span class="st"> </span><span class="ot">FALSE</span>]
<span class="kw">colnames</span>(DLdata) ### now 1:10 is the first simulation
### spilt into 100 simulations each by 10
<span class="kw">save.image</span>(<span class="dt">file =</span> <span class="st">"DL_ranger_scan_sim1.RData"</span>)

###calculate q-values

mahalanobis1=<span class="cf">function</span> (x, center, cov, <span class="dt">inverted =</span> <span class="ot">FALSE</span>, ...) 
{
    x &lt;-<span class="st"> </span><span class="cf">if</span> (<span class="kw">is.vector</span>(x)) 
        <span class="kw">matrix</span>(x, <span class="dt">ncol =</span> <span class="kw">length</span>(x))
    <span class="cf">else</span> <span class="kw">as.matrix</span>(x)
    <span class="cf">if</span> (<span class="op">!</span><span class="kw">isFALSE</span>(center)) 
        x &lt;-<span class="st"> </span><span class="kw">sweep</span>(x, 2L, center)
    <span class="cf">if</span> (<span class="op">!</span>inverted) 
        cov &lt;-<span class="st"> </span><span class="kw">solve</span>(cov, <span class="dt">tol=</span><span class="fl">1e-500</span>,...)
    <span class="kw">setNames</span>(<span class="kw">rowSums</span>(x <span class="op">%*%</span><span class="st"> </span>cov <span class="op">*</span><span class="st"> </span>x), <span class="kw">rownames</span>(x))
}
covRob=<span class="cf">function</span> (data, <span class="dt">corr =</span> <span class="ot">FALSE</span>, <span class="dt">distance =</span> <span class="ot">TRUE</span>, <span class="dt">na.action =</span> na.fail, 
    <span class="dt">estim =</span> <span class="st">"auto"</span>, <span class="dt">control =</span> <span class="kw">covRob.control</span>(estim, ...), ...) 
{
    data &lt;-<span class="st"> </span><span class="kw">na.action</span>(data)
    <span class="cf">if</span> (<span class="kw">is.data.frame</span>(data)) 
        data &lt;-<span class="st"> </span><span class="kw">data.matrix</span>(data)
    n &lt;-<span class="st"> </span><span class="kw">nrow</span>(data)
    p &lt;-<span class="st"> </span><span class="kw">ncol</span>(data)
    rowNames &lt;-<span class="st"> </span><span class="kw">dimnames</span>(data)[[<span class="dv">1</span>]]
    colNames &lt;-<span class="st"> </span><span class="kw">dimnames</span>(data)[[<span class="dv">2</span>]]
    <span class="kw">dimnames</span>(data) &lt;-<span class="st"> </span><span class="ot">NULL</span>
    <span class="cf">if</span> (<span class="kw">is.null</span>(colNames)) 
        colNames &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">"V"</span>, <span class="dv">1</span><span class="op">:</span>p, <span class="dt">sep =</span> <span class="st">""</span>)
    <span class="cf">if</span> (p <span class="op">&lt;</span><span class="st"> </span><span class="dv">2</span>) 
        <span class="kw">stop</span>(<span class="kw">sQuote</span>(<span class="st">"data"</span>), <span class="st">" must have at least two columns to compute "</span>, 
            <span class="st">"a covariance matrix"</span>)
    <span class="cf">if</span> (n <span class="op">&lt;</span><span class="st"> </span>p) 
        <span class="kw">stop</span>(<span class="st">"not enough observations"</span>)
    estim &lt;-<span class="st"> </span><span class="kw">casefold</span>(estim)
    <span class="cf">if</span> (estim <span class="op">==</span><span class="st"> "auto"</span>) {
        <span class="cf">if</span> ((n <span class="op">&lt;</span><span class="st"> </span><span class="dv">1000</span> <span class="op">&amp;&amp;</span><span class="st"> </span>p <span class="op">&lt;</span><span class="st"> </span><span class="dv">10</span>) <span class="op">||</span><span class="st"> </span>(n <span class="op">&lt;</span><span class="st"> </span><span class="dv">5000</span> <span class="op">&amp;&amp;</span><span class="st"> </span>p <span class="op">&lt;</span><span class="st"> </span><span class="dv">5</span>)) 
            estim &lt;-<span class="st"> "donostah"</span>
        <span class="cf">else</span> <span class="cf">if</span> (n <span class="op">&lt;</span><span class="st"> </span><span class="dv">50000</span> <span class="op">&amp;&amp;</span><span class="st"> </span>p <span class="op">&lt;</span><span class="st"> </span><span class="dv">20</span>) 
            estim &lt;-<span class="st"> "mcd"</span>
        <span class="cf">else</span> estim &lt;-<span class="st"> "pairwiseqc"</span>
        control &lt;-<span class="st"> </span><span class="kw">covRob.control</span>(estim)
    }
    <span class="cf">else</span> {
        dots &lt;-<span class="st"> </span><span class="kw">list</span>(...)
        dots.names &lt;-<span class="st"> </span><span class="kw">names</span>(dots)
        <span class="cf">if</span> (<span class="kw">any</span>(dots.names <span class="op">==</span><span class="st"> "quan"</span>) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">all</span>(dots.names <span class="op">!=</span><span class="st"> "alpha"</span>)) {
            dots.names[dots.names <span class="op">==</span><span class="st"> "quan"</span>] &lt;-<span class="st"> "alpha"</span>
            <span class="kw">names</span>(dots) &lt;-<span class="st"> </span>dots.names
        }
        <span class="cf">if</span> (<span class="kw">any</span>(dots.names <span class="op">==</span><span class="st"> "ntrial"</span>) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw">all</span>(dots.names <span class="op">!=</span><span class="st"> </span>
<span class="st">            "nsamp"</span>)) {
            dots.names[dots.names <span class="op">==</span><span class="st"> "ntrial"</span>] &lt;-<span class="st"> "nsamp"</span>
            <span class="kw">names</span>(dots) &lt;-<span class="st"> </span>dots.names
        }
        control.names &lt;-<span class="st"> </span><span class="kw">names</span>(control)
        <span class="cf">if</span> (<span class="kw">any</span>(control.names <span class="op">==</span><span class="st"> "init.control"</span>)) 
            control.names &lt;-<span class="st"> </span><span class="kw">c</span>(control.names, <span class="kw">names</span>(control<span class="op">$</span>init.control))
        <span class="cf">if</span> (<span class="kw">any</span>(<span class="op">!</span><span class="kw">is.element</span>(dots.names, control.names))) {
            bad.args &lt;-<span class="st"> </span><span class="kw">sQuote</span>(<span class="kw">setdiff</span>(dots.names, control.names))
            <span class="cf">if</span> (<span class="kw">length</span>(bad.args) <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) 
                <span class="kw">stop</span>(<span class="kw">sQuote</span>(bad.args), <span class="st">" is not a control argument for the "</span>, 
                  <span class="kw">dQuote</span>(estim), <span class="st">" estimator"</span>)
            <span class="cf">else</span> <span class="kw">stop</span>(<span class="kw">paste</span>(<span class="kw">sQuote</span>(bad.args), <span class="dt">collapse =</span> <span class="st">", "</span>), 
                <span class="st">" are not control "</span>, <span class="st">"arguments for the "</span>, <span class="kw">dQuote</span>(estim), 
                <span class="st">" estimator"</span>)
        }
    }
    ans &lt;-<span class="st"> </span><span class="cf">switch</span>(estim, <span class="dt">donostah =</span> {
        args &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">x =</span> data)
        <span class="cf">if</span> (control<span class="op">$</span>nresamp <span class="op">!=</span><span class="st"> "auto"</span>) args<span class="op">$</span>nsamp &lt;-<span class="st"> </span>control<span class="op">$</span>nresamp
        <span class="cf">if</span> (control<span class="op">$</span>maxres <span class="op">!=</span><span class="st"> "auto"</span>) args<span class="op">$</span>maxres &lt;-<span class="st"> </span>control<span class="op">$</span>maxres
        <span class="cf">if</span> (<span class="op">!</span>control<span class="op">$</span>random.sample) <span class="kw">set.seed</span>(<span class="dv">21</span>)
        args<span class="op">$</span>tune &lt;-<span class="st"> </span>control<span class="op">$</span>tune
        args<span class="op">$</span>prob &lt;-<span class="st"> </span>control<span class="op">$</span>prob
        args<span class="op">$</span>eps &lt;-<span class="st"> </span>control<span class="op">$</span>eps
        ds &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">"CovSde"</span>, args)
        <span class="kw">list</span>(<span class="dt">cov =</span> <span class="kw">getCov</span>(ds), <span class="dt">center =</span> <span class="kw">getCenter</span>(ds), <span class="dt">dist =</span> <span class="kw">getDistance</span>(ds))
    }, <span class="dt">pairwiseqc =</span> {
        x &lt;-<span class="st"> </span><span class="kw">CovOgk</span>(data, <span class="dt">control =</span> <span class="kw">CovControlOgk</span>(<span class="dt">smrob =</span> <span class="st">"s_mad"</span>, 
            <span class="dt">svrob =</span> <span class="st">"qc"</span>))
        <span class="kw">list</span>(<span class="dt">center =</span> <span class="kw">getCenter</span>(x), <span class="dt">cov =</span> <span class="kw">getCov</span>(x), <span class="dt">dist =</span> <span class="kw">getDistance</span>(x), 
            <span class="dt">raw.center =</span> x<span class="op">@</span>raw.center, <span class="dt">raw.cov =</span> x<span class="op">@</span>raw.cov, <span class="dt">raw.dist =</span> x<span class="op">@</span>raw.mah)
    }, <span class="dt">pairwisegk =</span> {
        x &lt;-<span class="st"> </span><span class="kw">CovOgk</span>(data)
        <span class="kw">list</span>(<span class="dt">center =</span> <span class="kw">getCenter</span>(x), <span class="dt">cov =</span> <span class="kw">getCov</span>(x), <span class="dt">dist =</span> <span class="kw">getDistance</span>(x), 
            <span class="dt">raw.center =</span> x<span class="op">@</span>raw.center, <span class="dt">raw.cov =</span> x<span class="op">@</span>raw.cov, <span class="dt">raw.dist =</span> x<span class="op">@</span>raw.mah)
    }, <span class="dt">m =</span> {
        mcd.control &lt;-<span class="st"> </span>control<span class="op">$</span>init.control
        control<span class="op">$</span>init.control &lt;-<span class="st"> </span><span class="ot">NULL</span>
        <span class="cf">if</span> (mcd.control<span class="op">$</span>alpha <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) mcd.control<span class="op">$</span>alpha &lt;-<span class="st"> </span>mcd.control<span class="op">$</span>alpha<span class="op">/</span>n
        init &lt;-<span class="st"> </span>robustbase<span class="op">::</span><span class="kw">covMcd</span>(data, <span class="dt">cor =</span> <span class="ot">FALSE</span>, <span class="dt">control =</span> mcd.control)
        ans &lt;-<span class="st"> </span>rrcov<span class="op">::</span><span class="kw">covMest</span>(data, <span class="dt">cor =</span> <span class="ot">FALSE</span>, <span class="dt">r =</span> control<span class="op">$</span>r, <span class="dt">arp =</span> control<span class="op">$</span>arp, 
            <span class="dt">eps =</span> control<span class="op">$</span>eps, <span class="dt">maxiter =</span> control<span class="op">$</span>maxiter, <span class="dt">t0 =</span> init<span class="op">$</span>raw.center, 
            <span class="dt">S0 =</span> init<span class="op">$</span>raw.cov)
        ans<span class="op">$</span>dist &lt;-<span class="st"> </span>ans<span class="op">$</span>mah
        ans<span class="op">$</span>raw.center &lt;-<span class="st"> </span>init<span class="op">$</span>raw.center
        ans<span class="op">$</span>raw.cov &lt;-<span class="st"> </span>init<span class="op">$</span>raw.cov
        ans<span class="op">$</span>raw.dist &lt;-<span class="st"> </span>init<span class="op">$</span>raw.mah
        ans
    }, <span class="dt">mcd =</span> {
        <span class="cf">if</span> (control<span class="op">$</span>alpha <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) control<span class="op">$</span>alpha &lt;-<span class="st"> </span>control<span class="op">$</span>alpha<span class="op">/</span>n
        ans &lt;-<span class="st"> </span>robustbase<span class="op">::</span><span class="kw">covMcd</span>(data, <span class="dt">cor =</span> <span class="ot">FALSE</span>, <span class="dt">control =</span> control)
        ans<span class="op">$</span>center &lt;-<span class="st"> </span>ans<span class="op">$</span>raw.center
        ans<span class="op">$</span>cov &lt;-<span class="st"> </span>ans<span class="op">$</span>raw.cov
        ans<span class="op">$</span>dist &lt;-<span class="st"> </span>ans<span class="op">$</span>raw.mah
        ans<span class="op">$</span>raw.cov &lt;-<span class="st"> </span>ans<span class="op">$</span>raw.cov<span class="op">/</span><span class="kw">prod</span>(ans<span class="op">$</span>raw.cnp2)
        ans<span class="op">$</span>raw.dist &lt;-<span class="st"> </span>ans<span class="op">$</span>raw.mah <span class="op">*</span><span class="st"> </span><span class="kw">prod</span>(ans<span class="op">$</span>raw.cnp2)
        ans
    }, <span class="dt">weighted =</span> {
        <span class="cf">if</span> (control<span class="op">$</span>alpha <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) control<span class="op">$</span>alpha &lt;-<span class="st"> </span>control<span class="op">$</span>alpha<span class="op">/</span>n
        ans &lt;-<span class="st"> </span>robustbase<span class="op">::</span><span class="kw">covMcd</span>(data, <span class="dt">cor =</span> <span class="ot">FALSE</span>, <span class="dt">control =</span> control)
        ans<span class="op">$</span>dist &lt;-<span class="st"> </span>ans<span class="op">$</span>mah
        ans<span class="op">$</span>raw.cov &lt;-<span class="st"> </span>ans<span class="op">$</span>raw.cov<span class="op">/</span><span class="kw">prod</span>(ans<span class="op">$</span>raw.cnp2)
        ans<span class="op">$</span>raw.dist &lt;-<span class="st"> </span>ans<span class="op">$</span>raw.mah <span class="op">*</span><span class="st"> </span><span class="kw">prod</span>(ans<span class="op">$</span>raw.cnp2)
        ans
    }, <span class="dt">default =</span> <span class="kw">stop</span>(<span class="st">"Invalid choice of estimator."</span>))
    <span class="kw">dimnames</span>(ans<span class="op">$</span>cov) &lt;-<span class="st"> </span><span class="kw">list</span>(colNames, colNames)
    <span class="kw">names</span>(ans<span class="op">$</span>center) &lt;-<span class="st"> </span>colNames
    <span class="cf">if</span> (<span class="kw">is.null</span>(ans<span class="op">$</span>raw.cov)) {
        ans<span class="op">$</span>raw.cov &lt;-<span class="st"> </span><span class="ot">NA</span>
        ans<span class="op">$</span>raw.center &lt;-<span class="st"> </span><span class="ot">NA</span>
    }
    <span class="cf">else</span> {
        <span class="kw">dimnames</span>(ans<span class="op">$</span>raw.cov) &lt;-<span class="st"> </span><span class="kw">list</span>(colNames, colNames)
        <span class="kw">names</span>(ans<span class="op">$</span>raw.center) &lt;-<span class="st"> </span>colNames
    }
    <span class="cf">if</span> (distance) {
        <span class="cf">if</span> (<span class="kw">is.null</span>(ans<span class="op">$</span>dist)) 
            ans<span class="op">$</span>dist &lt;-<span class="st"> </span><span class="kw">mahalanobis1</span>(data, ans<span class="op">$</span>center, ans<span class="op">$</span>cov)
        <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.na</span>(ans<span class="op">$</span>raw.cov[<span class="dv">1</span>])) {
            <span class="cf">if</span> (<span class="kw">is.null</span>(ans<span class="op">$</span>raw.dist)) 
                ans<span class="op">$</span>raw.dist &lt;-<span class="st"> </span><span class="kw">mahalanobis</span>(data, ans<span class="op">$</span>raw.center, 
                  ans<span class="op">$</span>raw.cov)
        }
        <span class="cf">else</span> ans<span class="op">$</span>raw.dist &lt;-<span class="st"> </span><span class="ot">NA</span>
    }
    <span class="cf">else</span> {
        ans<span class="op">$</span>dist &lt;-<span class="st"> </span><span class="ot">NA</span>
        ans<span class="op">$</span>raw.dist &lt;-<span class="st"> </span><span class="ot">NA</span>
    }
    <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.na</span>(ans<span class="op">$</span>dist[<span class="dv">1</span>]) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.null</span>(rowNames)) 
        <span class="kw">names</span>(ans<span class="op">$</span>dist) &lt;-<span class="st"> </span>rowNames
    <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.na</span>(ans<span class="op">$</span>raw.dist[<span class="dv">1</span>]) <span class="op">&amp;&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.null</span>(rowNames)) 
        <span class="kw">names</span>(ans<span class="op">$</span>raw.dist) &lt;-<span class="st"> </span>rowNames
    <span class="cf">if</span> (corr) {
        std &lt;-<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(ans<span class="op">$</span>cov))
        ans<span class="op">$</span>cov &lt;-<span class="st"> </span>ans<span class="op">$</span>cov<span class="op">/</span>(std <span class="op">%o%</span><span class="st"> </span>std)
        <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.na</span>(ans<span class="op">$</span>raw.cov[<span class="dv">1</span>])) {
            std &lt;-<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">diag</span>(ans<span class="op">$</span>raw.cov))
            ans<span class="op">$</span>raw.cov &lt;-<span class="st"> </span>ans<span class="op">$</span>raw.cov<span class="op">/</span>(std <span class="op">%o%</span><span class="st"> </span>std)
        }
    }
    ans<span class="op">$</span>corr &lt;-<span class="st"> </span>corr
    ans<span class="op">$</span>estim &lt;-<span class="st"> </span>estim
    ans<span class="op">$</span>control &lt;-<span class="st"> </span>control
    ans<span class="op">$</span>call &lt;-<span class="st"> </span><span class="kw">match.call</span>()
    ans &lt;-<span class="st"> </span>ans[<span class="kw">c</span>(<span class="st">"call"</span>, <span class="st">"cov"</span>, <span class="st">"center"</span>, <span class="st">"dist"</span>, <span class="st">"raw.cov"</span>, 
        <span class="st">"raw.center"</span>, <span class="st">"raw.dist"</span>, <span class="st">"corr"</span>, <span class="st">"estim"</span>, <span class="st">"control"</span>)]
    <span class="kw">oldClass</span>(ans) &lt;-<span class="st"> "covRob"</span>
    ans
}

DLqvalues&lt;-<span class="cf">function</span>(DL_data,K,<span class="dt">estimation=</span><span class="st">"auto"</span>)
{
  <span class="kw">require</span>(robust)
  <span class="kw">require</span>(qvalue)
  loadings&lt;-DL_data<span class="co"># [,1:as.numeric(K)]</span>
  resscale &lt;-<span class="st"> </span><span class="kw">apply</span>(loadings, <span class="dv">2</span>, scale)
  resmaha &lt;-<span class="kw">covRob</span>(resscale, <span class="dt">distance =</span> <span class="ot">TRUE</span>, <span class="dt">na.action=</span> na.omit, <span class="dt">estim=</span>estimation)<span class="op">$</span>dist
  lambda &lt;-<span class="st"> </span><span class="kw">median</span>(resmaha)<span class="op">/</span><span class="kw">qchisq</span>(<span class="fl">0.5</span>,<span class="dt">df=</span>K)
  reschi2test &lt;-<span class="st"> </span>stats<span class="op">::</span><span class="kw">pchisq</span>(resmaha<span class="op">/</span>lambda,K,<span class="dt">lower.tail=</span><span class="ot">FALSE</span>)
  qval &lt;-<span class="st"> </span>qvalue<span class="op">::</span><span class="kw">qvalue</span>(reschi2test)
  q.values_DL&lt;-qval<span class="op">$</span>qvalues
  padj &lt;-<span class="st"> </span>stats<span class="op">::</span><span class="kw">p.adjust</span>(reschi2test,<span class="dt">method=</span><span class="st">"bonferroni"</span>)
  <span class="kw">return</span>(<span class="kw">data.frame</span>(<span class="dt">p.values=</span>reschi2test, <span class="dt">q.values=</span>q.values_DL,<span class="dt">padj=</span>padj))
}
DLdata1=<span class="kw">apply</span>(DLdata,<span class="dv">2</span>,normalize)
Simqvalue=<span class="kw">DLqvalues</span>(DLdata1[,<span class="op">-</span><span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">7</span>)],<span class="dv">8</span>,<span class="dt">estimation=</span><span class="st">"auto"</span>) ### the discrete environmnet confound the True discovery 


#### Try autoencoder to construct the outlier detection
<span class="kw">library</span>(h2o)
<span class="co"># </span>
<span class="co"># ----------------------------------------------------------------------</span>
<span class="co"># </span>
<span class="co"># Your next step is to start H2O:</span>
<span class="co">#     &gt; h2o.init()</span>
<span class="co"># </span>
<span class="co"># For H2O package documentation, ask for help:</span>
<span class="co">#     &gt; ??h2o</span>
<span class="co"># </span>
<span class="co"># After starting H2O, you can use the Web UI at http://localhost:54321</span>
<span class="co"># For more information visit https://docs.h2o.ai</span>
<span class="co"># </span>
<span class="co"># ----------------------------------------------------------------------</span>
<span class="co"># </span>
<span class="co"># Attaching package: 'h2o'</span>
<span class="co"># The following objects are masked from 'package:stats':</span>
<span class="co"># </span>
<span class="co">#     cor, sd, var</span>
<span class="co"># The following objects are masked from 'package:base':</span>
<span class="co"># </span>
<span class="co">#     ||, &amp;&amp;, %*%, apply, as.factor, as.numeric, colnames,</span>
<span class="co">#     colnames&lt;-, ifelse, %in%, is.character, is.factor, is.numeric,</span>
<span class="co">#     log, log10, log1p, log2, round, signif, trunc</span>
localH2O =<span class="st"> </span><span class="kw">h2o.init</span>()

Loimp&lt;-<span class="kw">as.h2o</span>(DLdata, <span class="dt">destination_frame=</span><span class="st">"train.hex"</span>)
feature_names=<span class="kw">colnames</span>(DLdata)
prostate.dl =<span class="st"> </span><span class="kw">h2o.deeplearning</span>(<span class="dt">x =</span> feature_names, <span class="dt">training_frame =</span> Loimp,
                               <span class="dt">autoencoder =</span> <span class="ot">TRUE</span>,
                               <span class="dt">reproducible =</span> T,
                               <span class="dt">seed =</span> <span class="dv">1234</span>,
                               <span class="dt">hidden =</span> <span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">10</span>,<span class="dv">10</span>), <span class="dt">epochs =</span> <span class="dv">1000</span>)
<span class="co"># Locimpout = h2o.anomaly(DLdata, Loimp, per_feature=TRUE)</span>
<span class="co"># head(Locimpout)</span>

Locimpout =<span class="st"> </span><span class="kw">h2o.anomaly</span>(prostate.dl, Loimp, <span class="dt">per_feature=</span><span class="ot">FALSE</span>)
<span class="kw">head</span>(Locimpout)
err &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(Locimpout)

prostate_anon =<span class="st"> </span><span class="kw">h2o.anomaly</span>(prostate.dl, Loimp)
<span class="kw">head</span>(prostate_anon)
prostate_anon_per_feature =<span class="st"> </span><span class="kw">h2o.anomaly</span>(prostate.dl, Loimp, <span class="dt">per_feature =</span> <span class="ot">TRUE</span>)
<span class="kw">head</span>(prostate_anon_per_feature)

Loci&lt;-<span class="kw">rep</span>(<span class="st">"Neutral"</span>, <span class="dv">1000</span>)
Loci[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">11</span>,<span class="dv">21</span>,<span class="dv">31</span>,<span class="dv">41</span>,<span class="dv">51</span>,<span class="dv">61</span>,<span class="dv">71</span>,<span class="dv">81</span>,<span class="dv">91</span>)]&lt;-<span class="st">"QTL1"</span>
Loci[<span class="kw">c</span>(<span class="dv">101</span>,<span class="dv">111</span>,<span class="dv">121</span>,<span class="dv">131</span>,<span class="dv">141</span>,<span class="dv">151</span>,<span class="dv">161</span>,<span class="dv">171</span>,<span class="dv">181</span>,<span class="dv">191</span>)]&lt;-<span class="st">"QTL2"</span>
Loci[<span class="kw">c</span>(<span class="dv">201</span>,<span class="dv">211</span>,<span class="dv">221</span>,<span class="dv">231</span>,<span class="dv">241</span>,<span class="dv">251</span>,<span class="dv">261</span>,<span class="dv">271</span>,<span class="dv">281</span>,<span class="dv">291</span>)]&lt;-<span class="st">"QTL3"</span>
p.values&lt;-<span class="kw">data.frame</span>(<span class="dt">index =</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>), <span class="dt">DL_mlp=</span><span class="op">-</span><span class="kw">log10</span>(Simqvalue<span class="op">$</span>q.values),<span class="dt">Loci=</span>Loci)
Selected_Loci&lt;-p.values<span class="op">$</span>Loci[<span class="op">-</span><span class="kw">which</span>(p.values<span class="op">$</span>Loci<span class="op">==</span><span class="st">"Neutral"</span>)]


MLP_MSE&lt;-<span class="kw">data.frame</span>(<span class="dt">index =</span> <span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>), <span class="dt">DL_mlp=</span>(err<span class="op">$</span>Reconstruction.MSE),<span class="dt">Loci=</span>Loci)
Selected_Loci&lt;-p.values<span class="op">$</span>Loci[<span class="op">-</span><span class="kw">which</span>(p.values<span class="op">$</span>Loci<span class="op">==</span><span class="st">"Neutral"</span>)]
<span class="co">#  [1] "Overall"   "Overall.1" "Overall.2" "Overall.3" "Overall.4"</span>
<span class="co">#  [6] "Overall.5" "Overall.6" "Overall.7" "Overall.8" "Overall.9"</span>
<span class="co">#  Connection successful!</span>
<span class="co"># </span>
<span class="co"># R is connected to the H2O cluster: </span>
<span class="co">#     H2O cluster uptime:         3 hours 54 minutes </span>
<span class="co">#     H2O cluster timezone:       Europe/London </span>
<span class="co">#     H2O data parsing timezone:  UTC </span>
<span class="co">#     H2O cluster version:        3.30.1.3 </span>
<span class="co">#     H2O cluster version age:    7 months and 4 days !!! </span>
<span class="co">#     H2O cluster name:           H2O_started_from_R_root_bki425 </span>
<span class="co">#     H2O cluster total nodes:    1 </span>
<span class="co">#     H2O cluster total memory:   1.56 GB </span>
<span class="co">#     H2O cluster total cores:    4 </span>
<span class="co">#     H2O cluster allowed cores:  4 </span>
<span class="co">#     H2O cluster healthy:        TRUE </span>
<span class="co">#     H2O Connection ip:          localhost </span>
<span class="co">#     H2O Connection port:        54321 </span>
<span class="co">#     H2O Connection proxy:       NA </span>
<span class="co">#     H2O Internal Security:      FALSE </span>
<span class="co">#     H2O API Extensions:         Amazon S3, XGBoost, Algos, AutoML, Core V3, TargetEncoder, Core V4 </span>
<span class="co">#     R Version:                  R version 3.6.1 (2019-07-05) </span>
<span class="co"># </span>
<span class="co"># </span>
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|</span><span class="st">                                                                 </span><span class="er">|</span><span class="st">   </span><span class="dv">0</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|=================================================================|</span><span class="st"> </span><span class="dv">100</span>%
<span class="co"># </span>
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|</span><span class="st">                                                                 </span><span class="er">|</span><span class="st">   </span><span class="dv">0</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|====</span><span class="st">                                                             </span><span class="er">|</span><span class="st">   </span><span class="dv">7</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|========</span><span class="st">                                                         </span><span class="er">|</span><span class="st">  </span><span class="dv">12</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|============</span><span class="st">                                                     </span><span class="er">|</span><span class="st">  </span><span class="dv">18</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|===============</span><span class="st">                                                  </span><span class="er">|</span><span class="st">  </span><span class="dv">23</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|==================</span><span class="st">                                               </span><span class="er">|</span><span class="st">  </span><span class="dv">28</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|=====================</span><span class="st">                                            </span><span class="er">|</span><span class="st">  </span><span class="dv">33</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|========================</span><span class="st">                                         </span><span class="er">|</span><span class="st">  </span><span class="dv">37</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|===========================</span><span class="st">                                      </span><span class="er">|</span><span class="st">  </span><span class="dv">42</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|==============================</span><span class="st">                                   </span><span class="er">|</span><span class="st">  </span><span class="dv">46</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|=================================</span><span class="st">                                </span><span class="er">|</span><span class="st">  </span><span class="dv">50</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|====================================</span><span class="st">                             </span><span class="er">|</span><span class="st">  </span><span class="dv">55</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|======================================</span><span class="st">                           </span><span class="er">|</span><span class="st">  </span><span class="dv">59</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|=========================================</span><span class="st">                        </span><span class="er">|</span><span class="st">  </span><span class="dv">63</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|===========================================</span><span class="st">                      </span><span class="er">|</span><span class="st">  </span><span class="dv">67</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|==============================================</span><span class="st">                   </span><span class="er">|</span><span class="st">  </span><span class="dv">71</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|================================================</span><span class="st">                 </span><span class="er">|</span><span class="st">  </span><span class="dv">75</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|===================================================</span><span class="st">              </span><span class="er">|</span><span class="st">  </span><span class="dv">78</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|=====================================================</span><span class="st">            </span><span class="er">|</span><span class="st">  </span><span class="dv">82</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|========================================================</span><span class="st">         </span><span class="er">|</span><span class="st">  </span><span class="dv">86</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|==========================================================</span><span class="st">       </span><span class="er">|</span><span class="st">  </span><span class="dv">89</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|============================================================</span><span class="st">     </span><span class="er">|</span><span class="st">  </span><span class="dv">93</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|===============================================================</span><span class="st">  </span><span class="er">|</span><span class="st">  </span><span class="dv">96</span>%
  <span class="op">|</span><span class="st">                                                                       </span>
<span class="st">  </span><span class="er">|=================================================================|</span><span class="st"> </span><span class="dv">100</span>%
<span class="co">#   Reconstruction.MSE</span>
<span class="co"># 1       4.944123e-04</span>
<span class="co"># 2       1.014526e-04</span>
<span class="co"># 3       1.197233e-04</span>
<span class="co"># 4       5.173995e-04</span>
<span class="co"># 5       2.302771e-05</span>
<span class="co"># 6       1.088714e-04</span>
<span class="co">#   Reconstruction.MSE</span>
<span class="co"># 1       4.944123e-04</span>
<span class="co"># 2       1.014526e-04</span>
<span class="co"># 3       1.197233e-04</span>
<span class="co"># 4       5.173995e-04</span>
<span class="co"># 5       2.302771e-05</span>
<span class="co"># 6       1.088714e-04</span>
<span class="co">#   reconstr_Overall.SE reconstr_Overall.1.SE reconstr_Overall.2.SE</span>
<span class="co"># 1        7.514726e-05          1.992749e-03          1.376523e-05</span>
<span class="co"># 2        1.516515e-07          4.758491e-05          3.185421e-05</span>
<span class="co"># 3        2.396642e-05          1.159243e-05          5.209207e-05</span>
<span class="co"># 4        1.297110e-04          4.532196e-05          6.378183e-05</span>
<span class="co"># 5        1.077169e-04          5.117244e-07          4.623367e-06</span>
<span class="co"># 6        5.721887e-06          6.060704e-05          1.683548e-05</span>
<span class="co">#   reconstr_Overall.3.SE reconstr_Overall.4.SE reconstr_Overall.5.SE</span>
<span class="co"># 1          4.236208e-04          1.927254e-03          5.590005e-05</span>
<span class="co"># 2          6.385523e-04          3.786654e-05          1.424314e-05</span>
<span class="co"># 3          4.340652e-04          7.868405e-10          3.627963e-05</span>
<span class="co"># 4          5.867697e-06          4.163324e-06          2.677203e-05</span>
<span class="co"># 5          5.867697e-06          3.554956e-06          1.561003e-05</span>
<span class="co"># 6          6.515638e-04          2.681937e-05          9.315670e-06</span>
<span class="co">#   reconstr_Overall.6.SE reconstr_Overall.7.SE reconstr_Overall.8.SE</span>
<span class="co"># 1          4.228555e-06          2.856027e-04          7.640090e-06</span>
<span class="co"># 2          4.228555e-06          1.196248e-04          4.665664e-05</span>
<span class="co"># 3          4.228555e-06          5.589126e-04          2.433334e-05</span>
<span class="co"># 4          4.228555e-06          4.865315e-03          2.842759e-05</span>
<span class="co"># 5          4.228555e-06          7.560494e-05          6.107906e-06</span>
<span class="co"># 6          2.831970e-04          3.153456e-05          5.536286e-07</span>
<span class="co">#   reconstr_Overall.9.SE</span>
<span class="co"># 1          1.582160e-04</span>
<span class="co"># 2          7.376275e-05</span>
<span class="co"># 3          5.176155e-05</span>
<span class="co"># 4          4.065183e-07</span>
<span class="co"># 5          6.451005e-06</span>
<span class="co"># 6          2.566018e-06</span></code></pre></div>
</div>
</div>
<div id="outlier-detection-using-autoencoder" class="section level2">
<h2 class="hasAnchor">
<a href="#outlier-detection-using-autoencoder" class="anchor"></a>Outlier detection using autoencoder</h2>
<p>This section will demonstrate how to use the autoencoder to detect the outliers when using p-values or q-values do not work (see example in )</p>
<div class="sourceCode"><pre class="downlit">

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="va">p8</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">MLP_MSE</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">MLP_MSE</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span>, y<span class="op">=</span><span class="va">MLP_MSE</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">MLP_MSE</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"gray83"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">MLP_MSE</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">MLP_MSE</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">MLP_MSE</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">MLP_MSE</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, colour <span class="op">=</span> <span class="va">Selected_Loci</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"SNP (with maf &gt; 0.05)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"DL_MLP_MSE"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">p8</span></pre></div>
<div class="figure" style="text-align: center">
<img src="Detecting%20signatures%20of%20selection%20Simulation%20Case_files/figure-html/figure%208-1.png" alt="&amp;nbsp;" width="768"><p class="caption">
 
</p>
</div>
<div class="sourceCode"><pre class="downlit">
<span class="co">##save.image(file = "DL_ranger_Scan_sim1_manhattan.RData")</span></pre></div>
<p>Now the MSE-based Manhattan plot seems better compared to the p-values/q-values above.</p>
<p>We will post and update the outlier method in DeepGenomeScan in our next version. We also need to test its performance compared to p-values/q-values.</p>
<div id="neural-network-mlp-example-using-neuralnet" class="section level3">
<h3 class="hasAnchor">
<a href="#neural-network-mlp-example-using-neuralnet" class="anchor"></a>Neural network MLP example using “neuralnet”</h3>
<div class="sourceCode"><pre class="downlit">

<span class="co">########## neuralnet mlp random search############################################</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">econtrol</span> <span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span><span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"adaptive_cv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,
 adaptive <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.05</span>,method <span class="op">=</span> <span class="st">"gls"</span>, complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
  search <span class="op">=</span> <span class="st">"random"</span>
 <span class="op">)</span>

<span class="va">softplus</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/H2OFrame.html">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="co">### now we use self-defined smooth RELU function</span>
<span class="va">softplus</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/H2OFrame.html">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="co">### indeed this function learns well with old version of neuralnet package. return to the older version if necessary which will have less hyperparameter (difficult to overfit with older version)</span>

<span class="co">### mlpneuralnet</span>
<span class="co">#</span>
<span class="co">#### mlpneuralnet1</span>
<span class="va">k</span><span class="op">=</span><span class="fl">2</span>
<span class="va">a</span><span class="op">=</span><span class="fl">0.8</span>
<span class="va">linear</span><span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">a</span><span class="op">*</span><span class="va">x</span>
<span class="va">customRelu</span> <span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">*</span><span class="va">k</span><span class="op">*</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">}</span> 
<span class="va">softplus</span> <span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/H2OFrame.html">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> 
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/remotes/man/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"bips-hb/neuralnet"</span><span class="op">)</span>
<span class="co">#### Note this architecture has whether the output activatioin is linear, some studies say linear is more effective for unbounded regression, when linear output is TRUE, the activation 2 is invalid</span>
<span class="co">### some time the simpler the faster and the better</span>
<span class="co">#### The developement version of neuralnet, which allows specifying the output function</span>
<span class="va">mlpneuralnet1</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Neural Network"</span>,
                      library <span class="op">=</span> <span class="st">"neuralnet"</span>,
                      loop <span class="op">=</span> <span class="cn">NULL</span>,
                      type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Regression'</span><span class="op">)</span>,
                      parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'layer1'</span>, <span class="st">'layer2'</span>, <span class="st">'layer3'</span>,<span class="st">"activation1"</span>,<span class="st">"activation2"</span>,<span class="st">"linear.output"</span><span class="op">)</span>,
                                              class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'numeric'</span>, <span class="st">'numeric'</span>, <span class="st">'numeric'</span>,<span class="st">"character"</span>,<span class="st">"character"</span>,<span class="st">"character"</span><span class="op">)</span>,
                                              label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Number of hidden Units in Layer 1'</span>, <span class="st">'number of hidden Units in Layer 2'</span>, <span class="st">'number of hidden Units in Layer 3'</span>,<span class="st">"Activation function in hidden layer"</span>,<span class="st">"Activation function in output layer"</span>,<span class="st">"Activation function linear out choice"</span><span class="op">)</span><span class="op">)</span>,
                      grid <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">len</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">search</span> <span class="op">=</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                        <span class="va">afuncs</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="st">"tanh"</span>,<span class="st">"softplus"</span><span class="op">)</span>
                        <span class="va">outputf</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"TRUE"</span>,<span class="st">"FALSE"</span><span class="op">)</span>
                        <span class="kw">if</span><span class="op">(</span><span class="va">search</span> <span class="op">==</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                          <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>layer1 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, layer2 <span class="op">=</span> <span class="fl">0</span>, layer3 <span class="op">=</span> <span class="fl">0</span>, activation1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="st">"tanh"</span>,<span class="st">"softplus"</span><span class="op">)</span>,activation2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="st">"tanh"</span>,<span class="st">"softplus"</span><span class="op">)</span>,linear.output<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"TRUE"</span>,<span class="st">"FALSE"</span><span class="op">)</span><span class="op">)</span>
                        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                          <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>layer1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">20</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                            layer2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                            layer3 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                            activation1<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                                            activation2<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                                            linear.output<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">outputf</span>,size <span class="op">=</span> <span class="va">len</span>,replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
                        <span class="op">}</span>
                        <span class="va">out</span>
                      <span class="op">}</span>,
                      fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">wts</span>, <span class="va">param</span>, <span class="va">lev</span>, <span class="va">last</span>, <span class="va">classProbs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                        <span class="va">colNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
                        <span class="va">dat</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">is.data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">x</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                        <span class="va">dat</span><span class="op">$</span><span class="va">.outcome</span> <span class="op">&lt;-</span> <span class="va">y</span>
                        <span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">".outcome ~"</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">colNames</span>, collapse <span class="op">=</span> <span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
                        <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer1</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"the first layer must have at least one hidden unit"</span><span class="op">)</span>
                        <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer2</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">param</span><span class="op">$</span><span class="va">layer2</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"the second layer must have at least one hidden unit if a third layer is specified"</span><span class="op">)</span>
                        <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer1</span><span class="op">)</span>
                        <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer2</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
                          <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">nodes</span>, <span class="va">param</span><span class="op">$</span><span class="va">layer2</span><span class="op">)</span>
                          <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer3</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">nodes</span>, <span class="va">param</span><span class="op">$</span><span class="va">layer3</span><span class="op">)</span>
                        <span class="op">}</span>
                        <span class="va">actf</span><span class="op">=</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation1</span><span class="op">)</span><span class="co">### note the difference in c(param$activation) for this model and other model, becaue the self-defined softplus function can't be a vector, so here we should not use c(,softplus)</span>
                        <span class="va">outputactf</span><span class="op">=</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation2</span><span class="op">)</span>
                        <span class="va">linear.output</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">linear.output</span><span class="op">)</span>
                        <span class="fu">neuralnet</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/neuralnet/man/neuralnet.html">neuralnet</a></span><span class="op">(</span><span class="va">form</span>, algorithm<span class="op">=</span><span class="st">"rprop+"</span>,data <span class="op">=</span> <span class="va">dat</span>,rep<span class="op">=</span><span class="fl">1</span>, hidden <span class="op">=</span> <span class="va">nodes</span>, stepmax <span class="op">=</span> <span class="fl">1e+09</span>, learningrate.factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>minus <span class="op">=</span> <span class="fl">0.5</span>,plus <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span>,act.fct<span class="op">=</span><span class="va">actf</span>,output.act.fct<span class="op">=</span><span class="va">outputactf</span>,linear.output<span class="op">=</span><span class="va">linear.output</span>,<span class="va">...</span><span class="op">)</span>
                      <span class="op">}</span>,
                      predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                        <span class="va">newdata</span> <span class="op">&lt;-</span> <span class="va">newdata</span><span class="op">[</span>, <span class="va">modelFit</span><span class="op">$</span><span class="va">model.list</span><span class="op">$</span><span class="va">variables</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
                        <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">modelFit</span>, covariate <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span><span class="op">$</span><span class="va">net.result</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
                      <span class="op">}</span>,
                 varImp <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span>
                   <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu">NeuralNetTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/NeuralNetTools/man/olden.html">olden</a></span><span class="op">(</span><span class="va">object</span>,bar_plot <span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
                   <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Overall <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">imps</span><span class="op">)</span><span class="op">)</span>
                   <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">imps</span><span class="op">)</span>
                   <span class="va">out</span>
                 <span class="op">}</span>,
                      prob <span class="op">=</span> <span class="cn">NULL</span>,
                      tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Neural Network"</span><span class="op">)</span>,
                      sort <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">layer1</span>, <span class="va">x</span><span class="op">$</span><span class="va">layer2</span>, <span class="va">x</span><span class="op">$</span><span class="va">layer3</span>,<span class="va">x</span><span class="op">$</span><span class="va">activation1</span>,<span class="va">x</span><span class="op">$</span><span class="va">activation2</span>,<span class="va">x</span><span class="op">$</span><span class="va">linear.output</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">para</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">" train neuralnet"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
    <span class="co">#env=normalize(simdata[[j]][,2:11])</span>
    <span class="va">genotype_norm</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">sim_example</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span><span class="op">)</span>
    <span class="va">simf</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">[</span>,<span class="fl">15</span><span class="op">:</span><span class="fl">1014</span><span class="op">]</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">"~"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">model_neuralnet_envi_mlp</span><span class="op">=</span><span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="va">simf</span>, data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>,
                                          method<span class="op">=</span><span class="st">"neuralnet"</span>,
                                          metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE"</span>
                                          <span class="co">#preProcess=c("scale"),</span>
                                          tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### search 10 combinations of parameters</span>
                                          <span class="co"># verbose=1 is reporting the progress,o is sclience</span>
                                          trControl <span class="op">=</span> <span class="va">econtrol</span><span class="op">)</span>
    

    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"tuning neuralnet finished"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">model_neuralnet_envi_mlp</span>,file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpneuralnet_env_trained_model.RData"</span><span class="op">)</span><span class="op">)</span>
    <span class="co">### olden importance</span>
    <span class="va">neuralnet_simimp1</span><span class="op">=</span><span class="fu">NeuralNetTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/NeuralNetTools/man/olden.html">olden</a></span><span class="op">(</span><span class="va">model_neuralnet_envi_mlp</span><span class="op">$</span><span class="va">finalModel</span>, bar_plot<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">neuralnet_simimp1</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpneuralnet_importance_env.csv"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">model_neuralnet_envi_mlp</span><span class="op">$</span><span class="va">results</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpneuralnet_env_tuning.csv"</span><span class="op">)</span> <span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_1_"</span>,<span class="va">para</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"importance output finished"</span><span class="op">)</span><span class="op">)</span>
    <span class="co">#registerDoSEQ()</span>
    <span class="co">#stopCluster(cl)</span>
  <span class="op">}</span>

<span class="co">#save.image(file = "neuralnet_mlp_Scan_sims_final_after_trained_data.RData")</span>

<span class="va">DLqvalues</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">DL_data</span>,<span class="va">K</span>,<span class="va">estimation</span><span class="op">=</span><span class="st">"auto"</span><span class="op">)</span>
<span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">robust</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="http://github.com/jdstorey/qvalue">qvalue</a></span><span class="op">)</span>
  <span class="va">loadings</span><span class="op">&lt;-</span><span class="va">DL_data</span><span class="co"># [,1:as.numeric(K)]</span>
  <span class="va">resscale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">loadings</span>, <span class="fl">2</span>, <span class="va">scale</span><span class="op">)</span>
  <span class="va">resmaha</span> <span class="op">&lt;-</span> <span class="fu">robust</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/robust/man/covRob.html">covRob</a></span><span class="op">(</span><span class="va">resscale</span>, distance <span class="op">=</span> <span class="cn">TRUE</span>, na.action<span class="op">=</span> <span class="va">na.omit</span>, estim<span class="op">=</span><span class="va">estimation</span><span class="op">)</span><span class="op">$</span><span class="va">dist</span>
  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">resmaha</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">qchisq</a></span><span class="op">(</span><span class="fl">0.5</span>,df<span class="op">=</span><span class="va">K</span><span class="op">)</span>
  <span class="va">reschi2test</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">pchisq</a></span><span class="op">(</span><span class="va">resmaha</span><span class="op">/</span><span class="va">lambda</span>,<span class="va">K</span>,lower.tail<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
  <span class="va">qval</span> <span class="op">&lt;-</span> <span class="fu">qvalue</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/qvalue/man/qvalue.html">qvalue</a></span><span class="op">(</span><span class="va">reschi2test</span><span class="op">)</span>
  <span class="va">q.values_DL</span><span class="op">&lt;-</span><span class="va">qval</span><span class="op">$</span><span class="va">qvalues</span>
  <span class="va">padj</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">reschi2test</span>,method<span class="op">=</span><span class="st">"bonferroni"</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>p.values<span class="op">=</span><span class="va">reschi2test</span>, q.values<span class="op">=</span><span class="va">q.values_DL</span>,padj<span class="op">=</span><span class="va">padj</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<div class="sourceCode"><pre class="downlit">

<span class="va">impdir</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.dirs</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"."</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">impfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">impdir</span>, pattern<span class="op">=</span><span class="st">"*_mlpneuralnet_importance_env.csv"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## 100 simulations and 10 envir variables, </span>

<span class="va">impSim_all</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">impfile</span>, <span class="va">read.csv</span><span class="op">)</span> <span class="co">### including all 100 simulations and 10 variables each simuilations, </span>

<span class="co">### combine every factor (envir) into one file, meaning combining each single simulation into one file</span>

<span class="va">imp_sim_list</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">impSim_all</span><span class="op">)</span><span class="op">)</span>
<span class="co">### remove the loci ID</span>
<span class="va">Xrep</span><span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">imp_sim_list</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X"</span><span class="op">)</span>
<span class="va">DLdata</span> <span class="op">&lt;-</span> <span class="va">imp_sim_list</span><span class="op">[</span>,<span class="va">Xrep</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">DLdata</span><span class="op">)</span> <span class="co">### now 1:10 is the first simulation</span>
<span class="co">### spilt into 100 simulations each by 10</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"DL_mlp_neural_Scan_sim1.RData"</span><span class="op">)</span>

<span class="co">###calculate q-values</span>

<span class="va">DLdata1</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">DLdata</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span>
<span class="va">Simqvalue</span><span class="op">=</span><span class="fu"><a href="../reference/DLqvalues.html">DLqvalues</a></span><span class="op">(</span><span class="va">DLdata1</span>,<span class="fl">10</span><span class="op">)</span>

<span class="va">Loci</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"Neutral"</span>, <span class="fl">1000</span><span class="op">)</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">11</span>,<span class="fl">21</span>,<span class="fl">31</span>,<span class="fl">41</span>,<span class="fl">51</span>,<span class="fl">61</span>,<span class="fl">71</span>,<span class="fl">81</span>,<span class="fl">91</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL1"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">101</span>,<span class="fl">111</span>,<span class="fl">121</span>,<span class="fl">131</span>,<span class="fl">141</span>,<span class="fl">151</span>,<span class="fl">161</span>,<span class="fl">171</span>,<span class="fl">181</span>,<span class="fl">191</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL2"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">201</span>,<span class="fl">211</span>,<span class="fl">221</span>,<span class="fl">231</span>,<span class="fl">241</span>,<span class="fl">251</span>,<span class="fl">261</span>,<span class="fl">271</span>,<span class="fl">281</span>,<span class="fl">291</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL3"</span>
<span class="va">p.values</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span>, DL_mlp<span class="op">=</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/H2OFrame.html">log10</a></span><span class="op">(</span><span class="va">Simqvalue</span><span class="op">$</span><span class="va">p.values</span><span class="op">)</span>,Loci<span class="op">=</span><span class="va">Loci</span><span class="op">)</span>
<span class="va">Selected_Loci</span><span class="op">&lt;-</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span></pre></div>
</div>
<div id="manhattan-plot" class="section level3">
<h3 class="hasAnchor">
<a href="#manhattan-plot" class="anchor"></a>Manhattan plot</h3>
<div class="sourceCode"><pre class="downlit">

<span class="va">p10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span>, y<span class="op">=</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"gray83"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">DL_mlp</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">p.values</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, colour <span class="op">=</span> <span class="va">Selected_Loci</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"SNP (with maf &gt; 0.05)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"DL_MLP -log10(p-values)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">p10</span></pre></div>
<div id="mlp-model-implementation-with-default-seting--details-about-the-ready-to-use-model-in-deepgenomescan-framework-can-be-found-herehttpsxinghuq-github-iodeepgenomescanarticlesdeepgenomescan_model_list-html" class="section level4">
<h4 class="hasAnchor">
<a href="#mlp-model-implementation-with-default-seting--details-about-the-ready-to-use-model-in-deepgenomescan-framework-can-be-found-herehttpsxinghuq-github-iodeepgenomescanarticlesdeepgenomescan_model_list-html" class="anchor"></a>MLP model implementation with default seting. Details about the ready-to-use model in DeepGenomeScan framework can be found here:<a href="https://xinghuq.github.io/DeepGenomeScan/articles/DeepGenomeScan_model_list.html" class="uri">https://xinghuq.github.io/DeepGenomeScan/articles/DeepGenomeScan_model_list.html</a>
</h4>
<div class="sourceCode"><pre class="downlit">
<span class="co">### using the available model in DeepGenomeScan</span>
 <span class="va">mlp_scan</span><span class="op">&lt;-</span><span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">geno_impu</span><span class="op">)</span>,y<span class="op">=</span><span class="op">(</span><span class="va">klfdapcmat</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>,
                               method<span class="op">=</span><span class="st">"mlp"</span>,
                               metric <span class="op">=</span> <span class="st">"MAE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                               tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### 11 tunable parameters 11^2</span>
                               <span class="co"># , ### or search 100 combinations of parameters using random tuneLength=100</span>
                               verbose<span class="op">=</span><span class="fl">0</span>,<span class="co"># verbose=1 is reporting the progress,o is sclience</span>
                               trControl <span class="op">=</span> <span class="va">econtrol1</span>,importance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>


<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">klfdapcmat</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">mlp_scan1</span><span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">geno_norm</span>,<span class="va">klfdapcmat</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>,
                               method<span class="op">=</span><span class="st">"mlp"</span>,
                               metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                               tuneLength <span class="op">=</span> <span class="fl">50</span>, <span class="co">### 11 tunable parameters 11^2</span>
                               <span class="co"># , ### or search 100 combinations of parameters using random tuneLength=100</span>
                               verbose<span class="op">=</span><span class="fl">0</span>,<span class="co"># verbose=1 is reporting the progress,o is sclience</span>
                               trControl <span class="op">=</span> <span class="va">econtrol1</span>,importance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">mlp_scan1</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim1_"</span>,<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">klfdapcmat</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpRSNNSDecay_klfdapcmat_Model.RData"</span><span class="op">)</span><span class="op">)</span>
<span class="va">RSNNS_simimp1</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/NeuralNetTools/man/olden.html">olden</a></span><span class="op">(</span><span class="va">mlp_scan1</span><span class="op">$</span><span class="va">finalModel</span>,bar_plot<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">RSNNS_simimp1</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim1_"</span>,<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">klfdapcmat</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpRSNNSDecay_klfdapcmat_importance.RData"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">RSNNS_simimp1</span><span class="op">$</span><span class="va">importance</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">klfdapcmat</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpRSNNSDecay_imp.csv"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">mlp_scan1</span><span class="op">$</span><span class="va">results</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">klfdapcmat</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_model_RSNNSDecay_klfdapcmati_tuning.csv"</span><span class="op">)</span><span class="op">)</span>

<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"mlp_scan_klfdapcmat1_sim_test_Final.RData"</span><span class="op">)</span></pre></div>
</div>
<div id="calculating-p-valuesq-values-and-plot-manhattan-plot" class="section level4">
<h4 class="hasAnchor">
<a href="#calculating-p-valuesq-values-and-plot-manhattan-plot" class="anchor"></a>Calculating p-values/q-values and plot Manhattan plot</h4>
<div class="sourceCode"><pre class="downlit">
<span class="va">Loci</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"Neutral"</span>, <span class="fl">1000</span><span class="op">)</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">11</span>,<span class="fl">21</span>,<span class="fl">31</span>,<span class="fl">41</span>,<span class="fl">51</span>,<span class="fl">61</span>,<span class="fl">71</span>,<span class="fl">81</span>,<span class="fl">91</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL1"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">101</span>,<span class="fl">111</span>,<span class="fl">121</span>,<span class="fl">131</span>,<span class="fl">141</span>,<span class="fl">151</span>,<span class="fl">161</span>,<span class="fl">171</span>,<span class="fl">181</span>,<span class="fl">191</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL2"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">201</span>,<span class="fl">211</span>,<span class="fl">221</span>,<span class="fl">231</span>,<span class="fl">241</span>,<span class="fl">251</span>,<span class="fl">261</span>,<span class="fl">271</span>,<span class="fl">281</span>,<span class="fl">291</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL3"</span>

<span class="va">scaled_imp</span><span class="op">=</span><span class="fu">normalizeData</span><span class="op">(</span><span class="va">RSNNS_simimp1</span><span class="op">$</span><span class="va">importance</span>,type <span class="op">=</span> <span class="st">"0_1"</span><span class="op">)</span>
<span class="va">SNPimp</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span>, MLP<span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/H2OFrame.html">log10</a></span><span class="op">(</span><span class="va">scaled_imp</span><span class="op">)</span>,Loci<span class="op">=</span><span class="va">Loci</span><span class="op">)</span>

<span class="va">Selected_Loci</span><span class="op">=</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">Loci</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span>

<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span>, y<span class="op">=</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">MLP</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"gray83"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">MLP</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, colour <span class="op">=</span> <span class="va">Selected_Loci</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"SNP (with maf &gt; 0.05)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"MLP -log10(q-values)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">10</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">p2</span></pre></div>
</div>
<div id="h2o-implementation" class="section level4">
<h4 class="hasAnchor">
<a href="#h2o-implementation" class="anchor"></a>h2o implementation</h4>
</div>
<div id="lets-build-and-train-a-deep-learning-modoel-using-h2o-package-which-also-provide-several-other-good-algorthms-such-as-glmnet-gradient-boosting-machines-" class="section level4">
<h4 class="hasAnchor">
<a href="#lets-build-and-train-a-deep-learning-modoel-using-h2o-package-which-also-provide-several-other-good-algorthms-such-as-glmnet-gradient-boosting-machines-" class="anchor"></a>Let’s build and train a deep learning modoel using h2o package, which also provide several other good algorthms such as glmnet, Gradient Boosting Machines.</h4>
<div class="sourceCode"><pre class="downlit">
<span class="co"># The following two commands remove any previously installed H2O packages for R.</span>
<span class="kw">if</span> <span class="op">(</span><span class="st">"package:h2o"</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/search.html">search</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/detach.html">detach</a></span><span class="op">(</span><span class="st">"package:h2o"</span>, unload<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">}</span>
<span class="kw">if</span> <span class="op">(</span><span class="st">"h2o"</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/utils/remove.packages.html">remove.packages</a></span><span class="op">(</span><span class="st">"h2o"</span><span class="op">)</span> <span class="op">}</span>

<span class="co"># Next, we download packages that H2O depends on.</span>
<span class="va">pkgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"RCurl"</span>,<span class="st">"jsonlite"</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">pkg</span> <span class="kw">in</span> <span class="va">pkgs</span><span class="op">)</span> <span class="op">{</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span> <span class="op">(</span><span class="va">pkg</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="va">pkg</span><span class="op">)</span> <span class="op">}</span>
<span class="op">}</span>

<span class="co"># Now we download, install and initialize the H2O package for R.</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"h2o"</span>, type<span class="op">=</span><span class="st">"source"</span>, repos<span class="op">=</span><span class="st">"https://h2o-release.s3.amazonaws.com/h2o/rel-zeno/3/R"</span><span class="op">)</span>

<span class="co"># Finally, let's load H2O and start up an H2O cluster</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/h2oai/h2o-3">h2o</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.init.html">h2o.init</a></span><span class="op">(</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/h2oai/h2o-3">"h2o"</a></span><span class="op">)</span>
<span class="co">#start h2o</span>
<span class="va">localH2o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.init.html">h2o.init</a></span><span class="op">(</span>nthreads <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, max_mem_size <span class="op">=</span> <span class="st">"6G"</span><span class="op">)</span></pre></div>
<p>Gernerally, this approach takes longer time than adaptive cross-validation.</p>
<p>Compiling DL_h2o in DeepGenomeScan framework, for GUP version, please use H2O4GPU package. Note that different libraries have different data format/processing.</p>
<div class="sourceCode"><pre class="downlit">
<span class="va">econtrol1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span><span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"adaptive_cv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">999</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>warn<span class="op">=</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="va">model_h2o_mlp</span><span class="op">&lt;-</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>,<span class="va">env</span><span class="op">$</span><span class="va">envir1</span>,
                                  method<span class="op">=</span><span class="va">DL_h2o</span>,
                                  metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                                  tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### 11 tunable parameters 11^2</span>
                                  <span class="co"># , ### or search 100 combinations of parameters using random tuneLength=100</span>
                                  trControl <span class="op">=</span> <span class="va">econtrol1</span><span class="op">)</span>

<span class="co">#### There is a model specific varIMP for this model</span>
<span class="fu"><a href="../reference/varImp.html">varImp</a></span><span class="op">(</span><span class="va">model_h2o_mlp</span>,scale <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.varimp.html">h2o.varimp</a></span><span class="op">(</span><span class="va">model_h2o_mlp</span><span class="op">$</span><span class="va">finalModel</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">==</span> <span class="st">"scaled_importance"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Overall"</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">names</span>

<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"example_tutorial_Data.RData"</span><span class="op">)</span></pre></div>
</div>
<div id="cnn-example-using-tensorflow-or-keras" class="section level4">
<h4 class="hasAnchor">
<a href="#cnn-example-using-tensorflow-or-keras" class="anchor"></a>CNN example using Tensorflow or Keras</h4>
</div>
<div id="compiling-cnnsgd" class="section level4">
<h4 class="hasAnchor">
<a href="#compiling-cnnsgd" class="anchor"></a>Compiling CNNsgd</h4>
<div class="sourceCode"><pre class="downlit">
<span class="va">CNN_sgd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Convolutional Neural Network"</span>,
                  library <span class="op">=</span> <span class="st">"keras"</span>,
                  loop <span class="op">=</span> <span class="cn">NULL</span>,
                  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Regression'</span>, <span class="st">"Classification"</span><span class="op">)</span>,
                  parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                    parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"nFilter"</span>,<span class="st">"nStride"</span>,<span class="st">'lambda'</span>, <span class="st">"units1"</span>,<span class="st">"units2"</span>,<span class="st">"dropout"</span>,
                                  <span class="st">"activation1"</span>,<span class="st">"activation2"</span>,<span class="st">"activation3"</span><span class="op">)</span>,
                    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">'numeric'</span>, <span class="fl">6</span><span class="op">)</span>, <span class="st">"character"</span>,<span class="st">"character"</span>,<span class="st">"character"</span><span class="op">)</span>,
                    label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"no. of convolutions"</span>,<span class="st">"stride between convolutions"</span>,<span class="st">'L2 Regularization'</span>, <span class="st">"hidden_neurons1"</span>,<span class="st">"hidden_neurons2"</span>,
                              <span class="st">"drop_out_rates"</span>,<span class="st">"Activation Function convol layer"</span>,<span class="st">"Activation function dense hidden layer"</span>,<span class="st">"Activation function layer to output"</span><span class="op">)</span>
                  <span class="op">)</span>,
                  
                  grid <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">len</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">search</span> <span class="op">=</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">afuncs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sigmoid"</span>, <span class="st">"relu"</span>, <span class="st">"tanh"</span>,<span class="st">"linear"</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="va">search</span> <span class="op">==</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>nFilter<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span>,nStride<span class="op">=</span><span class="fl">3</span>,
                                         lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span> <span class="op">^</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">4</span>, length <span class="op">=</span> <span class="va">len</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,  units1 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, units2 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, dropout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.5</span>, length <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                         activation1 <span class="op">=</span> <span class="st">"relu"</span>,activation2<span class="op">=</span><span class="st">"sigmoid"</span>,activation3<span class="op">=</span><span class="st">"linear"</span>
                      <span class="op">)</span>
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                      <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>nFilter<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">10</span><span class="op">:</span><span class="fl">500</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,nStride<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">20</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                        lambda <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">)</span>,units1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="va">n</span><span class="op">*</span><span class="fl">2</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,units2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">n</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                        dropout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, max <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>,activation1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>,  size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,activation2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>,  size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, activation3 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>,  size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
                    <span class="op">}</span>
                    <span class="va">out</span>
                  <span class="op">}</span>,
                  
                  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">wts</span>, <span class="va">last</span>,<span class="va">lev</span>,<span class="va">param</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                    <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="http://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
                    <span class="va">K</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/backend.html">backend</a></span><span class="op">(</span><span class="op">)</span>
                    <span class="va">K</span><span class="op">$</span><span class="fu">clear_session</span><span class="op">(</span><span class="op">)</span>
                    <span class="co"># if(!is.matrix(x)) x &lt;- as.matrix(x)</span>
                    <span class="co">########## ### here should reshape the data################################# Note: the key step feed to the cnn</span>
                    <span class="va">x</span><span class="op">=</span><span class="fu">kerasR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kerasR/man/expand_dims.html">expand_dims</a></span><span class="op">(</span><span class="va">x</span>,axis<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
                    <span class="co">################  ###### also this define the shape of the tensor######  argument: input_shape    input_shape = c(nSNP,1)          </span>
                    <span class="va">nSNP</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
                    <span class="va">model</span><span class="op">&lt;-</span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
                      <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_1d.html">layer_conv_1d</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">nFilter</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>, strides<span class="op">=</span><span class="va">param</span><span class="op">$</span><span class="va">nStride</span>,activation <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation1</span><span class="op">)</span>,
                                           input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">nSNP</span>,<span class="fl">1</span><span class="op">)</span>,kernel_regularizer <span class="op">=</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l2</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
                      <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_max_pooling_1d.html">layer_max_pooling_1d</a></span><span class="op">(</span>pool_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># add pooling layer: takes maximum of two consecutive values</span>
                      <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_flatten.html">layer_flatten</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
                      <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span>rate<span class="op">=</span><span class="va">param</span><span class="op">$</span><span class="va">dropout</span><span class="op">)</span> <span class="op">%&gt;%</span>
                      <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">units1</span>, activation <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
                      <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">units2</span>, activation <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation3</span><span class="op">)</span><span class="op">)</span>
                    
                    
                    <span class="co">#                    model&lt;-keras::keras_model_sequential() %&gt;%</span>
                    <span class="co">#                      layer_conv_1d(filters = param$nFilter, kernel_size = c(3), strides=param$nStride,activation =as.character(param$activation1),</span>
                    <span class="co">#                                    input_shape = c(1000,1),kernel_regularizer = keras::regularizer_l2(param$lambda)) %&gt;%</span>
                    <span class="co">#                      layer_max_pooling_1d(pool_size = c( 2)) %&gt;% # add pooling layer: takes maximum of two consecutive values</span>
                    <span class="co">#                      layer_flatten() %&gt;%</span>
                    <span class="co">#                      layer_dropout(rate=param$dropout) %&gt;%</span>
                    <span class="co">#                      layer_dense(units = param$units1, activation =as.character(param$activation2)) %&gt;%</span>
                    <span class="co">#                      layer_dense(units = param$units2, activation =as.character(param$activation3))%&gt;% #### activation function of last layer</span>
                    <span class="co">#                      layer_dense(units = 1) ### this should be the same as the input shape: input_shape = c(nSNP,1)</span>
                    <span class="co">#more complex model</span>
                    <span class="co">#  model&lt;-keras::keras_model_sequential() %&gt;%</span>
                    <span class="co">#    keras::layer_conv_1d(filters=128, kernel_size = 3, strides=3,activation =as.character(param$activation1),</span>
                    <span class="co">#                  input_shape = c(nSNPs, 1),kernel_regularizer = keras::regularizer_l2(param$lambda)) %&gt;%</span>
                    <span class="co">#    layer_max_pooling_1d(pool_size = 2) %&gt;%</span>
                    <span class="co">#    layer_conv_1d(filters = 64, kernel_size =3, activation = as.character(param$activation1)) %&gt;%</span>
                    <span class="co">#    layer_flatten() %&gt;%</span>
                    <span class="co">#    layer_dropout(rate=param$dropout) %&gt;%</span>
                    <span class="co">#    layer_dense(units =param$units, activation = as.character(param$activation2))</span>
                    <span class="co">#Compile the model. Note that this linked above %&gt;% </span>
                    <span class="co">#   model%&gt;% compile(</span>
                    <span class="co">#     optimizer='sgd',</span>
                    <span class="co">#     loss='mean_squared_error',</span>
                    <span class="co">#     metrics='mean_squared_error')</span>
                    
                    
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/is.factor.html">is.factor</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/dummyVars.html">class2ind</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
                      <span class="va">model</span> <span class="op">%&gt;%</span> 
                        <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co">#### activation function of last layer</span>
                        <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/generics/man/compile.html">compile</a></span><span class="op">(</span>
                          loss <span class="op">=</span> <span class="st">"categorical_crossentropy"</span>,
                          optimizer <span class="op">=</span> <span class="st">"sgd"</span>,
                          metrics <span class="op">=</span> <span class="st">"accuracy"</span>
                        <span class="op">)</span>
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                      <span class="va">model</span> <span class="op">%&gt;%</span>
                        <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#### activation function of last layer</span>
                        <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/generics/man/compile.html">compile</a></span><span class="op">(</span>
                          loss <span class="op">=</span> <span class="st">"mean_squared_error"</span>,
                          optimizer <span class="op">=</span> <span class="st">"sgd"</span>,
                          metrics <span class="op">=</span> <span class="st">"mean_squared_error"</span>
                        <span class="op">)</span>
                    <span class="op">}</span>
                    
                    <span class="va">model</span> <span class="op">%&gt;%</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/generics/man/fit.html">fit</a></span><span class="op">(</span>
                      x <span class="op">=</span> <span class="va">x</span>, 
                      y <span class="op">=</span> <span class="va">y</span>,
                      kernel_regularizer <span class="op">=</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l2</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">lambda</span><span class="op">)</span>,
                      <span class="va">...</span>
                    <span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="va">last</span><span class="op">)</span>
                      <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/serialize_model.html">serialize_model</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">model</span><span class="op">)</span>
                  <span class="op">}</span>,
                  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">modelFit</span>, <span class="st">"raw"</span><span class="op">)</span><span class="op">)</span>
                      <span class="va">modelFit</span><span class="op">$</span><span class="va">object</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/serialize_model.html">unserialize_model</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">)</span>
                    <span class="co"># if(!is.matrix(newdata)) </span>
                    <span class="co"># newdata &lt;- as.matrix(newdata)</span>
                    <span class="va">newdata</span><span class="op">=</span><span class="fu">kerasR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kerasR/man/expand_dims.html">expand_dims</a></span><span class="op">(</span><span class="va">newdata</span>,axis<span class="op">=</span><span class="fl">2</span><span class="op">)</span> 
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/predict_on_batch.html">predict_on_batch</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">object</span>, <span class="va">newdata</span><span class="op">)</span>
                    <span class="co">## check for model type</span>
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">modelFit</span><span class="op">$</span><span class="va">obsLevels</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">out</span>, <span class="fl">1</span>, <span class="va">which.max</span><span class="op">)</span><span class="op">]</span>
                    <span class="op">}</span>
                    <span class="va">out</span>
                  <span class="op">}</span>,
                  prob <span class="op">=</span>  <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">modelFit</span>, <span class="st">"raw"</span><span class="op">)</span><span class="op">)</span>
                      <span class="va">modelFit</span><span class="op">$</span><span class="va">object</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/serialize_model.html">unserialize_model</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">)</span>
                    <span class="co"># if(!is.matrix(newdata)) </span>
                    <span class="co">#newdata &lt;- as.matrix(newdata)</span>
                    <span class="va">newdata</span><span class="op">=</span><span class="fu">kerasR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kerasR/man/expand_dims.html">expand_dims</a></span><span class="op">(</span><span class="va">newdata</span>,axis<span class="op">=</span><span class="fl">2</span><span class="op">)</span> 
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/predict_on_batch.html">predict_on_batch</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">object</span>, <span class="va">newdata</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">modelFit</span><span class="op">$</span><span class="va">obsLevels</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">out</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                  <span class="op">}</span>,
                  varImp <span class="op">=</span> <span class="cn">NULL</span>,<span class="co">### CNN importance will estimate separately</span>
                  tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">" CNN"</span>, <span class="st">"L2 Regularization"</span><span class="op">)</span>,
                  sort <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">nFilter</span>, <span class="op">-</span><span class="va">x</span><span class="op">$</span><span class="va">lambda</span><span class="op">)</span>,<span class="op">]</span>,
                  notes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"After `train` completes, the keras model object is serialized"</span>,
                                <span class="st">"so that it can be used between R session. When predicting, the"</span>, 
                                <span class="st">"code will temporarily unsearalize the object. To make the"</span>, 
                                <span class="st">"predictions more efficient, the user might want to use "</span>, 
                                <span class="st">"`keras::unsearlize_model(object$finalModel$object)` in the current"</span>, 
                                <span class="st">"R session so that that operation is only done once."</span>,
                                <span class="st">"Also, this model cannot be run in parallel due to"</span>,
                                <span class="st">"the nature of how tensorflow does the computations."</span>,
                                
                                <span class="st">"Unlike other packages used by `train`, the `dplyr`"</span>,
                                <span class="st">"package is fully loaded when this model is used."</span><span class="op">)</span>,
                  check <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pkg</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">testmod</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span>,
                                   silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">testmod</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span>
                      <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Could not start a sequential model. "</span>,
                           <span class="st">"`tensorflow` might not be installed. "</span>,
                           <span class="st">"See `?install_tensorflow`."</span>, 
                           call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
                    <span class="cn">TRUE</span>
                  <span class="op">}</span><span class="op">)</span>


<span class="va">econtrol1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span><span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"repeatedcv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>
<span class="va">genotype_norm</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">genotype</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span><span class="op">)</span>
<span class="va">model_Keras_CNN</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span>x<span class="op">=</span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>,y<span class="op">=</span><span class="op">(</span><span class="va">env</span><span class="op">$</span><span class="va">envir1</span><span class="op">)</span>,
                                 method<span class="op">=</span><span class="va">CNNsgd</span>,
                                 metric <span class="op">=</span> <span class="st">"MAE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared"</span>
                                 tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### 11 tunable parameters 11^2</span>
                                 <span class="co"># , ### or search 100 combinations of parameters using random tuneLength=100</span>
                                 verbose<span class="op">=</span><span class="fl">0</span>,<span class="co"># verbose=1 is reporting the progress,o is sclience</span>
                                 trControl <span class="op">=</span> <span class="va">econtrol1</span>,importance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></pre></div>
</div>
<div id="permutation-varimp-importance" class="section level4">
<h4 class="hasAnchor">
<a href="#permutation-varimp-importance" class="anchor"></a>permutation varimp importance</h4>
<div class="sourceCode"><pre class="downlit">
<span class="va">optmodel</span><span class="op">=</span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/serialize_model.html">unserialize_model</a></span><span class="op">(</span><span class="va">model_Keras_CNN</span><span class="op">$</span><span class="va">finalModel</span><span class="op">$</span><span class="va">object</span><span class="op">)</span>
<span class="va">optmodel</span>
<span class="va">pred</span> <span class="op">=</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/predict_on_batch.html">predict_on_batch</a></span><span class="op">(</span><span class="va">optmodel</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">feature_names</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">genotype</span><span class="op">)</span>


<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">doParallel</span><span class="op">)</span>
<span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makePSOCKcluster</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>
<span class="va">Tensor_sim_imp_cnn</span><span class="op">=</span><span class="fu"><a href="../reference/CNN_varIMP_permute.html">CNN_varIMP_permute</a></span><span class="op">(</span><span class="va">optmodel</span>,
                                  <span class="va">feature_names</span>,
                                  train_y<span class="op">=</span><span class="va">env</span><span class="op">$</span><span class="va">envir1</span>,
                                  train_x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>,
                                  <span class="co">#smaller_is_better = FALSE,</span>
                                  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"difference"</span>, <span class="st">"ratio"</span><span class="op">)</span>,
                                  nsim <span class="op">=</span> <span class="fl">10</span>,<span class="co">## MCMC permutation large numbers need much more time</span>
                                  sample_size <span class="op">=</span> <span class="cn">NULL</span>,
                                  sample_frac <span class="op">=</span> <span class="cn">NULL</span>,
                                  verbose <span class="op">=</span> <span class="cn">FALSE</span>,
                                  progress <span class="op">=</span> <span class="st">"none"</span>,
                                  parallel <span class="op">=</span> <span class="cn">TRUE</span>,
                                  paropts <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>


<span class="va">Tensor_sim_imp_NULL_cnn</span><span class="op">=</span><span class="fu"><a href="../reference/CNN_varIMP_NULL_model.html">CNN_varIMP_NULL_model</a></span><span class="op">(</span><span class="va">optmodel</span>,
                                          <span class="va">feature_names</span>,
                                          train_y<span class="op">=</span><span class="va">env</span><span class="op">$</span><span class="va">envir1</span>,
                                          train_x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>,
                                          <span class="co">#smaller_is_better = FALSE,</span>
                                          type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"difference"</span>, <span class="st">"ratio"</span><span class="op">)</span>,
                                          nsim <span class="op">=</span> <span class="fl">10</span>,<span class="co">## MCMC permutation large numbers need much more time</span>
                                          sample_size <span class="op">=</span> <span class="cn">NULL</span>,
                                          sample_frac <span class="op">=</span> <span class="cn">NULL</span>,
                                          verbose <span class="op">=</span> <span class="cn">FALSE</span>,
                                          progress <span class="op">=</span> <span class="st">"none"</span>,
                                          parallel <span class="op">=</span> <span class="cn">TRUE</span>,
                                          paropts <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>
<span class="fu">registerDoSEQ</span><span class="op">(</span><span class="op">)</span>
<span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>

<span class="va">VarImps_permcnn</span><span class="op">=</span><span class="va">Tensor_sim_imp_cnn</span><span class="op">$</span><span class="va">CNN_Decrease_acc</span>
<span class="va">VarImps_nullcnn</span><span class="op">=</span><span class="va">Tensor_sim_imp_NULL_cnn</span><span class="op">$</span><span class="va">CNN_Decrease_acc</span>

<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"CNN_Sim1_env1_test.RData"</span><span class="op">)</span></pre></div>
<p>The above tutorial shows some machine learning, especially deep learning based method for detecting natural selection. The basic step is to construct a model first and compile it with DeepGenomeScan framework, then do genome scan to calculate the SNP importance. Finally we use the importance values to identify the outliers as the candidate loci under selection.</p>
<p>Some examples run very long time, so we did not show all the results, users can implement these methods on your own machine.</p>
<p>Please email <a href="mailto:qinxinghu@gmail.com">qinxinghu@gmail.com</a> if you have any questions when you use this package and if you found bugs.</p>
<p>Welcome contribute more frameworks and models to DeepGenomeScan.</p>
</div>
</div>
<div id="reference" class="section level3">
<h3 class="hasAnchor">
<a href="#reference" class="anchor"></a>Reference</h3>
<p>R. A. Maronna and R. H. Zamar (2002) Robust estimates of location and dispersion of high-dimensional datasets. Technometrics 44 (4), 307–317.</p>
<p>Wang, J., Zamar, R., Marazzi, A., Yohai, V., Salibian-Barrera, M., Maronna, R., … &amp; Maechler, M. (2017). robust: Port of the S+“Robust Library”. R package version 0.4-18. Available online at: <a href="https://CRAN" class="uri">https://CRAN</a>. R-project. org/package= robust.</p>
<p>Abadi, M., Barham, P., Chen, J., Chen, Z., Davis, A., Dean, J., … &amp; Kudlur, M. (2016). Tensorflow: A system for large-scale machine learning. In 12th {USENIX} symposium on operating systems design and implementation ({OSDI} 16) (pp. 265-283).</p>
<p>Bergmeir, C. N., &amp; Benítez Sánchez, J. M. (2012). Neural networks in R using the Stuttgart neural network simulator: RSNNS. American Statistical Association.</p>
<p>Beck, M. W. (2018). NeuralNetTools: Visualization and analysis tools for neural networks. Journal of statistical software, 85(11), 1.</p>
<p>Candel, A., Parmar, V., LeDell, E., &amp; Arora, A. (2016). Deep learning with H2O. H2O. ai Inc.</p>
<p>Deane-Mayer, Z. A., &amp; Knowles, J. E. (2016). caretEnsemble: ensembles of caret models. R package version, 2(0).</p>
<p>Gulli, A., &amp; Pal, S. (2017). Deep learning with Keras. Packt Publishing Ltd.</p>
<p>Klima, G. (2016). FCNN4R: Fast Compressed Neural Networks for R. R package version 0.6, 2.</p>
<p>Kuhn, M. (2015). Caret: classification and regression training. ascl, ascl-1505.</p>
<p>Gevrey, M., Dimopoulos, I., &amp; Lek, S. (2003). Review and comparison of methods to study the contribution of variables in artificial neural network models. Ecological modelling, 160(3), 249-264.</p>
<p>Xiao, Nan, and Qing-Song Xu. 2015. “Multi-Step Adaptive Elastic-Net: Reducing False Positives in High-Dimensional Variable Selection.” Journal of Statistical Computation and Simulation 85 (18): 3755–65.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Xinghu Qin.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
