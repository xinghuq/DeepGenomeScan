<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deep Learning Architecture Construction and Genome Scan Implementation Using DeeGenomeScan • DeepGenomeScan</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Deep Learning Architecture Construction and Genome Scan Implementation Using DeeGenomeScan">
<meta property="og:description" content="DeepGenomeScan">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-158177382-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-158177382-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">DeepGenomeScan</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/home.html">Home</a>
</li>
<li>
  <a href="../articles/index.html">Tutorials</a>
</li>
<li>
  <a href="../reference/index.html">Manual</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/xinghuq/DeepGenomeScan/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Deep Learning Architecture Construction and Genome Scan Implementation Using DeeGenomeScan</h1>
                        <h4 class="author">Xinghu Qin</h4>
            
            <h4 class="date">7/11/2020</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/xinghuq/DeepGenomeScan/blob/master/vignettes/Deep%20Learning%20Architecture%20Construction.Rmd"><code>vignettes/Deep Learning Architecture Construction.Rmd</code></a></small>
      <div class="hidden name"><code>Deep Learning Architecture Construction.Rmd</code></div>

    </div>

    
    
<div id="deepgenomescan-for-detecting-natural-selection" class="section level2">
<h2 class="hasAnchor">
<a href="#deepgenomescan-for-detecting-natural-selection" class="anchor"></a>DeepGenomeScan for detecting natural selection</h2>
<p>DeepGenomeScan implements the genome scan and genome-wide association studies via deep learing. DeepGenomeScan particularly good at detecting the subtle and weak signatures that are hard to identify by the common linear approaches, such as linear model, generalized linear model (GLM), PCA, RDA, LFMM, etc. DeepGenomeScan has several ready-to-use models constructed with typical architectures supported by different backends. As deep neural networks are highly computationally costly, choosing or constructing the architecture of deep learning depends on users’ data and computation demand. Therefore, if you know well about R or good at programming, we recommend you constructing your own model based on your demand.</p>
<p>In what follows, we provide the step-by-step deep learning architecture construction and genome scan implementation using DeepGenomeScan.</p>
<p>Install packages and dependences</p>
<div class="sourceCode"><pre class="downlit">

<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"DeepGenomeScan"</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/remotes/man/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"xinghuq/DeepGenomeScan"</span><span class="op">)</span>

<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"KLFDAPC"</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/remotes/man/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"xinghuq/KLFDAPC"</span><span class="op">)</span>

<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"caret"</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/remotes/man/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"xinghuq/CaretPlus/pkg/caret"</span><span class="op">)</span>

<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"tensorflow"</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"tenforflow"</span><span class="op">)</span>

<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"keras"</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"keras"</span><span class="op">)</span>

<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"caretEnsemble"</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"caretEnsemble"</span><span class="op">)</span>

<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"RNNS"</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"RNNS"</span><span class="op">)</span>

<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"RNNS"</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"RNNS"</span><span class="op">)</span></pre></div>
<p>Our package incorporates several most commonly used deep learning libaries, such as Tensorflow, keras, RNNS, H2o, FCNN4R. This tutorial will show you how to construct your own deep learning model, tune the model, and get the SNP importance scores.</p>
<div class="sourceCode"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/xinghuq/DeepGenomeScan">DeepGenomeScan</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/">caret</a></span><span class="op">)</span><span class="co">### for ML calling functions and performance estimation</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com">keras</a></span><span class="op">)</span> <span class="co">### for DL</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/tensorflow">tensorflow</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/zachmayer/caretEnsemble">caretEnsemble</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/statsmaths/kerasR">kerasR</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">NeuralNetTools</span><span class="op">)</span></pre></div>
<div id="preparing-example-data" class="section level3">
<h3 class="hasAnchor">
<a href="#preparing-example-data" class="anchor"></a>Preparing example data</h3>
<p>The data used here is a single simulated data containing 640 individuals with 1000 SNPs that is assumed under the environmnetal selection. There are 10 environmental factors selecting 3 QTLs on these population with different gradients. Details about the simulated data can be found in Capblancq et al. 2018 (<a href="https://doi.org/10.1111/1755-0998.12906" class="uri">https://doi.org/10.1111/1755-0998.12906</a>).</p>
<div class="sourceCode"><pre class="downlit">
<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">'extdata'</span>,package<span class="op">=</span><span class="st">'DeepGenomeScan'</span><span class="op">)</span>
<span class="va">infile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">f</span>, <span class="st">"sim1.csv"</span><span class="op">)</span>
<span class="va">sim_example</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="va">infile</span><span class="op">)</span>
<span class="va">genotype</span><span class="op">=</span><span class="va">sim_example</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">14</span><span class="op">)</span><span class="op">]</span>
<span class="va">env</span><span class="op">=</span><span class="va">sim_example</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fl">11</span><span class="op">]</span>
<span class="co">#str(sim_example)</span></pre></div>
</div>
<div id="basic-model-architecture-construction" class="section level3">
<h3 class="hasAnchor">
<a href="#basic-model-architecture-construction" class="anchor"></a>Basic model architecture construction</h3>
<p>The principal steps for implementing user-defined model are, first constructing the model architecture and compiling the model to make sure the basic model works; and then integrating the model to DeepGenomeScan framework. Below, we construct a MLP model and complie it using keras.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">###################################### example of MLP_keras_drop out##########################</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>warn<span class="op">=</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>
<span class="va">nSNP</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">genotype</span><span class="op">)</span> 
<span class="co">#### first, construct the model architecture and compile the model</span>
<span class="co">### Below is a MLP model with three hidden layers, at each hidden layer, there are units, activation, and bach size to configure and tune, and in the optimizer, there are also some hyperparameters to configure and tune.</span>

<span class="va">model</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">100</span>, activation <span class="op">=</span> <span class="st">"sigmoid"</span>, input_shape <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span>rate <span class="op">=</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">50</span>, activation <span class="op">=</span> <span class="st">"tanh"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span>rate <span class="op">=</span><span class="fl">0.4</span><span class="op">)</span> 

  <span class="va">model</span> <span class="op">%&gt;%</span> 
    <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units<span class="op">=</span><span class="fl">1</span>, activation <span class="op">=</span> <span class="st">"linear"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/generics/man/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="st">"mean_squared_error"</span>,
      optimizer <span class="op">=</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_rmsprop.html">optimizer_rmsprop</a></span><span class="op">(</span>lr <span class="op">=</span><span class="fl">0.01</span>, rho<span class="op">=</span> <span class="fl">0.02</span>, decay <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span>, <span class="co">### Set the optimizer, here is a rmsprop opimizer with learning rate decay</span>
      metrics <span class="op">=</span> <span class="st">"mean_squared_error"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>

<span class="co">## alternative using sgd  #Compile the model</span>
<span class="co">#     model%&gt;% compile(</span>
<span class="co">#    optimizer='sgd',</span>
<span class="co">#    loss='mean_squared_error',</span>
<span class="co">#     metrics='mean_squared_error')</span>
<span class="co"># Model: "sequential"</span>
<span class="co"># ___________________________________________________________________________</span>
<span class="co"># Layer (type)                     Output Shape                  Param #     </span>
<span class="co"># ===========================================================================</span>
<span class="co"># dense (Dense)                    (None, 100)                   100100      </span>
<span class="co"># ___________________________________________________________________________</span>
<span class="co"># dropout (Dropout)                (None, 100)                   0           </span>
<span class="co"># ___________________________________________________________________________</span>
<span class="co"># dense_1 (Dense)                  (None, 50)                    5050        </span>
<span class="co"># ___________________________________________________________________________</span>
<span class="co"># dropout_1 (Dropout)              (None, 50)                    0           </span>
<span class="co"># ___________________________________________________________________________</span>
<span class="co"># dense_2 (Dense)                  (None, 1)                     51          </span>
<span class="co"># ===========================================================================</span>
<span class="co"># Total params: 105,201</span>
<span class="co"># Trainable params: 105,201</span>
<span class="co"># Non-trainable params: 0</span>
<span class="co"># ___________________________________________________________________________</span></pre></div>
<p>This is the summary of the MLP model with learning rate decay.</p>
<p>lr float &gt;= 0. Learning rate.</p>
<p>rho float &gt;= 0. Decay factor.</p>
<p>decay float &gt;= 0. Learning rate decay over each update.</p>
</div>
<div id="compiling-model-using-deepgenomescan" class="section level3">
<h3 class="hasAnchor">
<a href="#compiling-model-using-deepgenomescan" class="anchor"></a>Compiling model using DeepGenomeScan</h3>
<p>Compiling the deep learning model using DeepGenomeScan requires user to store four key components for the model: 1.Model parameters and tuning values, 2.deep learning model architecture and fitted model, 3.model predict method/function or probability estimation (optional), 4.importance function.</p>
<p>In terms of the (1) model parameters and tuning values, users should set their own model parameters, parameter labels, tuning methods (grid or random search), and the range of the parameter values if using grid search or the rule to search the parameter space if using random search based on the architecture of the model. With respect to (2) deep learning model architecture and fitted model, users should put their compiled (working) model (including the fitted model) under the same data list. In addition, users should also write the predict function for model tuning and importance function for estimating SNP importance after the optimal model is returned. All these components should be stored/structured according to the below instruction.</p>
<p>In what folllows, we construct a MLP model and use DeepGenomeScan framework to compile it.</p>
</div>
<div id="keras-example" class="section level3">
<h3 class="hasAnchor">
<a href="#keras-example" class="anchor"></a>Keras example</h3>
<div class="sourceCode"><pre class="downlit">

<span class="co">########################### compile with the MLP DeepGenomeScan</span>


<span class="va">modelmlpkerasdropout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Multilayer Perceptron Network"</span>,
                  library <span class="op">=</span> <span class="st">"keras"</span>,
                  loop <span class="op">=</span> <span class="cn">NULL</span>,
                  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Regression'</span>, <span class="st">"Classification"</span><span class="op">)</span>,
                  parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                    parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'units1'</span>,<span class="st">"units2"</span>, <span class="st">'dropout1'</span>,<span class="st">"dropout2"</span>,<span class="st">"batch_size"</span>,
                                  <span class="st">"lr"</span>, <span class="st">"rho"</span>, <span class="st">"decay"</span>, <span class="st">"activation1"</span>,<span class="st">"activation2"</span>,
                                  <span class="st">"activation3"</span><span class="op">)</span>,
                    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">'numeric'</span>, <span class="fl">8</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"character"</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>,
                    label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Number of hidden Units1'</span>, <span class="st">'Number of hidden Units2'</span>,<span class="st">'Dropout Rate1'</span>,<span class="st">'Dropout Rate2'</span>, 
                              <span class="st">"Batch Size"</span>, <span class="st">"Learning Rate"</span>,
                              <span class="st">"Rho"</span>, <span class="st">"Learning Rate Decay"</span>,
                              <span class="st">"Activation Function1"</span>,<span class="st">"Activation Function2"</span>,<span class="st">"Activation Function3"</span><span class="op">)</span>
                  <span class="op">)</span>,
                  grid <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">len</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">search</span> <span class="op">=</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">afuncs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sigmoid"</span>, <span class="st">"relu"</span>, <span class="st">"tanh"</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="va">search</span> <span class="op">==</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>
                        units1 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, 
                        units2<span class="op">=</span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">5</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, 
                        dropout1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.5</span>, length <span class="op">=</span> <span class="va">len</span><span class="op">)</span>, <span class="co">### dropout rate will give warning if it is larger than 0.5</span>
                        dropout1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.5</span>, length <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                        batch_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>,
                        lr <span class="op">=</span> <span class="fl">2e-6</span>,
                        rho <span class="op">=</span> <span class="fl">.8</span>,
                        decay <span class="op">=</span> <span class="fl">0</span>,
                        activation1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sigmoid"</span>, <span class="st">"relu"</span>, <span class="st">"tanh"</span><span class="op">)</span>, <span class="co">### softmax is usually used for classification</span>
                        activation2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sigmoid"</span>, <span class="st">"relu"</span>, <span class="st">"tanh"</span><span class="op">)</span>,
                        activation3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sigmoid"</span>, <span class="st">"relu"</span>, <span class="st">"tanh"</span><span class="op">)</span>
                      <span class="op">)</span>
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                      <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                        units1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>, <span class="co">### can be 0:100, so that can be 0 in a layer</span>
                        units2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">50</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,<span class="co">### can be 0:100, so that can be 0 in a layer</span>
                       <span class="co">## if you need, set the last layer as units3: units3 = sample(2:25, replace = TRUE, size = len),</span>
                        dropout1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, max <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>,
                       dropout2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, max <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>, 
                        batch_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, min <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span><span class="op">)</span>,
                        lr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span>,
                        rho <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span>,
                        decay <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>, <span class="fl">0</span><span class="op">)</span>,
                        activation1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                       activation2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                       activation3 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                       <span class="op">)</span>
                    <span class="op">}</span>
                    <span class="va">out</span>
                  <span class="op">}</span>,
                  
                  <span class="co">### construct MLP model</span>
                  
                fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">wts</span>, <span class="va">param</span>, <span class="va">lev</span>, <span class="va">last</span>, <span class="va">classProbs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                    <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="http://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
                    <span class="va">K</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/backend.html">backend</a></span><span class="op">(</span><span class="op">)</span>
                    <span class="va">K</span><span class="op">$</span><span class="fu">clear_session</span><span class="op">(</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">is.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
                    <span class="va">model</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span> 
                    <span class="va">model</span> <span class="op">%&gt;%</span>
                    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">units1</span>, activation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation1</span><span class="op">)</span>, input_shape <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
                    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">dropout1</span>,seed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
                    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">units2</span>, activation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation2</span><span class="op">)</span><span class="op">)</span><span class="op">%&gt;%</span>
                    <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span>rate <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">dropout2</span>,seed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> 
                   
                     <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/dummyVars.html">class2ind</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
                      <span class="va">model</span> <span class="op">%&gt;%</span> 
                        <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>
                          units <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">lev</span><span class="op">)</span>, 
                          activation <span class="op">=</span> <span class="st">'softmax'</span>
                        <span class="op">)</span> <span class="op">%&gt;%</span>
                        <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/generics/man/compile.html">compile</a></span><span class="op">(</span>
                          loss <span class="op">=</span> <span class="st">"categorical_crossentropy"</span>,
                          optimizer <span class="op">=</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_rmsprop.html">optimizer_rmsprop</a></span><span class="op">(</span>
                            lr <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">lr</span>,
                            rho <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">rho</span>,
                            decay <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">decay</span>
                          <span class="op">)</span>,
                          metrics <span class="op">=</span> <span class="st">"accuracy"</span>
                        <span class="op">)</span>
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                      <span class="va">model</span> <span class="op">%&gt;%</span> 
                        <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1</span>, activation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation3</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
                        <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/generics/man/compile.html">compile</a></span><span class="op">(</span>
                          loss <span class="op">=</span> <span class="st">"mean_squared_error"</span>,
                          optimizer <span class="op">=</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_rmsprop.html">optimizer_rmsprop</a></span><span class="op">(</span>
                            lr <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">lr</span>,
                            rho <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">rho</span>,
                            decay <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">decay</span>
                          <span class="op">)</span>,
                          metrics <span class="op">=</span> <span class="st">"mean_squared_error"</span>
                        <span class="op">)</span>
                    <span class="op">}</span>
                      <span class="co">## alternative using sgd  #Compile the model</span>
                 <span class="co">#     model%&gt;% compile(</span>
                    <span class="co">#    optimizer='sgd',</span>
                    <span class="co">#    loss='mean_squared_error',</span>
                   <span class="co">#     metrics='mean_squared_error')</span>
                    
                  
                    <span class="va">model</span> <span class="op">%&gt;%</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/generics/man/fit.html">fit</a></span><span class="op">(</span>
                      x <span class="op">=</span> <span class="va">x</span>, 
                      y <span class="op">=</span> <span class="va">y</span>,
                      batch_size <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">batch_size</span>,
                      <span class="va">...</span>
                    <span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="va">last</span><span class="op">)</span>
                      <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/serialize_model.html">serialize_model</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">model</span><span class="op">)</span>
                  <span class="op">}</span>,
                  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">object</span>, <span class="st">"raw"</span><span class="op">)</span><span class="op">)</span>
                      <span class="va">modelFit</span><span class="op">$</span><span class="va">object</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/serialize_model.html">unserialize_model</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">object</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">is.matrix</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span><span class="op">)</span> 
                      <span class="va">newdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">object</span>, <span class="va">newdata</span><span class="op">)</span>
                    <span class="co">## check for model type</span>
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">modelFit</span><span class="op">$</span><span class="va">obsLevels</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">out</span>, <span class="fl">1</span>, <span class="va">which.max</span><span class="op">)</span><span class="op">]</span>
                    <span class="op">}</span>
                    <span class="va">out</span>
                  <span class="op">}</span>,
                  prob <span class="op">=</span>  <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">object</span>, <span class="st">"raw"</span><span class="op">)</span><span class="op">)</span>
                      <span class="va">modelFit</span><span class="op">$</span><span class="va">object</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/serialize_model.html">unserialize_model</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">object</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">is.matrix</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span><span class="op">)</span> 
                      <span class="va">newdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">object</span>, <span class="va">newdata</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">modelFit</span><span class="op">$</span><span class="va">obsLevels</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">out</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                  <span class="op">}</span>,
                  varImp <span class="op">=</span> <span class="cn">NULL</span>,<span class="co">### see the importance for this model will implement after model tuning to save the time.</span>
                  tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Neural Network"</span><span class="op">)</span>,
                  sort <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">units1</span>, <span class="va">x</span><span class="op">$</span><span class="va">units2</span>,<span class="va">x</span><span class="op">$</span><span class="va">dropout1</span>,<span class="va">x</span><span class="op">$</span><span class="va">dropout2</span><span class="op">)</span>,<span class="op">]</span>,
                  notes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"After `train` completes, the keras model object is serialized"</span>,
                                <span class="st">"so that it can be used between R session. When predicting, the"</span>, 
                                <span class="st">"code will temporarily unsearalize the object. To make the"</span>, 
                                <span class="st">"predictions more efficient, the user might want to use "</span>, 
                                <span class="st">"`keras::unsearlize_model(object$finalModel$object)` in the current"</span>, 
                                <span class="st">"R session so that that operation is only done once."</span>,
                                <span class="st">"Also, this model cannot be run in parallel due to"</span>,
                                <span class="st">"the nature of how tensorflow does the computations."</span>,
                                
                                <span class="st">"Unlike other packages used by `train`, the `dplyr`"</span>,
                                <span class="st">"package is fully loaded when this model is used."</span><span class="op">)</span>,
                  check <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pkg</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">testmod</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span>,
                                   silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">testmod</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span>
                      <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Could not start a sequential model. "</span>,
                           <span class="st">"`tensorflow` might not be installed. "</span>,
                           <span class="st">"See `?install_tensorflow`."</span>, 
                           call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
                    <span class="cn">TRUE</span>
                  <span class="op">}</span><span class="op">)</span>


<span class="co">###### Now we carry out the model tuning to find the optimal model </span>

<span class="co">## setting cross validation methods and parameter search method</span>
<span class="va">econtrol1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span><span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"repeatedcv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>

<span class="co">## Normalize the genotype data</span>
<span class="va">normalize</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">genotype_norm</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">genotype</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span><span class="op">)</span>

<span class="co">### Doing DeepGenomeScan parameter tuning </span>
<span class="va">model_Keras_mlp</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="va">genotype_norm</span>,<span class="va">env</span><span class="op">$</span><span class="va">envir1</span>,
                                method<span class="op">=</span><span class="va">modelmlpkerasdropout</span>,
                                metric <span class="op">=</span> <span class="st">"MAE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared"</span>
                                tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### number of tunable parameters to search, here this example uses just 10 for saving time. Users should set a large number in order to find a better model</span>
                                <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
                                verbose<span class="op">=</span><span class="fl">0</span>,<span class="co"># verbose=1 is reporting the progress,o is sclience</span>
                                trControl <span class="op">=</span> <span class="va">econtrol1</span>,importance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co">####permutation varimp importance </span>

<span class="va">optmodel</span><span class="op">=</span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/serialize_model.html">unserialize_model</a></span><span class="op">(</span><span class="va">model_Keras_mlp</span><span class="op">$</span><span class="va">finalModel</span><span class="op">$</span><span class="va">object</span><span class="op">)</span>
<span class="va">optmodel</span>
<span class="va">pred</span> <span class="op">=</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/predict_on_batch.html">predict_on_batch</a></span><span class="op">(</span><span class="va">optmodel</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">feature_names</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">genotype</span><span class="op">)</span>


<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">doParallel</span><span class="op">)</span>
<span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makePSOCKcluster</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>
<span class="va">Tensor_sim_imp</span><span class="op">=</span><span class="fu"><a href="../reference/MLP_varIMP_permute.html">MLP_varIMP_permute</a></span><span class="op">(</span><span class="va">optmodel</span>,
                                  <span class="va">feature_names</span>,
                                  train_y<span class="op">=</span><span class="va">env</span><span class="op">$</span><span class="va">envir1</span>,
                                  train_x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>,
                                  <span class="co">#smaller_is_better = FALSE,</span>
                                  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"difference"</span>, <span class="st">"ratio"</span><span class="op">)</span>,
                                  nsim <span class="op">=</span> <span class="fl">10</span>,<span class="co">## MCMC permutation large numbers need much more time</span>
                                  sample_size <span class="op">=</span> <span class="cn">NULL</span>,
                                  sample_frac <span class="op">=</span> <span class="cn">NULL</span>,
                                  verbose <span class="op">=</span> <span class="cn">FALSE</span>,
                                  progress <span class="op">=</span> <span class="st">"none"</span>,
                                  parallel <span class="op">=</span> <span class="cn">TRUE</span>,
                                  paropts <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>


<span class="va">Tensor_sim_imp_NULL</span><span class="op">=</span><span class="fu"><a href="../reference/MLP_varIMP_NULL_model.html">MLP_varIMP_NULL_model</a></span><span class="op">(</span><span class="va">optmodel</span>,
                                  <span class="va">feature_names</span>,
                                  train_y<span class="op">=</span><span class="va">env</span><span class="op">$</span><span class="va">envir1</span>,
                                  train_x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>,
                                  <span class="co">#smaller_is_better = FALSE,</span>
                                  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"difference"</span>, <span class="st">"ratio"</span><span class="op">)</span>,
                                  nsim <span class="op">=</span> <span class="fl">10</span>,<span class="co">## MCMC permutation large numbers need much more time</span>
                                  sample_size <span class="op">=</span> <span class="cn">NULL</span>,
                                  sample_frac <span class="op">=</span> <span class="cn">NULL</span>,
                                  verbose <span class="op">=</span> <span class="cn">FALSE</span>,
                                  progress <span class="op">=</span> <span class="st">"none"</span>,
                                  parallel <span class="op">=</span> <span class="cn">TRUE</span>,
                                  paropts <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>
<span class="fu">registerDoSEQ</span><span class="op">(</span><span class="op">)</span>
<span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>

<span class="va">VarImps_perm</span><span class="op">=</span><span class="va">Tensor_sim_imp</span><span class="op">$</span><span class="va">MLP_Decrease_acc</span>
<span class="va">VarImps_null</span><span class="op">=</span><span class="va">Tensor_sim_imp_NULL</span><span class="op">$</span><span class="va">MLP_Decrease_acc</span>

<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"MLP_Sim1_env1_test.RData"</span><span class="op">)</span>
<span class="co">###################################### working end###############################################</span></pre></div>
<p>This is a complete process for doing deep learing based genome scan using user-defined model. Because keras uses python (tensorflow) as the backend, we recommend users configuring the python version of tensorflow and keras properly so that they are compatible with R before constructing this model.</p>
<p>Below is a model constructed using RSNNS library.</p>
</div>
<div id="rsnns-example" class="section level3">
<h3 class="hasAnchor">
<a href="#rsnns-example" class="anchor"></a>RSNNS example</h3>
<div class="sourceCode"><pre class="downlit">

<span class="co">###Note that we used number of neurons sampled with a range of 2:20 for the first, and 0:20 for the second and third in our available default model, here we changed a little bit as :sample(2:100, replace = TRUE, size = len), this will increase the computational complexility, users should increase the searching  number of parameters </span>

<span class="va">modelRSNNSmlpdecay</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Multi-Layer Perceptron, multiple layers"</span>,
                                   library <span class="op">=</span> <span class="st">"RSNNS"</span>,
                                   loop <span class="op">=</span> <span class="cn">NULL</span>,
                                   type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Regression'</span>, <span class="st">'Classification'</span><span class="op">)</span>,
                                   parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'layer1'</span>,<span class="st">'layer2'</span>,<span class="st">'layer3'</span>, <span class="st">'decay'</span>,<span class="st">"activation1"</span>,<span class="st">"activation2"</span><span class="op">)</span>,
                                                           class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'numeric'</span>,<span class="st">'numeric'</span>,<span class="st">'numeric'</span>, <span class="st">'numeric'</span>,<span class="st">"character"</span>,<span class="st">"character"</span><span class="op">)</span>,
                                                           label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'number of hidden Units layer1'</span>,<span class="st">'number of hidden Units layer2'</span>,<span class="st">'number of hidden Units layer3'</span>, <span class="st">'Weight Decay'</span>,<span class="st">"hiddenActFunc"</span>,<span class="st">"outputActFunc"</span><span class="op">)</span><span class="op">)</span>,
                                 
                           grid <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">len</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">search</span> <span class="op">=</span> <span class="st">"grid"</span><span class="op">)</span><span class="op">{</span>
                                     <span class="va">afuncs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Act_Logistic"</span>,<span class="st">"Act_TanH"</span>,<span class="st">"Act_RBF_Gaussian"</span>,<span class="st">"Act_IdentityPlusBias"</span><span class="op">)</span>
                                     <span class="kw">if</span><span class="op">(</span><span class="va">search</span> <span class="op">==</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                                       
                                       <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>layer1 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, layer2 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, layer3 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>,
                                                          decay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span> <span class="op">^</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">4</span>, length <span class="op">=</span> <span class="va">len</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,activation1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Act_Logistic"</span>,<span class="st">"Act_TanH"</span>,<span class="st">"Act_RBF_Gaussian"</span>,<span class="st">"Act_IdentityPlusBias"</span><span class="op">)</span>,activation2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Act_Logistic"</span>,<span class="st">"Act_TanH"</span>,<span class="st">"Act_RBF_Gaussian"</span>,<span class="st">"Act_IdentityPlusBias"</span><span class="op">)</span><span class="op">)</span>
                                     <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                                       <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>layer1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                                         layer2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                                         layer3 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                                         decay <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
                                                         activation1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                                                         activation2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                                                         <span class="op">)</span>
                                     <span class="op">}</span>
                                     <span class="va">out</span>
                                   <span class="op">}</span>,
                                   fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">wts</span>, <span class="va">param</span>, <span class="va">lev</span>, <span class="va">last</span>, <span class="va">classProbs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                                     <span class="va">theDots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
                                     <span class="va">theDots</span> <span class="op">&lt;-</span> <span class="va">theDots</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">theDots</span><span class="op">)</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"size"</span>,<span class="st">"linOut"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
                                     <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">theDots</span><span class="op">)</span> <span class="op">==</span> <span class="st">"learnFunc"</span><span class="op">)</span><span class="op">)</span>
                                     <span class="op">{</span>
                                       <span class="va">theDots</span><span class="op">$</span><span class="va">learnFunc</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
                                       <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"Cannot over-ride 'learnFunc' argument for this model. BackpropWeightDecay is used."</span><span class="op">)</span>
                                     <span class="op">}</span>
                                     <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">theDots</span><span class="op">)</span> <span class="op">==</span> <span class="st">"learnFuncParams"</span><span class="op">)</span><span class="op">)</span>
                                     <span class="op">{</span>
                                       <span class="va">prms</span> <span class="op">&lt;-</span> <span class="va">theDots</span><span class="op">$</span><span class="va">learnFuncParams</span>
                                       <span class="va">prms</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span>  <span class="va">param</span><span class="op">$</span><span class="va">decay</span>
                                       <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"Over-riding weight decay value in the 'learnFuncParams' argument you passed in. Other values are retained"</span><span class="op">)</span>
                                     <span class="op">}</span> <span class="kw">else</span> <span class="va">prms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="va">param</span><span class="op">$</span><span class="va">decay</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span><span class="op">)</span>
                                     
                                   <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                                      <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">RSNNS</span><span class="fu">:::</span><span class="fu"><a href="https://rdrr.io/pkg/RSNNS/man/decodeClassLabels.html">decodeClassLabels</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
                                       <span class="va">lin</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
                                    <span class="op">}</span> <span class="kw">else</span> <span class="va">lin</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>
                                     
                                     <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer1</span>, <span class="va">param</span><span class="op">$</span><span class="va">layer2</span>, <span class="va">param</span><span class="op">$</span><span class="va">layer3</span><span class="op">)</span>
                                     <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">nodes</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                                       <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="va">nodes</span><span class="op">[</span><span class="va">nodes</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span>
                                       <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span>
                                         <span class="st">"At least one layer had zero units and "</span>,
                                         <span class="st">"were removed. The new structure is "</span>,
                                         <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">nodes</span>, collapse <span class="op">=</span> <span class="st">"-&gt;"</span><span class="op">)</span>, call. <span class="op">=</span> <span class="cn">FALSE</span>
                                       <span class="op">)</span> 
                                     <span class="op">}</span>
                                    <span class="va">func1</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation1</span><span class="op">)</span>
                                    <span class="va">func2</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation2</span><span class="op">)</span>
                                     
                                     <span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>,
                                                  y <span class="op">=</span> <span class="va">y</span>,
                                                  learnFunc <span class="op">=</span> <span class="st">"BackpropWeightDecay"</span>,
                                                  learnFuncParams <span class="op">=</span> <span class="va">prms</span>,
                                                  hiddenActFunc <span class="op">=</span> <span class="va">func1</span>,
                                                  size <span class="op">=</span> <span class="va">nodes</span>,
                                                  outputActFunc <span class="op">=</span> <span class="va">func2</span>,
                                                  linOut <span class="op">=</span> <span class="va">lin</span><span class="op">)</span>
                                     <span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">args</span>, <span class="va">theDots</span><span class="op">)</span>
                                     <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="fu">RSNNS</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/RSNNS/man/mlp.html">mlp</a></span>, <span class="va">args</span><span class="op">)</span>
                                   <span class="op">}</span>,
                                   predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                                     <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span><span class="op">)</span>
                                     <span class="kw">if</span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">problemType</span> <span class="op">==</span> <span class="st">"Classification"</span><span class="op">)</span>
                                     <span class="op">{</span>
                                       <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">modelFit</span><span class="op">$</span><span class="va">obsLevels</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">out</span>, <span class="fl">1</span>, <span class="va">which.max</span><span class="op">)</span><span class="op">]</span>
                                     <span class="op">}</span> <span class="kw">else</span> <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
                                     <span class="va">out</span>
                                   <span class="op">}</span>,
                                   prob <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                                     <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span><span class="op">)</span>
                                     <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">modelFit</span><span class="op">$</span><span class="va">obsLevels</span>
                                     <span class="va">out</span>
                                   <span class="op">}</span>,
                                   levels <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">obsLevels</span>,
                                   tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Neural Network"</span>,<span class="st">"L2 Regularization"</span><span class="op">)</span>,
                                   sort <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">layer1</span>, <span class="va">x</span><span class="op">$</span><span class="va">layer2</span>, <span class="va">x</span><span class="op">$</span><span class="va">layer3</span>, <span class="op">-</span><span class="va">x</span><span class="op">$</span><span class="va">decay</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span>

<span class="co">### lower number of nerons could be easily fit the model, larger numbers require more time and searching sets to reach a disearable optimization</span>


<span class="va">econtrol1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span><span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"adaptive_cv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">999</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>warn<span class="op">=</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="va">normalize</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">genotype_norm</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">genotype</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">model_RSNNS_mlp</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>,<span class="va">env</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>,
                               method<span class="op">=</span><span class="va">modelRSNNSmlpdecay</span>,
                               metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                               tuneLength <span class="op">=</span> <span class="fl">50</span>, <span class="co">### search 50 parameter combinations, users should increase the tune length to find a better model</span>
                               <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
                               verbose<span class="op">=</span><span class="fl">0</span>,<span class="co"># verbose=1 is reporting the progress,o is sclience</span>
                               trControl <span class="op">=</span> <span class="va">econtrol1</span>,importance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">model_RSNNS_mlp</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim1_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpRSNNSDecay_env_Model.RData"</span><span class="op">)</span><span class="op">)</span>
<span class="va">RSNNS_simimp1</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/NeuralNetTools/man/olden.html">olden</a></span><span class="op">(</span><span class="va">model_RSNNS_mlp</span><span class="op">$</span><span class="va">finalModel</span>,bar_plot<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">RSNNS_simimp1</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim1_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpRSNNSDecay_env_importance.RData"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">RSNNS_simimp1</span><span class="op">$</span><span class="va">importance</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpRSNNSDecay_imp.csv"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">model_RSNNS_mlp</span><span class="op">$</span><span class="va">results</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_model_RSNNSDecay_envi_tuning.csv"</span><span class="op">)</span><span class="op">)</span>

<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"Model_RSNNS_mlp_env1_sim_test.RData"</span><span class="op">)</span></pre></div>
<p>This implementation is also not fast. After model tuning, we estimated the SNP importance score that under the selection of 10 environmental factors.</p>
</div>
<div id="plotting-manhattan-plot" class="section level3">
<h3 class="hasAnchor">
<a href="#plotting-manhattan-plot" class="anchor"></a>Plotting Manhattan plot</h3>
<div class="sourceCode"><pre class="downlit">
<span class="co">####</span>

<span class="va">Loci</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"Neutral"</span>, <span class="fl">1000</span><span class="op">)</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">11</span>,<span class="fl">21</span>,<span class="fl">31</span>,<span class="fl">41</span>,<span class="fl">51</span>,<span class="fl">61</span>,<span class="fl">71</span>,<span class="fl">81</span>,<span class="fl">91</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL1"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">101</span>,<span class="fl">111</span>,<span class="fl">121</span>,<span class="fl">131</span>,<span class="fl">141</span>,<span class="fl">151</span>,<span class="fl">161</span>,<span class="fl">171</span>,<span class="fl">181</span>,<span class="fl">191</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL2"</span>
<span class="va">Loci</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">201</span>,<span class="fl">211</span>,<span class="fl">221</span>,<span class="fl">231</span>,<span class="fl">241</span>,<span class="fl">251</span>,<span class="fl">261</span>,<span class="fl">271</span>,<span class="fl">281</span>,<span class="fl">291</span><span class="op">)</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"QTL3"</span>

<span class="co">### RSNNS_simimp is a dataframe containing all SNP importance values (10 importance for all SNPs) from 10 environmnetal factors, users should import the SNP importance into one dataset</span>

<span class="va">SNPimpq</span><span class="op">=</span><span class="fu"><a href="../reference/DLqvalues.html">DLqvalues</a></span><span class="op">(</span><span class="va">RSSNS_simimp</span>,K<span class="op">=</span><span class="fl">10</span><span class="op">)</span>
<span class="va">SNPimp</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span>, MLP<span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">SNPimpq</span><span class="op">)</span>,Loci<span class="op">=</span><span class="va">Loci</span><span class="op">)</span>
<span class="va">Selected_Loci</span><span class="op">=</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">Loci</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span>

<span class="co">## Plotting Manhattan plot</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span>, y<span class="op">=</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">MLP</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">Loci</span><span class="op">!=</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"gray83"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">index</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">MLP</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">SNPimp</span><span class="op">$</span><span class="va">Loci</span><span class="op">==</span><span class="st">"Neutral"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, colour <span class="op">=</span> <span class="va">Selected_Loci</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">xlab</span><span class="op">(</span><span class="st">"SNP (with maf &gt; 0.05)"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ylab</span><span class="op">(</span><span class="st">"MLP -log10(q-values)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">10</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span>
<span class="va">p1</span></pre></div>
<p>Manhattan plot not show here because of exhaust time. Make sure increasing the tune length to find a good model.</p>
</div>
<div id="neuralnet-example" class="section level3">
<h3 class="hasAnchor">
<a href="#neuralnet-example" class="anchor"></a>Neuralnet example</h3>
<div class="sourceCode"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">NeuralNetTools</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"neuralnet"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bips-hb/neuralnet">neuralnet</a></span><span class="op">)</span> <span class="co">## v1.44.2 or earlier</span>
<span class="co">## using neuralnet###############################</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">neuraldat</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>

<span class="co">####################</span>
<span class="co">##custome two other activation functions, softplus and relu</span>

<span class="va">relu</span><span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">x</span>, <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">z</span><span class="op">)</span><span class="op">)</span>
<span class="va">relu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span> <span class="op">*</span> <span class="op">(</span><span class="va">x</span><span class="op">&gt;=</span><span class="fl">0</span><span class="op">)</span><span class="op">}</span>
<span class="va">relu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">x</span><span class="op">)</span><span class="op">}</span>
<span class="co">## however, it is not working for using max because of the derivative, However, regarding a sensible workaround, you could use softplus function which is a smooth approximation of the ReLU.</span>
<span class="co">###https://stackoverflow.com/questions/34532878/package-neuralnet-in-r-rectified-linear-unit-relu-activation-function</span>
<span class="va">k</span><span class="op">=</span><span class="fl">2</span>
<span class="va">customRelu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">*</span><span class="va">k</span><span class="op">*</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">}</span>  <span class="co">##https://en.wikipedia.org/wiki/Heaviside_step_function</span>
<span class="va">softplus</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>

<span class="co">### this architecture works well using the softpus function! </span>
<span class="co">### Note installing the GitHub version of the package can make "relu" function available, which updated Deriv (4.0 -&gt; 4.0.1) [CRAN]</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/remotes/man/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"bips-hb/neuralnet"</span><span class="op">)</span> <span class="co">### be courious about installing the developement version, this might slow you traing</span>

<span class="va">simf</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"envir1"</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sim_example</span><span class="op">[</span>,<span class="fl">15</span><span class="op">:</span><span class="fl">1014</span><span class="op">]</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">"~"</span><span class="op">)</span><span class="op">)</span>
<span class="co">### however, the softplus does work, siince I installed the development version, it doesn;t work, even I remove the development version and reinstall the default version,it seems doen't work</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">doParallel</span><span class="op">)</span>
<span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="fu">detectCores</span><span class="op">(</span><span class="op">)</span><span class="op">*</span><span class="fl">0.5</span><span class="op">)</span> <span class="co"># use 50% of cores only, leave rest for other tasks</span>
<span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>
<span class="va">multi_net1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neuralnet/man/neuralnet.html">neuralnet</a></span><span class="op">(</span><span class="va">simf</span>, algorithm<span class="op">=</span> <span class="st">"rprop+"</span>, data<span class="op">=</span><span class="va">sim_example</span>, hidden <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>,<span class="fl">9</span>,<span class="fl">10</span><span class="op">)</span> ,stepmax<span class="op">=</span><span class="fl">1e8</span>,rep<span class="op">=</span><span class="fl">1</span>, err.fct <span class="op">=</span> <span class="st">"sse"</span>,act.fct<span class="op">=</span><span class="st">"logistic"</span>,linear.output <span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="co">### it takes within a minute to finish and converge using the older version.</span>

<span class="va">multi_net2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neuralnet/man/neuralnet.html">neuralnet</a></span><span class="op">(</span><span class="va">simf</span>, algorithm<span class="op">=</span> <span class="st">"rprop+"</span>, data<span class="op">=</span><span class="va">sim_example</span>, hidden <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>,<span class="fl">9</span>,<span class="fl">10</span>,<span class="fl">11</span><span class="op">)</span> ,stepmax<span class="op">=</span><span class="fl">1e+11</span> ,rep<span class="op">=</span><span class="fl">1</span>, err.fct <span class="op">=</span> <span class="st">"sse"</span>,act.fct<span class="op">=</span><span class="va">softplus</span>,linear.output <span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="co">### it takes within a minute to finish and converge using the older version.</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">multi_net</span>,file <span class="op">=</span> <span class="st">"neuralnet_1_example_softplus.RData"</span><span class="op">)</span>

<span class="va">multi_net3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neuralnet/man/neuralnet.html">neuralnet</a></span><span class="op">(</span><span class="va">simf</span>, algorithm<span class="op">=</span> <span class="st">"rprop+"</span>, data<span class="op">=</span><span class="va">sim_example</span>, hidden <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>,<span class="fl">9</span>,<span class="fl">10</span>,<span class="fl">11</span><span class="op">)</span> ,stepmax<span class="op">=</span><span class="fl">1e+11</span> ,rep<span class="op">=</span><span class="fl">1</span>, err.fct <span class="op">=</span> <span class="st">"sse"</span>,act.fct<span class="op">=</span><span class="va">customRelu</span>,linear.output <span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="co">### it takes within a minute to finish and converge using the older version.</span>

<span class="co">### latest version can use relu </span>
<span class="va">multi_net4</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neuralnet/man/neuralnet.html">neuralnet</a></span><span class="op">(</span><span class="va">simf</span>, algorithm<span class="op">=</span> <span class="st">"rprop+"</span>, data<span class="op">=</span><span class="va">sim_example</span>, hidden <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>,<span class="fl">9</span>,<span class="fl">10</span>,<span class="fl">11</span><span class="op">)</span> ,stepmax<span class="op">=</span><span class="fl">1e9</span> ,rep<span class="op">=</span><span class="fl">1</span>, act.fct<span class="op">=</span><span class="st">"relu"</span>,output.act.fct<span class="op">=</span><span class="va">logistic</span>,linear.output <span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">### some cases,takes longer, I do not know why since I installed the developement version</span>
<span class="fu"><a href="https://rdrr.io/pkg/NeuralNetTools/man/olden.html">olden</a></span><span class="op">(</span><span class="va">multi_net1</span>,bar_plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>
<span class="fu">registerDoSEQ</span><span class="op">(</span><span class="op">)</span></pre></div>
<div class="sourceCode"><pre class="downlit">
<span class="co">### now we use self-defined smooth RELU function</span>
<span class="va">softplus</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="co">### indeed this function learns well with old version of neuralnet package. return to the older version if necessary which will have less hyperparameter (difficult to overfit with older version)</span>

<span class="co">### the default version neuralnet</span>

<span class="co">## there is no output function option for the default version, but linear out choice determines the output function </span>
<span class="va">mlpneuralnet0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Neural Network"</span>,
                      library <span class="op">=</span> <span class="st">"neuralnet"</span>,
                      loop <span class="op">=</span> <span class="cn">NULL</span>,
                      type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Regression'</span><span class="op">)</span>,
                      parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'layer1'</span>, <span class="st">'layer2'</span>, <span class="st">'layer3'</span>,<span class="st">"activation1"</span>,<span class="st">"linear.output"</span><span class="op">)</span>,
                                              class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'numeric'</span>, <span class="st">'numeric'</span>, <span class="st">'numeric'</span>,<span class="st">"character"</span>,<span class="st">"character"</span><span class="op">)</span>,
                                              label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Number of hidden Units in Layer 1'</span>, <span class="st">'number of hidden Units in Layer 2'</span>, <span class="st">'number of hidden Units in Layer 3'</span>,<span class="st">"Activation function in hidden layer"</span>,<span class="st">"Activation function linear out choice"</span><span class="op">)</span><span class="op">)</span>,
                      grid <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">len</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">search</span> <span class="op">=</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                        <span class="va">afuncs</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="st">"tanh"</span>,<span class="st">"softplus"</span><span class="op">)</span>
                        <span class="va">outputf</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"TRUE"</span>,<span class="st">"FALSE"</span><span class="op">)</span>
                        <span class="kw">if</span><span class="op">(</span><span class="va">search</span> <span class="op">==</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                          <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>layer1 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, layer2 <span class="op">=</span> <span class="fl">0</span>, layer3 <span class="op">=</span> <span class="fl">0</span>, activation1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="st">"tanh"</span>,<span class="st">"softplus"</span><span class="op">)</span>,linear.output<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"TRUE"</span>,<span class="st">"FALSE"</span><span class="op">)</span><span class="op">)</span>
                        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                          <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>layer1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">20</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                            layer2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                            layer3 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                            activation1<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                                            linear.output<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">outputf</span>,size <span class="op">=</span> <span class="va">len</span>,replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
                        <span class="op">}</span>
                        <span class="va">out</span>
                      <span class="op">}</span>,
                      fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">wts</span>, <span class="va">param</span>, <span class="va">lev</span>, <span class="va">last</span>, <span class="va">classProbs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                        <span class="va">colNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
                        <span class="va">dat</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">is.data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">x</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                        <span class="va">dat</span><span class="op">$</span><span class="va">.outcome</span> <span class="op">&lt;-</span> <span class="va">y</span>
                        <span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">".outcome ~"</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">colNames</span>, collapse <span class="op">=</span> <span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
                        <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer1</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"the first layer must have at least one hidden unit"</span><span class="op">)</span>
                        <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer2</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">param</span><span class="op">$</span><span class="va">layer2</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"the second layer must have at least one hidden unit if a third layer is specified"</span><span class="op">)</span>
                        <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer1</span><span class="op">)</span>
                        <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer2</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
                          <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">nodes</span>, <span class="va">param</span><span class="op">$</span><span class="va">layer2</span><span class="op">)</span>
                          <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer3</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">nodes</span>, <span class="va">param</span><span class="op">$</span><span class="va">layer3</span><span class="op">)</span>
                        <span class="op">}</span>
                        <span class="va">actf</span><span class="op">=</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation1</span><span class="op">)</span><span class="co">### note the difference in c(param$activation) for this model and other model, becaue the self-defined softplus function can't be a vector, so here we should not use c(,softplus)</span>
                        
                        <span class="va">linear.output</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">linear.output</span><span class="op">)</span>
                        <span class="fu">neuralnet</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/neuralnet/man/neuralnet.html">neuralnet</a></span><span class="op">(</span><span class="va">form</span>, algorithm<span class="op">=</span><span class="st">"rprop+"</span>,data <span class="op">=</span> <span class="va">dat</span>,rep<span class="op">=</span><span class="fl">1</span>, hidden <span class="op">=</span> <span class="va">nodes</span>, stepmax <span class="op">=</span> <span class="fl">1e8</span>, learningrate.factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>minus <span class="op">=</span> <span class="fl">0.5</span>,plus <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span>,act.fct<span class="op">=</span><span class="va">actf</span>,linear.output<span class="op">=</span><span class="va">linear.output</span>,<span class="va">...</span><span class="op">)</span>
                      <span class="op">}</span>,
                      predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                        <span class="va">newdata</span> <span class="op">&lt;-</span> <span class="va">newdata</span><span class="op">[</span>, <span class="va">modelFit</span><span class="op">$</span><span class="va">model.list</span><span class="op">$</span><span class="va">variables</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
                        <span class="fu">neuralnet</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/neuralnet/man/compute.html">compute</a></span><span class="op">(</span><span class="va">modelFit</span>, covariate <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span><span class="op">$</span><span class="va">net.result</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
                      <span class="op">}</span>,
                      prob <span class="op">=</span> <span class="cn">NULL</span>,
                      tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Neural Network"</span><span class="op">)</span>,
                      sort <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">layer1</span>, <span class="va">x</span><span class="op">$</span><span class="va">layer2</span>, <span class="va">x</span><span class="op">$</span><span class="va">layer3</span>,<span class="va">x</span><span class="op">$</span><span class="va">activation1</span>,<span class="va">x</span><span class="op">$</span><span class="va">linear.output</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span>

<span class="co">#####</span>
<span class="va">simf</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"envir1"</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sim_example</span><span class="op">[</span>,<span class="fl">15</span><span class="op">:</span><span class="fl">1014</span><span class="op">]</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">"~"</span><span class="op">)</span><span class="op">)</span>


<span class="va">model_neuralnet_mlp0</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="va">simf</span>,data<span class="op">=</span><span class="va">sim_example</span>,
                                    method<span class="op">=</span><span class="va">mlpneuralnet0</span>,weights <span class="op">=</span> <span class="cn">NULL</span>,
                                    metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                                    tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### 11 tunable parameters 11^2</span>
                                    <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
                                    trControl <span class="op">=</span> <span class="va">econtrol1</span><span class="op">)</span>
<span class="co">#### Varimp</span>
<span class="va">varimp_neuralnet1</span><span class="op">=</span><span class="fu">NeuralNetTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/NeuralNetTools/man/olden.html">olden</a></span><span class="op">(</span><span class="va">model_neuralnet_mlp0</span>,bar_plot <span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">model_neuralnet_mlp0</span>,file <span class="op">=</span> <span class="st">"model_neuralnet_mlp0.RData"</span><span class="op">)</span>

<span class="va">econtrol1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span><span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"adaptive_cv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">999</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>warn<span class="op">=</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="va">normalize</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">doParallel</span><span class="op">)</span>
<span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makeCluster</span><span class="op">(</span><span class="fu">detectCores</span><span class="op">(</span><span class="op">)</span><span class="op">*</span><span class="fl">0.5</span><span class="op">)</span> <span class="co"># use 50% of cores only, leave rest for other tasks</span>
<span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>


<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">simf</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sim_example</span><span class="op">[</span>,<span class="fl">15</span><span class="op">:</span><span class="fl">1014</span><span class="op">]</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">"~"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">model_neuralnet_mlp00</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="va">simf</span>,data<span class="op">=</span><span class="va">sim_example</span>,
                                       method<span class="op">=</span><span class="va">mlpneuralnet0</span>,
                                       metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                                       tuneLength <span class="op">=</span> <span class="fl">5</span>, <span class="co">### 11 tunable parameters 11^2</span>
                                       <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
                                       
                                       trControl <span class="op">=</span> <span class="va">econtrol1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">model_neuralnet_mlp00</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim1_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpneuralnet_env_Model0.RData"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">neuralnet_simimp0</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/NeuralNetTools/man/olden.html">olden</a></span><span class="op">(</span><span class="va">model_neuralnet_mlp00</span>,bar_plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">neuralnet_simimp0</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim1_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpneuralnet_env_importance0.RData"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">neuralnet_simimp0</span><span class="op">$</span><span class="va">importance</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpneuralnet_imp0.csv"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">model_neuralnet_mlp00</span><span class="op">$</span><span class="va">results</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_model_neuralnet_envi_tuning0.csv"</span><span class="op">)</span><span class="op">)</span>
  
<span class="op">}</span>

<span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>
<span class="fu">registerDoSEQ</span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"Sim1_modelneuralnet_mlp_test_Data0.RData"</span><span class="op">)</span></pre></div>
</div>
<div id="neuralnet-example-with-self-defined-activation-function" class="section level3">
<h3 class="hasAnchor">
<a href="#neuralnet-example-with-self-defined-activation-function" class="anchor"></a>Neuralnet example with self-defined activation function</h3>
<div class="sourceCode"><pre class="downlit">
<span class="co">#### example of neuralnet</span>
<span class="va">k</span><span class="op">=</span><span class="fl">2</span>
<span class="va">a</span><span class="op">=</span><span class="fl">0.8</span>
<span class="va">linear</span><span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">a</span><span class="op">*</span><span class="va">x</span>
<span class="va">customRelu</span> <span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span><span class="op">*</span><span class="va">k</span><span class="op">*</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">}</span> 
<span class="va">softplus</span> <span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> 

<span class="co">#### Note this architecture has whether the output activatioin is linear, some studies say linear is more effective for unbounded regression, when linear output is TRUE, the activation 2 is invalid</span>
<span class="co">### some time the simpler the faster and the better</span>
<span class="co">#### The developement version of neuralnet, which allows specifying the output function</span>
<span class="va">mlpneuralnet1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Neural Network"</span>,
                     library <span class="op">=</span> <span class="st">"neuralnet"</span>,
                     loop <span class="op">=</span> <span class="cn">NULL</span>,
                     type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Regression'</span><span class="op">)</span>,
                     parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'layer1'</span>, <span class="st">'layer2'</span>, <span class="st">'layer3'</span>,<span class="st">"activation1"</span>,<span class="st">"activation2"</span>,<span class="st">"linear.output"</span><span class="op">)</span>,
                                             class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'numeric'</span>, <span class="st">'numeric'</span>, <span class="st">'numeric'</span>,<span class="st">"character"</span>,<span class="st">"character"</span>,<span class="st">"character"</span><span class="op">)</span>,
                                             label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Number of hidden Units in Layer 1'</span>, <span class="st">'number of hidden Units in Layer 2'</span>, <span class="st">'number of hidden Units in Layer 3'</span>,<span class="st">"Activation function in hidden layer"</span>,<span class="st">"Activation function in output layer"</span>,<span class="st">"Activation function linear out choice"</span><span class="op">)</span><span class="op">)</span>,
                     grid <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">len</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">search</span> <span class="op">=</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                       <span class="va">afuncs</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="st">"tanh"</span>,<span class="st">"softplus"</span><span class="op">)</span>
                       <span class="va">outputf</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"TRUE"</span>,<span class="st">"FALSE"</span><span class="op">)</span>
                       <span class="kw">if</span><span class="op">(</span><span class="va">search</span> <span class="op">==</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                         <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>layer1 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, layer2 <span class="op">=</span> <span class="fl">0</span>, layer3 <span class="op">=</span> <span class="fl">0</span>, activation1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="st">"tanh"</span>,<span class="st">"softplus"</span><span class="op">)</span>,activation2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="st">"tanh"</span>,<span class="st">"softplus"</span><span class="op">)</span>,linear.output<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"TRUE"</span>,<span class="st">"FALSE"</span><span class="op">)</span><span class="op">)</span>
                       <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                         <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>layer1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">20</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                           layer2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                           layer3 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                           activation1<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                                           activation2<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                                           linear.output<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">outputf</span>,size <span class="op">=</span> <span class="va">len</span>,replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
                       <span class="op">}</span>
                       <span class="va">out</span>
                     <span class="op">}</span>,
                     fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">wts</span>, <span class="va">param</span>, <span class="va">lev</span>, <span class="va">last</span>, <span class="va">classProbs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                       <span class="va">colNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
                       <span class="va">dat</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">is.data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">x</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                       <span class="va">dat</span><span class="op">$</span><span class="va">.outcome</span> <span class="op">&lt;-</span> <span class="va">y</span>
                       <span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">".outcome ~"</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">colNames</span>, collapse <span class="op">=</span> <span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
                       <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer1</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"the first layer must have at least one hidden unit"</span><span class="op">)</span>
                       <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer2</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">param</span><span class="op">$</span><span class="va">layer2</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"the second layer must have at least one hidden unit if a third layer is specified"</span><span class="op">)</span>
                       <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer1</span><span class="op">)</span>
                       <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer2</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
                         <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">nodes</span>, <span class="va">param</span><span class="op">$</span><span class="va">layer2</span><span class="op">)</span>
                         <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer3</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">nodes</span>, <span class="va">param</span><span class="op">$</span><span class="va">layer3</span><span class="op">)</span>
                       <span class="op">}</span>
                       <span class="va">actf</span><span class="op">=</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation1</span><span class="op">)</span><span class="co">### note the difference in c(param$activation) for this model and other model, becaue the self-defined softplus function can't be a vector, so here we should not use c(,softplus)</span>
                       <span class="va">outputactf</span><span class="op">=</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation2</span><span class="op">)</span>
                       <span class="va">linear.output</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">linear.output</span><span class="op">)</span>
                       <span class="fu">neuralnet</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/neuralnet/man/neuralnet.html">neuralnet</a></span><span class="op">(</span><span class="va">form</span>, algorithm<span class="op">=</span><span class="st">"rprop+"</span>,data <span class="op">=</span> <span class="va">dat</span>,rep<span class="op">=</span><span class="fl">1</span>, hidden <span class="op">=</span> <span class="va">nodes</span>, stepmax <span class="op">=</span> <span class="fl">1e+09</span>, learningrate.factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>minus <span class="op">=</span> <span class="fl">0.5</span>,plus <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span>,act.fct<span class="op">=</span><span class="va">actf</span>,output.act.fct<span class="op">=</span><span class="va">outputactf</span>,linear.output<span class="op">=</span><span class="va">linear.output</span>,<span class="va">...</span><span class="op">)</span>
                     <span class="op">}</span>,
                     predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                       <span class="va">newdata</span> <span class="op">&lt;-</span> <span class="va">newdata</span><span class="op">[</span>, <span class="va">modelFit</span><span class="op">$</span><span class="va">model.list</span><span class="op">$</span><span class="va">variables</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
                       <span class="fu">neuralnet</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/neuralnet/man/compute.html">compute</a></span><span class="op">(</span><span class="va">modelFit</span>, covariate <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span><span class="op">$</span><span class="va">net.result</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
                     <span class="op">}</span>,
                     prob <span class="op">=</span> <span class="cn">NULL</span>,
                     tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Neural Network"</span><span class="op">)</span>,
                     sort <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">layer1</span>, <span class="va">x</span><span class="op">$</span><span class="va">layer2</span>, <span class="va">x</span><span class="op">$</span><span class="va">layer3</span>,<span class="va">x</span><span class="op">$</span><span class="va">activation1</span>,<span class="va">x</span><span class="op">$</span><span class="va">activation2</span>,<span class="va">x</span><span class="op">$</span><span class="va">linear.output</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span>

<span class="co">#####</span>
<span class="va">simf</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"envir1"</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sim_example</span><span class="op">[</span>,<span class="fl">15</span><span class="op">:</span><span class="fl">1014</span><span class="op">]</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">"~"</span><span class="op">)</span><span class="op">)</span>


<span class="va">model_neuralnet_mlp1</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="va">simf</span>,data<span class="op">=</span><span class="va">sim_example</span>,
                                   method<span class="op">=</span><span class="va">mlpneuralnet1</span>,
                                   metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                                   tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### 11 tunable parameters 11^2</span>
                                   <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
                                   trControl <span class="op">=</span> <span class="va">econtrol1</span><span class="op">)</span>
<span class="co">#### Varimp</span>
<span class="va">varimp_neuralnet1</span><span class="op">=</span><span class="fu">NeuralNetTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/NeuralNetTools/man/olden.html">olden</a></span><span class="op">(</span><span class="va">model_neuralnet_mlp</span>,bar_plot <span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>


<span class="va">econtrol1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span><span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"adaptive_cv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">999</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>warn<span class="op">=</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="va">normalize</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>


<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">simf</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sim_example</span><span class="op">[</span>,<span class="fl">15</span><span class="op">:</span><span class="fl">1014</span><span class="op">]</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">"~"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">model_neuralnet_mlp11</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="va">simf</span>,data<span class="op">=</span><span class="va">sim_example</span>,
                                     method<span class="op">=</span><span class="va">mlpneuralnet1</span>,
                                     metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                                     tuneLength <span class="op">=</span> <span class="fl">50</span>, <span class="co">### 11 tunable parameters 11^2</span>
                                     <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
                                     
                                     trControl <span class="op">=</span> <span class="va">econtrol1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">model_neuralnet_mlp11</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim1_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpneuralnet_env_Model.RData"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">neuralnet_simimp1</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/NeuralNetTools/man/olden.html">olden</a></span><span class="op">(</span><span class="va">model_neuralnet_mlp11</span>,bar_plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">neuralnet_simimp1</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim1_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpneuralnet_env_importance.RData"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">neuralnet_simimp1</span><span class="op">$</span><span class="va">importance</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpneuralnet_imp.csv"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">model_neuralnet_mlp11</span><span class="op">$</span><span class="va">results</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_model_neuralnet_envi_tuning.csv"</span><span class="op">)</span><span class="op">)</span>
  
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"Sim1_modelneuralnet_mlp_test_Data1.RData"</span><span class="op">)</span></pre></div>
</div>
<div id="neuralnet-example-with-the-latest-developed-version-of-relu-activation-function" class="section level3">
<h3 class="hasAnchor">
<a href="#neuralnet-example-with-the-latest-developed-version-of-relu-activation-function" class="anchor"></a>Neuralnet example with the latest developed version of relu activation function</h3>
<div class="sourceCode"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bips-hb/neuralnet">neuralnet</a></span><span class="op">)</span>
<span class="co">#### in our study we used softplus,as it is a smooth approximation of ReLU, below is an example of using the development version containing the relu function therefore, just specific ""relu</span>
<span class="co">#### I used the earlier version of neuralnet, which is faster than the current version. However, the latest version is more computational costly, i do not know whether there other changes of dependences on my computer or just the changes of computations for this package</span>
<span class="co">### The development version, as I noted from reoprters, in some cases, has error in extracting the weights. This could becasue the changes of data structure. Please chech the script to modify it. </span>
<span class="va">mlpneuralnet2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Neural Network"</span>,
                  library <span class="op">=</span> <span class="st">"neuralnet"</span>,
                  loop <span class="op">=</span> <span class="cn">NULL</span>,
                  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Regression'</span><span class="op">)</span>,
                  parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'layer1'</span>, <span class="st">'layer2'</span>, <span class="st">'layer3'</span>,<span class="st">"activation1"</span>,<span class="st">"activation2"</span><span class="op">)</span>,
                                          class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'numeric'</span>, <span class="st">'numeric'</span>, <span class="st">'numeric'</span>,<span class="st">"character"</span>,<span class="st">"character"</span><span class="op">)</span>,
                                          label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Number of hidden Units in Layer 1'</span>, <span class="st">'number of hidden Units in Layer 2'</span>, <span class="st">'number of hidden Units in Layer 3'</span>,<span class="st">"Activation function in hidden layer"</span>,<span class="st">"Activation function in output layer"</span><span class="op">)</span><span class="op">)</span>,
                  grid <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">len</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">search</span> <span class="op">=</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">afuncs</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="st">"tanh"</span>,<span class="st">"relu"</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="va">search</span> <span class="op">==</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>layer1 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, layer2 <span class="op">=</span> <span class="fl">0</span>, layer3 <span class="op">=</span> <span class="fl">0</span>, activation1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="st">"tanh"</span>,<span class="st">"relu"</span><span class="op">)</span>,activation2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"logistic"</span>, <span class="st">"tanh"</span>,<span class="st">"relu"</span><span class="op">)</span><span class="op">)</span>
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>layer1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">20</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                        layer2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                        layer3 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                        activation1<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                                        activation2<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
                    <span class="op">}</span>
                    <span class="va">out</span>
                  <span class="op">}</span>,
                  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">wts</span>, <span class="va">param</span>, <span class="va">lev</span>, <span class="va">last</span>, <span class="va">classProbs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">colNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
                    <span class="va">dat</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">is.data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">x</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                    <span class="va">dat</span><span class="op">$</span><span class="va">.outcome</span> <span class="op">&lt;-</span> <span class="va">y</span>
                    <span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">".outcome ~"</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">colNames</span>, collapse <span class="op">=</span> <span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer1</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"the first layer must have at least one hidden unit"</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer2</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">param</span><span class="op">$</span><span class="va">layer2</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"the second layer must have at least one hidden unit if a third layer is specified"</span><span class="op">)</span>
                    <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer1</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer2</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">nodes</span>, <span class="va">param</span><span class="op">$</span><span class="va">layer2</span><span class="op">)</span>
                      <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">layer3</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">nodes</span>, <span class="va">param</span><span class="op">$</span><span class="va">layer3</span><span class="op">)</span>
                    <span class="op">}</span>
                    <span class="va">actf</span><span class="op">=</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation1</span><span class="op">)</span><span class="co">### note the difference in c(param$activation) for this model and other model, becaue the self-defined softplus function can't be a vector, so here we should not use c(,softplus)</span>
                    <span class="va">outputactf</span><span class="op">=</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation2</span><span class="op">)</span>
                    <span class="fu">neuralnet</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/neuralnet/man/neuralnet.html">neuralnet</a></span><span class="op">(</span><span class="va">form</span>, algorithm<span class="op">=</span><span class="st">"rprop+"</span>,data <span class="op">=</span> <span class="va">dat</span>,rep<span class="op">=</span><span class="fl">1</span>, hidden <span class="op">=</span> <span class="va">nodes</span>, learningrate.factor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>minus <span class="op">=</span> <span class="fl">0.5</span>,plus <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span>,act.fct<span class="op">=</span><span class="va">actf</span>,output.act.fct<span class="op">=</span><span class="va">outputactf</span>,<span class="va">...</span><span class="op">)</span>
                  <span class="op">}</span>,
                  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">newdata</span> <span class="op">&lt;-</span> <span class="va">newdata</span><span class="op">[</span>, <span class="va">modelFit</span><span class="op">$</span><span class="va">model.list</span><span class="op">$</span><span class="va">variables</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
                    <span class="fu">neuralnet</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/neuralnet/man/compute.html">compute</a></span><span class="op">(</span><span class="va">modelFit</span>, covariate <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span><span class="op">$</span><span class="va">net.result</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
                  <span class="op">}</span>,
                  prob <span class="op">=</span> <span class="cn">NULL</span>,
                  tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Neural Network"</span><span class="op">)</span>,
                  sort <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">layer1</span>, <span class="va">x</span><span class="op">$</span><span class="va">layer2</span>, <span class="va">x</span><span class="op">$</span><span class="va">layer3</span>,<span class="va">x</span><span class="op">$</span><span class="va">activation1</span>,<span class="va">x</span><span class="op">$</span><span class="va">activation2</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span>

<span class="co">#####</span>
<span class="va">simf</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"envir1"</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sim_example</span><span class="op">[</span>,<span class="fl">15</span><span class="op">:</span><span class="fl">1014</span><span class="op">]</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">"~"</span><span class="op">)</span><span class="op">)</span>

<span class="va">model_neuralnet_mlp2</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="va">simf</span>,data<span class="op">=</span><span class="va">sim_example</span>,
                                   method<span class="op">=</span><span class="va">mlpneuralnet2</span>,
                                   metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                                   tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### 11 tunable parameters 11^2</span>
                                   <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
                                   trControl <span class="op">=</span> <span class="va">econtrol1</span><span class="op">)</span>
<span class="co">#### Varimp</span>
<span class="va">varimp_neuralnet</span><span class="op">=</span><span class="fu">NeuralNetTools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/NeuralNetTools/man/olden.html">olden</a></span><span class="op">(</span><span class="va">model_neuralnet_mlp2</span>,bar_plot <span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>


<span class="va">econtrol1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span><span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"adaptive_cv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">999</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>warn<span class="op">=</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="va">normalize</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>


<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">simf</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sim_example</span><span class="op">[</span>,<span class="fl">15</span><span class="op">:</span><span class="fl">1014</span><span class="op">]</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">"~"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">model_neuralnet_mlp22</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="va">simf</span>,data<span class="op">=</span><span class="va">sim_example</span>,
                                  method<span class="op">=</span><span class="va">mlpneuralnet2</span>,
                                  metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                                  tuneLength <span class="op">=</span> <span class="fl">50</span>, <span class="co">### 11 tunable parameters 11^2</span>
                                  <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
                                  
                                  trControl <span class="op">=</span> <span class="va">econtrol1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">model_neuralnet_mlp22</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim1_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpneuralnet_env_Model.RData"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">neuralnet_simimp2</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/NeuralNetTools/man/olden.html">olden</a></span><span class="op">(</span><span class="va">model_neuralnet_mlp22</span>,bar_plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">neuralnet_simimp2</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim1_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpneuralnet_env_importance.RData"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">neuralnet_simimp2</span><span class="op">$</span><span class="va">importance</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpneuralnet_imp.csv"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">model_neuralnet_mlp22</span><span class="op">$</span><span class="va">results</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_model_neuralnet_envi_tuning.csv"</span><span class="op">)</span><span class="op">)</span>
  
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"Sim1_modelneuralnet_mlp_test_Data2.RData"</span><span class="op">)</span></pre></div>
</div>
<div id="fcnn4r-example" class="section level3">
<h3 class="hasAnchor">
<a href="#fcnn4r-example" class="anchor"></a>FCNN4R example</h3>
<div class="sourceCode"><pre class="downlit">
<span class="co">###using FCNN4R</span>
<span class="co">#"sym_sigmoid" (and "tanh"), </span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">FCNN4R</span><span class="op">)</span> <span class="co">#### should install from source</span>
<span class="va">net</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_net.html">mlp_net</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">6</span>,<span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">net</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_rnd_weights.html">mlp_rnd_weights</a></span><span class="op">(</span><span class="va">net</span><span class="op">)</span>
<span class="fu">show</span><span class="op">(</span><span class="va">net</span><span class="op">)</span>
<span class="va">mlpFCNN4Rsgd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Multilayer Perceptron Network by Stochastic Gradient Descent"</span>,
                  library <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"FCNN4R"</span>, <span class="st">"plyr"</span><span class="op">)</span>,
                  loop <span class="op">=</span> <span class="cn">NULL</span>,
                  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Regression'</span>, <span class="st">"Classification"</span><span class="op">)</span>,
                  parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'units1'</span>,<span class="st">'units2'</span>, <span class="st">'l2reg'</span>, <span class="st">'lambda'</span>, <span class="st">"learn_rate"</span>, 
                                                        <span class="st">"momentum"</span>, <span class="st">"gamma"</span>, <span class="st">"minibatchsz"</span>, <span class="st">"repeats"</span>,<span class="st">"activation1"</span>,<span class="st">"activation2"</span><span class="op">)</span>,
                                          class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">'numeric'</span>, <span class="fl">9</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"character"</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>,
                                          label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Number of hidden Units1'</span>,<span class="st">'Number of hidden Units2'</span>, <span class="st">'L2 Regularization'</span>, 
                                                    <span class="st">'RMSE Gradient Scaling'</span>, <span class="st">"Learning Rate"</span>, 
                                                    <span class="st">"Momentum"</span>, <span class="st">"Learning Rate Decay"</span>, <span class="st">"Batch Size"</span>,
                                                    <span class="st">"#Models"</span>,<span class="st">'Activation function at hidden layer'</span>,<span class="st">'Activation function at output layer'</span><span class="op">)</span><span class="op">)</span>,
                  grid <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">len</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">search</span> <span class="op">=</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
                    <span class="va">afuncs</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"linear"</span>, <span class="st">"sigmoid"</span>, <span class="st">"tanh"</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="va">search</span> <span class="op">==</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>units1 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, 
                                         units2 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, 
                                         l2reg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span> <span class="op">^</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">4</span>, length <span class="op">=</span> <span class="va">len</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, 
                                         lambda <span class="op">=</span> <span class="fl">0</span>,
                                         learn_rate <span class="op">=</span> <span class="fl">2e-6</span>, 
                                         momentum <span class="op">=</span> <span class="fl">0.9</span>, 
                                         gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.9</span>, length <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                         minibatchsz <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>,
                                         repeats <span class="op">=</span> <span class="fl">1</span>,
                                         activation1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"linear"</span>, <span class="st">"sigmoid"</span>, <span class="st">"tanh"</span><span class="op">)</span>,
                                         activation2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"linear"</span>, <span class="st">"sigmoid"</span>, <span class="st">"tanh"</span><span class="op">)</span><span class="op">)</span>
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>units1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                        units2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                        l2reg <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">)</span>,
                                        lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, max <span class="op">=</span> <span class="fl">.4</span><span class="op">)</span>,
                                        learn_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span>,
                                        momentum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, min <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>,
                                        gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span>,
                                        minibatchsz <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, min <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span><span class="op">)</span>,
                                        repeats <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                        activation1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                                        activation2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
                    <span class="op">}</span>
                    <span class="va">out</span>
                  <span class="op">}</span>,
                  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">wts</span>, <span class="va">param</span>, <span class="va">lev</span>, <span class="va">last</span>, <span class="va">classProbs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">is.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">is.factor</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/dummyVars.html">class2ind</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
                      <span class="va">net</span> <span class="op">&lt;-</span> <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_net.html">mlp_net</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="va">param</span><span class="op">$</span><span class="va">units1</span>, <span class="va">param</span><span class="op">$</span><span class="va">units2</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
                      <span class="va">net</span> <span class="op">&lt;-</span> <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_set_activation.html">mlp_set_activation</a></span><span class="op">(</span><span class="va">net</span>, layer <span class="op">=</span> <span class="st">"h"</span>, activation <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">activation1</span><span class="op">)</span>
                      <span class="va">net</span> <span class="op">&lt;-</span> <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_set_activation.html">mlp_set_activation</a></span><span class="op">(</span><span class="va">net</span>, layer <span class="op">=</span> <span class="st">"o"</span>, activation <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">activation2</span><span class="op">)</span>
                      
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                      <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">y</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
                      <span class="va">net</span> <span class="op">&lt;-</span> <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_net.html">mlp_net</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="va">param</span><span class="op">$</span><span class="va">units1</span>,<span class="va">param</span><span class="op">$</span><span class="va">units2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
                      <span class="va">net</span> <span class="op">&lt;-</span> <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_set_activation.html">mlp_set_activation</a></span><span class="op">(</span><span class="va">net</span>, layer <span class="op">=</span> <span class="st">"h"</span>, activation <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">activation1</span><span class="op">)</span>
                      <span class="va">net</span> <span class="op">&lt;-</span> <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_set_activation.html">mlp_set_activation</a></span><span class="op">(</span><span class="va">net</span>, layer <span class="op">=</span> <span class="st">"o"</span>, activation <span class="op">=</span><span class="va">param</span><span class="op">$</span><span class="va">activation2</span><span class="op">)</span>
                    <span class="op">}</span>
                    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
                    <span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>net <span class="op">=</span> <span class="va">net</span>, 
                                 input <span class="op">=</span> <span class="va">x</span>, output <span class="op">=</span> <span class="va">y</span>, 
                                 learn_rate <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">learn_rate</span>,
                                 minibatchsz <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">minibatchsz</span>,
                                 l2reg <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">l2reg</span>,
                                 lambda <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">lambda</span>,
                                 gamma <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">gamma</span>,
                                 momentum <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">momentum</span><span class="op">)</span>
                    <span class="va">the_dots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> 
                    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">the_dots</span><span class="op">)</span> <span class="op">==</span> <span class="st">"tol_level"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                      <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> 
                        <span class="va">args</span><span class="op">$</span><span class="va">tol_level</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="kw">else</span>
                          <span class="va">args</span><span class="op">$</span><span class="va">tol_level</span> <span class="op">&lt;-</span> <span class="fl">.001</span>
                    <span class="op">}</span> 
                    
                    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">the_dots</span><span class="op">)</span> <span class="op">==</span> <span class="st">"max_epochs"</span><span class="op">)</span><span class="op">)</span> 
                      <span class="va">args</span><span class="op">$</span><span class="va">max_epochs</span> <span class="op">&lt;-</span> <span class="fl">1000</span>
                    <span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">args</span>, <span class="va">the_dots</span><span class="op">)</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"list"</span>, length <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">repeats</span><span class="op">)</span><span class="op">)</span>
                    <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">param</span><span class="op">$</span><span class="va">repeats</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">args</span><span class="op">$</span><span class="va">net</span> <span class="op">&lt;-</span> <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_rnd_weights.html">mlp_rnd_weights</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">net</span><span class="op">)</span>
                      <span class="va">out</span><span class="op">$</span><span class="va">models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="fu">FCNN4R</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_teach_sgd.html">mlp_teach_sgd</a></span>, <span class="va">args</span><span class="op">)</span>
                    <span class="op">}</span>
                    <span class="va">out</span>
                  <span class="op">}</span>,
                  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">is.matrix</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span><span class="op">)</span> <span class="va">newdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">models</span>, 
                                  <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">newdata</span><span class="op">)</span>
                                    <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_eval.html">mlp_eval</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">net</span>, input <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span>,
                                  newdata <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">problemType</span> <span class="op">==</span> <span class="st">"Classification"</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">out</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                      <span class="va">out</span><span class="op">$</span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">models</span><span class="op">)</span><span class="op">)</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/ddply.html">ddply</a></span><span class="op">(</span><span class="va">out</span>, <span class="fu">plyr</span><span class="fu">::</span><span class="fu">`.`</span><span class="op">(</span><span class="va">sample</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">modelFit</span><span class="op">$</span><span class="va">obsLevels</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">out</span>, <span class="fl">1</span>, <span class="va">which.max</span><span class="op">)</span><span class="op">]</span>
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> 
                        <span class="va">out</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>  <span class="kw">else</span> <span class="op">{</span>
                          <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"cbind"</span>, <span class="va">out</span><span class="op">)</span>
                          <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">out</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span>
                        <span class="op">}</span>
                    <span class="op">}</span>
                    <span class="va">out</span>
                  <span class="op">}</span>,
                  prob <span class="op">=</span>  <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">is.matrix</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span><span class="op">)</span> <span class="va">newdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">models</span>, 
                                  <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">newdata</span><span class="op">)</span>
                                    <span class="fu">FCNN4R</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/FCNN4R/man/mlp_eval.html">mlp_eval</a></span><span class="op">(</span><span class="va">obj</span><span class="op">$</span><span class="va">net</span>, input <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span>,
                                  newdata <span class="op">=</span> <span class="va">newdata</span><span class="op">)</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">out</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                    <span class="va">out</span><span class="op">$</span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">models</span><span class="op">)</span><span class="op">)</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/ddply.html">ddply</a></span><span class="op">(</span><span class="va">out</span>, <span class="fu">plyr</span><span class="fu">::</span><span class="fu">`.`</span><span class="op">(</span><span class="va">sample</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">out</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">modelFit</span><span class="op">$</span><span class="va">obsLevels</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">out</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                  <span class="op">}</span>,
                  varImp <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">models</span>, <span class="fu">caret</span><span class="fu">:::</span><span class="va">GarsonWeights_FCNN4R</span>, xnames <span class="op">=</span> <span class="va">object</span><span class="op">$</span><span class="va">xNames</span><span class="op">)</span>
                    <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">imps</span><span class="op">)</span>
                    <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">imps</span>, <span class="fl">1</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                    <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">imps</span><span class="op">)</span>, imp <span class="op">=</span> <span class="va">imps</span><span class="op">)</span>
                    <span class="va">imps</span> <span class="op">&lt;-</span> <span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/ddply.html">ddply</a></span><span class="op">(</span><span class="va">imps</span>, <span class="fu">plyr</span><span class="fu">::</span><span class="fu">`.`</span><span class="op">(</span><span class="va">var</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>Overall <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">imp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">imps</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">imps</span><span class="op">$</span><span class="va">var</span><span class="op">)</span>
                    <span class="va">imps</span><span class="op">$</span><span class="va">var</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
                    <span class="va">imps</span><span class="op">[</span><span class="va">object</span><span class="op">$</span><span class="va">xNames</span>,,drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>
                  <span class="op">}</span>,
                  tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Neural Network"</span>, <span class="st">"L2 Regularization"</span><span class="op">)</span>,
                  sort <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">units1</span>, <span class="va">x</span><span class="op">$</span><span class="va">units2</span>,<span class="op">-</span><span class="va">x</span><span class="op">$</span><span class="va">l2reg</span>, <span class="op">-</span><span class="va">x</span><span class="op">$</span><span class="va">gamma</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span>

<span class="co">##################</span>
<span class="va">model_FCNN4R_mlp</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>,<span class="va">env</span><span class="op">$</span><span class="va">envir1</span>,
                                method<span class="op">=</span><span class="va">mlpFCNN4Rsgd</span>,
                                metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                                tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### 11 tunable parameters 11^2</span>
                                <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
                                trControl <span class="op">=</span> <span class="va">econtrol1</span><span class="op">)</span>

<span class="co">#### There is a model specific varIMP for this model</span>
<span class="va">varimp_FCNN4</span><span class="op">=</span><span class="fu"><a href="../reference/varImp.html">varImp</a></span><span class="op">(</span><span class="va">model_FCNN4R_mlp</span>,scale <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="va">econtrol1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span><span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"adaptive_cv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">999</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>warn<span class="op">=</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="va">normalize</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">genotype_norm</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">genotype</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">model_FCNN4R_mlp</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>,<span class="va">env</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>,
                                 method<span class="op">=</span><span class="va">mlpFCNN4Rsgd</span>,
                                 metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                                 tuneLength <span class="op">=</span> <span class="fl">50</span>, <span class="co">### 11 tunable parameters 11^2</span>
                                 <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
                                
                                 trControl <span class="op">=</span> <span class="va">econtrol1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">model_FCNN4R_mlp</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim1_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpFCNN4R_env_Model.RData"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">FCNN4R_simimp1</span><span class="op">=</span><span class="fu"><a href="../reference/varImp.html">varImp</a></span><span class="op">(</span><span class="va">model_FCNN4R_mlp</span>,scale<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">FCNN4R_simimp1</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim1_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpFCNN4R_env_importance.RData"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">FCNN4R_simimp1</span><span class="op">$</span><span class="va">importance</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_mlpFCNN4R_imp.csv"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">model_FCNN4R_mlp</span><span class="op">$</span><span class="va">results</span>,file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"sim_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">"_model_FCNN4R_envi_tuning.csv"</span><span class="op">)</span><span class="op">)</span>
  
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"Sim1_modelFCNN4R_mlp_test_Data.RData"</span><span class="op">)</span></pre></div>
</div>
<div id="h2o-example" class="section level3">
<h3 class="hasAnchor">
<a href="#h2o-example" class="anchor"></a>h2o example</h3>
<p>Basic model construction and compiling.</p>
<div class="sourceCode"><pre class="downlit">

<span class="co">################################################################# h2o #####################</span>
<span class="co">#### H2o </span>
<span class="co">###Let build and train a deep learning modoel using h2o package, which also provide several other good algorthms such as glmnet, Gradient Boosting Machines.</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/h2oai/h2o-3">"h2o"</a></span><span class="op">)</span>
<span class="co">#start h2o</span>
<span class="va">localH2o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.init.html">h2o.init</a></span><span class="op">(</span>nthreads <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, max_mem_size <span class="op">=</span> <span class="st">"6G"</span><span class="op">)</span>

<span class="co">##### h2o already has its own framework that can train, tune, and optimize the model. Let's firt implements h2o's own framework.</span>

<span class="co">###Now, let's define a deep learning model with two hidden layers and test until it is working before pass to the framework.</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">is.data.frame</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">genotype_norm</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="kw">else</span> <span class="va">genotype_norm</span>
<span class="va">dat</span><span class="op">$</span><span class="va">.outcome</span> <span class="op">&lt;-</span> <span class="va">env</span><span class="op">$</span><span class="va">envir1</span>
<span class="va">frame_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"tmp_DL_h2o_dat_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fl">100000</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">tmp_train_dat</span> <span class="op">=</span> <span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.h2o.html">as.h2o</a></span><span class="op">(</span><span class="va">dat</span>, destination_frame <span class="op">=</span> <span class="va">frame_name</span><span class="op">)</span>

<span class="va">DL_model_h2o1</span><span class="op">=</span><span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.deeplearning.html">h2o.deeplearning</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>, y <span class="op">=</span> <span class="st">".outcome"</span>,
                      training_frame <span class="op">=</span> <span class="va">tmp_train_dat</span>,
                      standardize <span class="op">=</span> <span class="cn">T</span>,
                      model_id <span class="op">=</span> <span class="st">"deep_model"</span>,        
                      activation <span class="op">=</span> <span class="st">"TanhWithDropout"</span>, 
                      hidden<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">20</span><span class="op">)</span>,
                      epochs <span class="op">=</span> <span class="fl">100</span>,       
                      seed <span class="op">=</span> <span class="fl">123</span>,
                      variable_importances <span class="op">=</span> <span class="cn">T</span>,
                      l2<span class="op">=</span><span class="fl">0.05</span>,
                      stopping_metric<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/is.factor.html">is.factor</a></span><span class="op">(</span><span class="va">env</span><span class="op">$</span><span class="va">envir1</span><span class="op">)</span>, <span class="st">"misclassification"</span>, <span class="st">"RMSE"</span><span class="op">)</span>,
                      rho<span class="op">=</span><span class="fl">0.02</span><span class="op">)</span>

<span class="va">imp_h20_DL</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.varimp.html">h2o.varimp</a></span><span class="op">(</span><span class="va">DL_model_h2o1</span><span class="op">)</span>
<span class="co">#### good performance!!</span>
<span class="co">#compute variable importance and performance</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.varimp_plot.html">h2o.varimp_plot</a></span><span class="op">(</span><span class="va">DL_model_h2o1</span>,num_of_features <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.performance.html">h2o.performance</a></span><span class="op">(</span><span class="va">DL_model_h2o1</span>,xval <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>

<span class="co">###For hyperparameter tuning, we'll perform a random grid search over all parameters and choose the model which returns lowest error.  </span>

<span class="co">#set parameter space</span>
<span class="va">activation_h2o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Rectifier"</span>,<span class="st">"RectifierWithDropout"</span>, <span class="st">"Maxout"</span>,<span class="st">"MaxoutWithDropout"</span><span class="op">)</span>
<span class="va">hidden_h2o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>,<span class="fl">10</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">25</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">20</span>,<span class="fl">30</span>,<span class="fl">50</span><span class="op">)</span><span class="op">)</span>
<span class="va">l1_h2o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1e-2</span>,<span class="fl">1e-4</span><span class="op">)</span>
<span class="va">l2_h2o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1e-3</span>,<span class="fl">1e-5</span><span class="op">)</span>

<span class="va">hyper_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> activation<span class="op">=</span><span class="va">activation_h2o</span>,
                      hidden<span class="op">=</span><span class="va">hidden_h2o</span>,
                      l1<span class="op">=</span><span class="va">l1_h2o</span>,
                      l2<span class="op">=</span><span class="va">l2_h2o</span> <span class="op">)</span>
<span class="co">#set search criteria</span>
<span class="va">search_criteria</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>strategy <span class="op">=</span> <span class="st">"RandomDiscrete"</span>, max_models<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="co">#### mumber of models here is the number of hyperparamter combinations</span>

<span class="co">#train model</span>
<span class="va">dl_h2o_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.grid.html">h2o.grid</a></span><span class="op">(</span><span class="st">"deeplearning"</span> ,
                    grid_id <span class="op">=</span> <span class="st">"deep_learn"</span> ,
                    hyper_params <span class="op">=</span> <span class="va">hyper_params</span>,
                    search_criteria <span class="op">=</span> <span class="va">search_criteria</span>,
                    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>, y <span class="op">=</span> <span class="st">".outcome"</span>,
                    training_frame <span class="op">=</span> <span class="va">tmp_train_dat</span>,
                    nfolds <span class="op">=</span> <span class="fl">5</span>,epochs <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>

<span class="co">#get best model</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">dl_h2o_grid</span><span class="op">)</span>
<span class="va">d_h2o_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.getGrid.html">h2o.getGrid</a></span><span class="op">(</span><span class="st">"deep_learn"</span>,sort_by <span class="op">=</span> <span class="st">"RMSE"</span><span class="op">)</span>
<span class="va">best_dl_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.getModel.html">h2o.getModel</a></span><span class="op">(</span><span class="va">d_h2o_grid</span><span class="op">@</span><span class="va">model_ids</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.performance.html">h2o.performance</a></span><span class="op">(</span><span class="va">best_dl_model</span>,xval <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">imp_h20_DL</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.varimp.html">h2o.varimp</a></span><span class="op">(</span><span class="va">best_dl_model</span><span class="op">)</span>
<span class="co"># Fetch grid models</span>
<span class="va">model_ids_h2o</span> <span class="op">&lt;-</span> <span class="va">dl_h2o_grid</span><span class="op">@</span><span class="va">model_ids</span>
<span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">model_ids_h2o</span>, <span class="kw">function</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.getModel.html">h2o.getModel</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">}</span><span class="op">)</span>

<span class="va">predicted_h2o</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.predict.html">h2o.predict</a></span><span class="op">(</span><span class="va">best_dl_model</span>, <span class="va">tmp_train_dat</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/stats/cor.test.html">cor.test</a></span><span class="op">(</span><span class="va">env</span><span class="op">$</span><span class="va">envir1</span>,<span class="va">predicted_h2o</span><span class="op">)</span></pre></div>
<p>Model compiling using DeepGenomeScan.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">###### gernerally, this approach takes longer time than adaptive cross-validation</span>


<span class="co">### compile DL_h2o in DeepGenomeScan framework, for GUP version, please use H2O4GPU package</span>
<span class="co">#### different libraries have different data format/processing </span>

<span class="va">DL_h2o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"DL_h2o"</span>,
                  library <span class="op">=</span> <span class="st">"h2o"</span>,
                  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Regression"</span>, <span class="st">"Classification"</span><span class="op">)</span>,
                  parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'units1'</span>,<span class="st">'units2'</span>, <span class="st">'l2reg'</span>, <span class="st">"rho"</span>, <span class="st">"activation"</span><span class="op">)</span>,
                                          class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">'numeric'</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"character"</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
                                          label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Number of hidden Units1'</span>,<span class="st">'Number of hidden Units2'</span>, <span class="st">'L2 Regularization'</span>, 
                                                     <span class="st">"Adaptive learning rate time decay factor"</span>, 
                                                    <span class="st">'Activation function at hidden layer'</span><span class="op">)</span><span class="op">)</span>,
                  grid <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">len</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">search</span> <span class="op">=</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                    
                    <span class="va">afuncs</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Tanh"</span>, <span class="st">"TanhWithDropout"</span>, <span class="st">"Rectifier"</span>, <span class="st">"RectifierWithDropout"</span><span class="op">)</span>
                    
                    <span class="kw">if</span><span class="op">(</span><span class="va">search</span> <span class="op">==</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>units1 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, <span class="co">### two hidden layers</span>
                                         units2 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, 
                                          l2reg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span> <span class="op">^</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">4</span>, length <span class="op">=</span> <span class="va">len</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, 
                                          rho <span class="op">=</span> <span class="fl">2e-3</span>, 
                                          activation<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Tanh"</span>, <span class="st">"TanhWithDropout"</span>, <span class="st">"Rectifier"</span>, <span class="st">"RectifierWithDropout"</span><span class="op">)</span><span class="op">)</span>
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>units1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                        units2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                        l2reg <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">)</span>,
                                        rho <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span>,
                                        activation<span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>, size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
                    <span class="op">}</span>
                    <span class="va">out</span>
                  <span class="op">}</span>,
                  loop <span class="op">=</span> <span class="cn">NULL</span>,
                  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">wts</span>, <span class="va">param</span>, <span class="va">lev</span>, <span class="va">last</span>, <span class="va">classProbs</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                    
                    <span class="va">dat</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">is.data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">x</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="kw">else</span> <span class="va">x</span>
                    <span class="va">dat</span><span class="op">$</span><span class="va">.outcome</span> <span class="op">&lt;-</span> <span class="va">y</span>
                    <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>
                    <span class="va">frame_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"tmp_DL_h2o_dat_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fl">100000</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
                    <span class="va">tmp_train_dat</span> <span class="op">=</span> <span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.h2o.html">as.h2o</a></span><span class="op">(</span><span class="va">dat</span>, destination_frame <span class="op">=</span> <span class="va">frame_name</span><span class="op">)</span>
                    
                    <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">units1</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">units2</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">nodes</span>, <span class="va">param</span><span class="op">$</span><span class="va">units2</span><span class="op">)</span>
                    <span class="op">}</span>
                    <span class="va">acts</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation</span><span class="op">)</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.deeplearning.html">h2o.deeplearning</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y <span class="op">=</span> <span class="st">".outcome"</span>,
                                        training_frame <span class="op">=</span> <span class="va">tmp_train_dat</span>,
                                        standardize <span class="op">=</span> <span class="cn">F</span>,
                                       <span class="co"># model_id = "deep_model",        </span>
                                        activation <span class="op">=</span><span class="va">acts</span>, 
                                        hidden<span class="op">=</span><span class="va">nodes</span>,
                                        epochs <span class="op">=</span> <span class="fl">100</span>,       
                                        seed <span class="op">=</span> <span class="fl">123</span>,
                                        variable_importances <span class="op">=</span> <span class="cn">T</span>,
                                        l2<span class="op">=</span><span class="va">param</span><span class="op">$</span><span class="va">L2reg</span>,
                                        stopping_metric<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/is.factor.html">is.factor</a></span><span class="op">(</span><span class="va">env</span><span class="op">$</span><span class="va">envir1</span><span class="op">)</span>, <span class="st">"misclassification"</span>, <span class="st">"RMSE"</span><span class="op">)</span>,
                                        rho<span class="op">=</span><span class="va">param</span><span class="op">$</span><span class="va">rho</span>,<span class="va">...</span><span class="op">)</span>
                    <span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.getModel.html">h2o.getModel</a></span><span class="op">(</span><span class="va">out</span><span class="op">@</span><span class="va">model_id</span><span class="op">)</span>
                  <span class="op">}</span>,
                  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">frame_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"new_DL_h2o_dat_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fl">100000</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
                    <span class="va">newdata</span> <span class="op">&lt;-</span> <span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.h2o.html">as.h2o</a></span><span class="op">(</span><span class="va">newdata</span>, destination_frame <span class="op">=</span> <span class="va">frame_name</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.predict.html">h2o.predict</a></span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
                  <span class="op">}</span>,
                  prob <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">frame_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"new_DL_h2o_dat_"</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fl">100000</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
                    <span class="va">newdata</span> <span class="op">&lt;-</span> <span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/as.h2o.html">as.h2o</a></span><span class="op">(</span><span class="va">newdata</span>, destination_frame <span class="op">=</span> <span class="va">frame_name</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.predict.html">h2o.predict</a></span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>
                  <span class="op">}</span>,
                  predictors <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.varimp.html">h2o.varimp</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">finalModel</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">==</span> <span class="st">"scaled_importance"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Overall"</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">Overall</span><span class="op">)</span>,<span class="op">]</span>   
                    <span class="va">out</span><span class="op">$</span><span class="va">names</span>
                  <span class="op">}</span>,
                  varImp <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.varimp.html">h2o.varimp</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">finalModel</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">==</span> <span class="st">"scaled_importance"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Overall"</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">names</span>
                  <span class="co">#  out &lt;- out[!is.na(out$Overall), c("Overall"), drop = FALSE]   </span>
                  <span class="co">#  all_var &lt;- object$finalModel@allparameters$x</span>
                 <span class="co">#   if(any(!(all_var %in% rownames(out)))) {</span>
                 <span class="co">#     missing &lt;- all_var[!(all_var %in% rownames(out))]</span>
                  <span class="co">#    tmp &lt;- data.frame(OVerall = rep(0, length(missing)))</span>
                 <span class="co">#     rownames(tmp) &lt;- missing</span>
                   <span class="co">#   out &lt;- rbind(out, tmp)</span>
                   <span class="co"># }</span>
                    <span class="va">out</span>
                  <span class="op">}</span>,
                  levels <span class="op">=</span> <span class="cn">NULL</span>,
                  tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Deep Learning"</span>, <span class="st">"MLP"</span>, 
                           <span class="st">"L2 Regularization"</span>, <span class="st">"learning rate"</span>,
                           <span class="st">"neural network regression"</span><span class="op">)</span>,
                  sort <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">x</span><span class="op">$</span><span class="va">units1</span>, <span class="va">x</span><span class="op">$</span><span class="va">units2</span><span class="op">)</span>,<span class="op">]</span>,
                  trim <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>


<span class="va">econtrol1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span><span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"adaptive_cv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">999</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>warn<span class="op">=</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="va">model_h2o_mlp</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>,<span class="va">env</span><span class="op">$</span><span class="va">envir1</span>,
                                  method<span class="op">=</span><span class="va">DL_h2o</span>,
                                  metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                                  tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### 11 tunable parameters 11^2</span>
                                  <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
                                  trControl <span class="op">=</span> <span class="va">econtrol1</span><span class="op">)</span>

<span class="co">#### There is a model specific varIMP for this model</span>
<span class="fu"><a href="../reference/varImp.html">varImp</a></span><span class="op">(</span><span class="va">model_h2o_mlp</span>,scale <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.varimp.html">h2o.varimp</a></span><span class="op">(</span><span class="va">model_h2o_mlp</span><span class="op">$</span><span class="va">finalModel</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">==</span> <span class="st">"scaled_importance"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Overall"</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">names</span>

<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"example_tutorial_Data.RData"</span><span class="op">)</span></pre></div>
</div>
<div id="kerastensorflow-cnn-example" class="section level3">
<h3 class="hasAnchor">
<a href="#kerastensorflow-cnn-example" class="anchor"></a>keras/tensorflow CNN example</h3>
<div class="sourceCode"><pre class="downlit">
<span class="co">############### CNN model</span>


<span class="co">###CNNsgd</span>

<span class="va">CNN_sgd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>label <span class="op">=</span> <span class="st">"Convolutional Neural Network"</span>,
                  library <span class="op">=</span> <span class="st">"keras"</span>,
                  loop <span class="op">=</span> <span class="cn">NULL</span>,
                  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Regression'</span>, <span class="st">"Classification"</span><span class="op">)</span>,
                  parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
                    parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"nFilter"</span>,<span class="st">"nStride"</span>,<span class="st">'lambda'</span>, <span class="st">"units1"</span>,<span class="st">"units2"</span>,<span class="st">"dropout"</span>,
                                  <span class="st">"activation1"</span>,<span class="st">"activation2"</span>,<span class="st">"activation3"</span><span class="op">)</span>,
                    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">'numeric'</span>, <span class="fl">6</span><span class="op">)</span>, <span class="st">"character"</span>,<span class="st">"character"</span>,<span class="st">"character"</span><span class="op">)</span>,
                    label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"no. of convolutions"</span>,<span class="st">"stride between convolutions"</span>,<span class="st">'L2 Regularization'</span>, <span class="st">"hidden_neurons1"</span>,<span class="st">"hidden_neurons2"</span>,
                              <span class="st">"drop_out_rates"</span>,<span class="st">"Activation Function convol layer"</span>,<span class="st">"Activation function dense hidden layer"</span>,<span class="st">"Activation function layer to output"</span><span class="op">)</span>
                  <span class="op">)</span>,
                  
                  grid <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">len</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">search</span> <span class="op">=</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">afuncs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sigmoid"</span>, <span class="st">"relu"</span>, <span class="st">"tanh"</span>,<span class="st">"linear"</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="va">search</span> <span class="op">==</span> <span class="st">"grid"</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>nFilter<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span>,nStride<span class="op">=</span><span class="fl">3</span>,
                                         lambda <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span> <span class="op">^</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">4</span>, length <span class="op">=</span> <span class="va">len</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,  units1 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, units2 <span class="op">=</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, dropout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.5</span>, length <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                         activation1 <span class="op">=</span> <span class="st">"relu"</span>,activation2<span class="op">=</span><span class="st">"sigmoid"</span>,activation3<span class="op">=</span><span class="st">"linear"</span>
                      <span class="op">)</span>
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                      <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>nFilter<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">10</span><span class="op">:</span><span class="fl">500</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,nStride<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">20</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                        lambda <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, min <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">)</span>,units1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="va">n</span><span class="op">*</span><span class="fl">2</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,units2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">n</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, size <span class="op">=</span> <span class="va">len</span><span class="op">)</span>,
                                        dropout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">len</span>, max <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>,activation1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>,  size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,activation2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>,  size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, activation3 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span><span class="op">(</span><span class="va">afuncs</span>,  size <span class="op">=</span> <span class="va">len</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
                    <span class="op">}</span>
                    <span class="va">out</span>
                  <span class="op">}</span>,
                  
                  fit <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">wts</span>, <span class="va">last</span>,<span class="va">lev</span>,<span class="va">param</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
                    <span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="http://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
                    <span class="va">K</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/backend.html">backend</a></span><span class="op">(</span><span class="op">)</span>
                    <span class="va">K</span><span class="op">$</span><span class="fu">clear_session</span><span class="op">(</span><span class="op">)</span>
                    <span class="co"># if(!is.matrix(x)) x &lt;- as.matrix(x)</span>
                    <span class="co">########## ### here should reshape the data################################# Note: the key step feed to the cnn</span>
                    <span class="va">x</span><span class="op">=</span><span class="fu">kerasR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kerasR/man/expand_dims.html">expand_dims</a></span><span class="op">(</span><span class="va">x</span>,axis<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
                    <span class="co">################  ###### also this define the shape of the tensor######  argument: input_shape    input_shape = c(nSNP,1)          </span>
                    <span class="va">nSNP</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
                    <span class="va">model</span><span class="op">&lt;-</span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
                      <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_conv_1d.html">layer_conv_1d</a></span><span class="op">(</span>filters <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">nFilter</span>, kernel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>, strides<span class="op">=</span><span class="va">param</span><span class="op">$</span><span class="va">nStride</span>,activation <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation1</span><span class="op">)</span>,
                                           input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">nSNP</span>,<span class="fl">1</span><span class="op">)</span>,kernel_regularizer <span class="op">=</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l2</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
                      <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_max_pooling_1d.html">layer_max_pooling_1d</a></span><span class="op">(</span>pool_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># add pooling layer: takes maximum of two consecutive values</span>
                      <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_flatten.html">layer_flatten</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
                      <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dropout.html">layer_dropout</a></span><span class="op">(</span>rate<span class="op">=</span><span class="va">param</span><span class="op">$</span><span class="va">dropout</span><span class="op">)</span> <span class="op">%&gt;%</span>
                      <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">units1</span>, activation <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
                      <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">units2</span>, activation <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">activation3</span><span class="op">)</span><span class="op">)</span>
                    
                    
                    <span class="co">#                    model&lt;-keras::keras_model_sequential() %&gt;%</span>
                    <span class="co">#                      layer_conv_1d(filters = param$nFilter, kernel_size = c(3), strides=param$nStride,activation =as.character(param$activation1),</span>
                    <span class="co">#                                    input_shape = c(1000,1),kernel_regularizer = keras::regularizer_l2(param$lambda)) %&gt;%</span>
                    <span class="co">#                      layer_max_pooling_1d(pool_size = c( 2)) %&gt;% # add pooling layer: takes maximum of two consecutive values</span>
                    <span class="co">#                      layer_flatten() %&gt;%</span>
                    <span class="co">#                      layer_dropout(rate=param$dropout) %&gt;%</span>
                    <span class="co">#                      layer_dense(units = param$units1, activation =as.character(param$activation2)) %&gt;%</span>
                    <span class="co">#                      layer_dense(units = param$units2, activation =as.character(param$activation3))%&gt;% #### activation function of last layer</span>
                    <span class="co">#                      layer_dense(units = 1) ### this should be the same as the input shape: input_shape = c(nSNP,1)</span>
                    <span class="co">#more complex model</span>
                    <span class="co">#  model&lt;-keras::keras_model_sequential() %&gt;%</span>
                    <span class="co">#    keras::layer_conv_1d(filters=128, kernel_size = 3, strides=3,activation =as.character(param$activation1),</span>
                    <span class="co">#                  input_shape = c(nSNPs, 1),kernel_regularizer = keras::regularizer_l2(param$lambda)) %&gt;%</span>
                    <span class="co">#    layer_max_pooling_1d(pool_size = 2) %&gt;%</span>
                    <span class="co">#    layer_conv_1d(filters = 64, kernel_size =3, activation = as.character(param$activation1)) %&gt;%</span>
                    <span class="co">#    layer_flatten() %&gt;%</span>
                    <span class="co">#    layer_dropout(rate=param$dropout) %&gt;%</span>
                    <span class="co">#    layer_dense(units =param$units, activation = as.character(param$activation2))</span>
                    <span class="co">#Compile the model. Note that this linked above %&gt;% </span>
                    <span class="co">#   model%&gt;% compile(</span>
                    <span class="co">#     optimizer='sgd',</span>
                    <span class="co">#     loss='mean_squared_error',</span>
                    <span class="co">#     metrics='mean_squared_error')</span>
                    
                    
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/is.factor.html">is.factor</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/dummyVars.html">class2ind</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
                      <span class="va">model</span> <span class="op">%&gt;%</span> 
                        <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co">#### activation function of last layer</span>
                        <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/generics/man/compile.html">compile</a></span><span class="op">(</span>
                          loss <span class="op">=</span> <span class="st">"categorical_crossentropy"</span>,
                          optimizer <span class="op">=</span> <span class="st">"sgd"</span>,
                          metrics <span class="op">=</span> <span class="st">"accuracy"</span>
                        <span class="op">)</span>
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                      <span class="va">model</span> <span class="op">%&gt;%</span>
                        <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#### activation function of last layer</span>
                        <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/generics/man/compile.html">compile</a></span><span class="op">(</span>
                          loss <span class="op">=</span> <span class="st">"mean_squared_error"</span>,
                          optimizer <span class="op">=</span> <span class="st">"sgd"</span>,
                          metrics <span class="op">=</span> <span class="st">"mean_squared_error"</span>
                        <span class="op">)</span>
                    <span class="op">}</span>
                    
                    <span class="va">model</span> <span class="op">%&gt;%</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/generics/man/fit.html">fit</a></span><span class="op">(</span>
                      x <span class="op">=</span> <span class="va">x</span>, 
                      y <span class="op">=</span> <span class="va">y</span>,
                      kernel_regularizer <span class="op">=</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/regularizer_l1.html">regularizer_l2</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">lambda</span><span class="op">)</span>,
                      <span class="va">...</span>
                    <span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="va">last</span><span class="op">)</span>
                      <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/serialize_model.html">serialize_model</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">model</span><span class="op">)</span>
                  <span class="op">}</span>,
                  predict <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">modelFit</span>, <span class="st">"raw"</span><span class="op">)</span><span class="op">)</span>
                      <span class="va">modelFit</span><span class="op">$</span><span class="va">object</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/serialize_model.html">unserialize_model</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">)</span>
                    <span class="co"># if(!is.matrix(newdata)) </span>
                    <span class="co"># newdata &lt;- as.matrix(newdata)</span>
                    <span class="va">newdata</span><span class="op">=</span><span class="fu">kerasR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kerasR/man/expand_dims.html">expand_dims</a></span><span class="op">(</span><span class="va">newdata</span>,axis<span class="op">=</span><span class="fl">2</span><span class="op">)</span> 
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/predict_on_batch.html">predict_on_batch</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">object</span>, <span class="va">newdata</span><span class="op">)</span>
                    <span class="co">## check for model type</span>
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>
                    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">modelFit</span><span class="op">$</span><span class="va">obsLevels</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">out</span>, <span class="fl">1</span>, <span class="va">which.max</span><span class="op">)</span><span class="op">]</span>
                    <span class="op">}</span>
                    <span class="va">out</span>
                  <span class="op">}</span>,
                  prob <span class="op">=</span>  <span class="kw">function</span><span class="op">(</span><span class="va">modelFit</span>, <span class="va">newdata</span>, <span class="va">submodels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">modelFit</span>, <span class="st">"raw"</span><span class="op">)</span><span class="op">)</span>
                      <span class="va">modelFit</span><span class="op">$</span><span class="va">object</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/serialize_model.html">unserialize_model</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">)</span>
                    <span class="co"># if(!is.matrix(newdata)) </span>
                    <span class="co">#newdata &lt;- as.matrix(newdata)</span>
                    <span class="va">newdata</span><span class="op">=</span><span class="fu">kerasR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/kerasR/man/expand_dims.html">expand_dims</a></span><span class="op">(</span><span class="va">newdata</span>,axis<span class="op">=</span><span class="fl">2</span><span class="op">)</span> 
                    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/predict_on_batch.html">predict_on_batch</a></span><span class="op">(</span><span class="va">modelFit</span><span class="op">$</span><span class="va">object</span>, <span class="va">newdata</span><span class="op">)</span>
                    <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">modelFit</span><span class="op">$</span><span class="va">obsLevels</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">out</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                  <span class="op">}</span>,
                  varImp <span class="op">=</span> <span class="cn">NULL</span>,<span class="co">### CNN importance will estimate separately</span>
                  tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">" CNN"</span>, <span class="st">"L2 Regularization"</span><span class="op">)</span>,
                  sort <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">nFilter</span>, <span class="op">-</span><span class="va">x</span><span class="op">$</span><span class="va">lambda</span><span class="op">)</span>,<span class="op">]</span>,
                  notes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"After `train` completes, the keras model object is serialized"</span>,
                                <span class="st">"so that it can be used between R session. When predicting, the"</span>, 
                                <span class="st">"code will temporarily unsearalize the object. To make the"</span>, 
                                <span class="st">"predictions more efficient, the user might want to use "</span>, 
                                <span class="st">"`keras::unsearlize_model(object$finalModel$object)` in the current"</span>, 
                                <span class="st">"R session so that that operation is only done once."</span>,
                                <span class="st">"Also, this model cannot be run in parallel due to"</span>,
                                <span class="st">"the nature of how tensorflow does the computations."</span>,
                                
                                <span class="st">"Unlike other packages used by `train`, the `dplyr`"</span>,
                                <span class="st">"package is fully loaded when this model is used."</span><span class="op">)</span>,
                  check <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">pkg</span><span class="op">)</span> <span class="op">{</span>
                    <span class="va">testmod</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span>,
                                   silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">testmod</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span>
                      <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Could not start a sequential model. "</span>,
                           <span class="st">"`tensorflow` might not be installed. "</span>,
                           <span class="st">"See `?install_tensorflow`."</span>, 
                           call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
                    <span class="cn">TRUE</span>
                  <span class="op">}</span><span class="op">)</span>


<span class="va">econtrol1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span><span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"repeatedcv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>
<span class="va">genotype_norm</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/apply.html">apply</a></span><span class="op">(</span><span class="va">genotype</span>,<span class="fl">2</span>,<span class="va">normalize</span><span class="op">)</span><span class="op">)</span>
<span class="va">model_Keras_CNN</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="va">genotype_norm</span>,<span class="va">env</span><span class="op">$</span><span class="va">envir1</span>,
                                 method<span class="op">=</span><span class="va">CNNsgd</span>,
                                 metric <span class="op">=</span> <span class="st">"MAE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared"</span>
                                 tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### 11 tunable parameters 11^2</span>
                                 <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
                                 verbose<span class="op">=</span><span class="fl">0</span>,<span class="co"># verbose=1 is reporting the progress,o is sclience</span>
                                 trControl <span class="op">=</span> <span class="va">econtrol1</span>,importance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co">####permutation varimp importance </span>

<span class="va">optmodel</span><span class="op">=</span><span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/serialize_model.html">unserialize_model</a></span><span class="op">(</span><span class="va">model_Keras_CNN</span><span class="op">$</span><span class="va">finalModel</span><span class="op">$</span><span class="va">object</span><span class="op">)</span>
<span class="va">optmodel</span>
<span class="va">pred</span> <span class="op">=</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/predict_on_batch.html">predict_on_batch</a></span><span class="op">(</span><span class="va">optmodel</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">feature_names</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">genotype</span><span class="op">)</span>


<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">doParallel</span><span class="op">)</span>
<span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">makePSOCKcluster</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>
<span class="va">Tensor_sim_imp_cnn</span><span class="op">=</span><span class="fu"><a href="../reference/CNN_varIMP_permute.html">CNN_varIMP_permute</a></span><span class="op">(</span><span class="va">optmodel</span>,
                                  <span class="va">feature_names</span>,
                                  train_y<span class="op">=</span><span class="va">env</span><span class="op">$</span><span class="va">envir1</span>,
                                  train_x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>,
                                  <span class="co">#smaller_is_better = FALSE,</span>
                                  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"difference"</span>, <span class="st">"ratio"</span><span class="op">)</span>,
                                  nsim <span class="op">=</span> <span class="fl">10</span>,<span class="co">## MCMC permutation large numbers need much more time</span>
                                  sample_size <span class="op">=</span> <span class="cn">NULL</span>,
                                  sample_frac <span class="op">=</span> <span class="cn">NULL</span>,
                                  verbose <span class="op">=</span> <span class="cn">FALSE</span>,
                                  progress <span class="op">=</span> <span class="st">"none"</span>,
                                  parallel <span class="op">=</span> <span class="cn">TRUE</span>,
                                  paropts <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>


<span class="va">Tensor_sim_imp_NULL_cnn</span><span class="op">=</span><span class="fu"><a href="../reference/CNN_varIMP_NULL_model.html">CNN_varIMP_NULL_model</a></span><span class="op">(</span><span class="va">optmodel</span>,
                                          <span class="va">feature_names</span>,
                                          train_y<span class="op">=</span><span class="va">env</span><span class="op">$</span><span class="va">envir1</span>,
                                          train_x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>,
                                          <span class="co">#smaller_is_better = FALSE,</span>
                                          type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"difference"</span>, <span class="st">"ratio"</span><span class="op">)</span>,
                                          nsim <span class="op">=</span> <span class="fl">10</span>,<span class="co">## MCMC permutation large numbers need much more time</span>
                                          sample_size <span class="op">=</span> <span class="cn">NULL</span>,
                                          sample_frac <span class="op">=</span> <span class="cn">NULL</span>,
                                          verbose <span class="op">=</span> <span class="cn">FALSE</span>,
                                          progress <span class="op">=</span> <span class="st">"none"</span>,
                                          parallel <span class="op">=</span> <span class="cn">TRUE</span>,
                                          paropts <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>
<span class="fu">registerDoSEQ</span><span class="op">(</span><span class="op">)</span>
<span class="fu">stopCluster</span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>

<span class="va">VarImps_permcnn</span><span class="op">=</span><span class="va">Tensor_sim_imp_cnn</span><span class="op">$</span><span class="va">CNN_Decrease_acc</span>
<span class="va">VarImps_nullcnn</span><span class="op">=</span><span class="va">Tensor_sim_imp_NULL_cnn</span><span class="op">$</span><span class="va">CNN_Decrease_acc</span>

<span class="fu"><a href="https://rdrr.io/r/base/save.html">save.image</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"CNN_Sim1_env1_test.RData"</span><span class="op">)</span></pre></div>
<p>We demonstrated how to construct, compile and implement deep learing based genome scan step by step using different libraries. These models are also ready-to-use in our DeepGenomeScan framework. Users just need to change “method” names to choose the corresponding model. The models available can be found in our documentation and “DeepGenomeScan Models” section.</p>
</div>
<div id="using-deepgenomescan-available-models" class="section level3">
<h3 class="hasAnchor">
<a href="#using-deepgenomescan-available-models" class="anchor"></a>Using DeepGenomeScan available models</h3>
<div class="sourceCode"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bips-hb/neuralnet">neuralnet</a></span><span class="op">)</span>
<span class="co">## using other models in the package</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"neuraldat"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/">caret</a></span><span class="op">)</span>
<span class="va">econtrol1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html">trainControl</a></span><span class="op">(</span><span class="co">## 5-fold CV, repeat 5 times</span>
  method <span class="op">=</span> <span class="st">"adaptive_cv"</span>,
  number <span class="op">=</span> <span class="fl">5</span>,
  <span class="co">## repeated ten times</span>
  repeats <span class="op">=</span> <span class="fl">5</span>,search <span class="op">=</span> <span class="st">"random"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">999</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>warn<span class="op">=</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="va">genotype_norm</span>,<span class="va">env</span><span class="op">$</span><span class="va">envir1</span>,, method <span class="op">=</span> <span class="st">'mlpWeightDecayML'</span>, data <span class="op">=</span> <span class="va">neuraldat</span>, linout <span class="op">=</span> <span class="cn">TRUE</span>,metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
             tuneLength <span class="op">=</span> <span class="fl">20</span>, <span class="co">### 11 tunable parameters 11^2</span>
             <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
             verbose<span class="op">=</span><span class="fl">0</span>,<span class="co"># verbose=1 is reporting the progress,o is sclience</span>
             trControl <span class="op">=</span> <span class="va">econtrol1</span>,importance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="fu"><a href="../reference/varImp.html">varImp</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>
<span class="va">simf</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sim_example</span><span class="op">[</span>,<span class="fl">15</span><span class="op">:</span><span class="fl">1014</span><span class="op">]</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">"~"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">mod1</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="va">simf</span>,data<span class="op">=</span><span class="va">sim_example</span>, method <span class="op">=</span> <span class="st">'neuralnet'</span>, linout <span class="op">=</span> <span class="cn">TRUE</span>,metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                    tuneLength <span class="op">=</span> <span class="fl">20</span>, <span class="co">### 11 tunable parameters 11^2</span>
                    <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
                    verbose<span class="op">=</span><span class="fl">0</span>,<span class="co"># verbose=1 is reporting the progress,o is sclience</span>
                    trControl <span class="op">=</span> <span class="va">econtrol1</span>,importance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>


<span class="fu"><a href="../reference/varImp.html">varImp</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span>

<span class="va">simf</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sim_example</span><span class="op">[</span>,<span class="fl">15</span><span class="op">:</span><span class="fl">1014</span><span class="op">]</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span>,sep<span class="op">=</span><span class="st">"~"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">mod2</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="va">simf</span>,data<span class="op">=</span><span class="va">sim_example</span>, method <span class="op">=</span> <span class="st">'mlpneuralnet'</span>,  linout <span class="op">=</span> <span class="cn">TRUE</span>,metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                    tuneLength <span class="op">=</span> <span class="fl">20</span>, <span class="co">### 11 tunable parameters 11^2</span>
                    <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
                    verbose<span class="op">=</span><span class="fl">0</span>,<span class="co"># verbose=1 is reporting the progress,o is sclience</span>
                    trControl <span class="op">=</span> <span class="va">econtrol1</span>,importance <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>


<span class="fu"><a href="../reference/varImp.html">varImp</a></span><span class="op">(</span><span class="va">mod2</span><span class="op">)</span>



<span class="va">h2o_mlp</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/DeepGenomeScan.html">DeepGenomeScan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">genotype_norm</span><span class="op">)</span>,<span class="va">env</span><span class="op">$</span><span class="va">envir1</span>,
                                  method<span class="op">=</span><span class="st">"mlph2o"</span>,
                                  metric <span class="op">=</span> <span class="st">"RMSE"</span>,<span class="co">## "Accuracy", "RMSE","Rsquared","MAE"</span>
                                  tuneLength <span class="op">=</span> <span class="fl">10</span>, <span class="co">### 11 tunable parameters 11^2</span>
                                  <span class="co"># tuneGrid=CNNGrid, ### or search 100 combinations of parameters using random tuneLength=100</span>
                                  trControl <span class="op">=</span> <span class="va">econtrol1</span><span class="op">)</span>

<span class="co">#### There is a model specific varIMP for this model</span>
<span class="fu"><a href="../reference/varImp.html">varImp</a></span><span class="op">(</span><span class="va">h2o_mlp</span>,scale <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">h2o</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/h2o.varimp.html">h2o.varimp</a></span><span class="op">(</span><span class="va">h2o_mlp</span><span class="op">$</span><span class="va">finalModel</span><span class="op">)</span>, stringsAsFactors <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/h2o/man/colnames.html">colnames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">==</span> <span class="st">"scaled_importance"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Overall"</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">names</span></pre></div>
<p>We highly recommend users following our tutorial step-by-step to construct their own models and implement the DeepGenomeScan based on your computational demand.</p>
<p>Welcome any <a href="https://github.com/xinghuq/DeepGenomeScan/issues">feedback</a> and <a href="https://github.com/xinghuq/DeepGenomeScan/pulls">pull request</a>.</p>
<div id="references" class="section level4">
<h4 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h4>
<p>Abadi, M., Barham, P., Chen, J., Chen, Z., Davis, A., Dean, J., … &amp; Kudlur, M. (2016). Tensorflow: A system for large-scale machine learning. In 12th {USENIX} symposium on operating systems design and implementation ({OSDI} 16) (pp. 265-283).</p>
<p>Bergmeir, C. N., &amp; Benítez Sánchez, J. M. (2012). Neural networks in R using the Stuttgart neural network simulator: RSNNS. American Statistical Association.</p>
<p>Beck, M. W. (2018). NeuralNetTools: Visualization and analysis tools for neural networks. Journal of statistical software, 85(11), 1.</p>
<p>Candel, A., Parmar, V., LeDell, E., &amp; Arora, A. (2016). Deep learning with H2O. H2O. ai Inc.</p>
<p>Deane-Mayer, Z. A., &amp; Knowles, J. E. (2016). caretEnsemble: ensembles of caret models. R package version, 2(0).</p>
<p>Gulli, A., &amp; Pal, S. (2017). Deep learning with Keras. Packt Publishing Ltd.</p>
<p>Klima, G. (2016). FCNN4R: Fast Compressed Neural Networks for R. R package version 0.6, 2.</p>
<p>Kuhn, M. (2015). Caret: classification and regression training. ascl, ascl-1505.</p>
<p>Qin, X. 2020. DeepGenomeScan. v0.5.5.</p>
<p>Qin, X., Gaggiotti, EO., Chiang, C. 2020. Detecting natural selection via deep learning. In submission.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Xinghu Qin.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
